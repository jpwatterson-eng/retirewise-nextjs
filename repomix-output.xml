This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
docs/
  API_REFERENCE.md
  ARCHITECTURE.md
  CONTRIBUTING.md
  DATABASE.md
  DEPLOYMENT.md
public/
  icons/
    16.png
    20.png
    icon-1024x1024.png
    icon-128x128.png
    icon-144x144.png
    icon-152x152.png
    icon-192x192.png
    icon-256x256.png
    icon-32x32.png
    icon-512x512.png
    icon-64x64.png
    icon-72x72.png
  apple-touch-icon.png
  file.svg
  globe.svg
  manifest.json
  next.svg
  vercel.svg
  window.svg
src/
  app/
    advisor/
      page.js
    analytics/
      page.js
    api/
      chat/
        route.js
    chat/
      page.js
    dashboard/
      page.jsx
    insights/
      page.js
    journal/
      page.js
    portfolio/
      page.js
    projects/
      [id]/
        page.js
      page.js
    quick-log/
      page.tsx
    settings/
      page.js
    test-migration/
      page.js
    timelogs/
      page.js
    favicon.ico
    globals.css
    layout.js
    page.js
  components/
    Auth/
      AuthScreen.js
    AIChat.js
    Analytics.js
    AppLayout.js
    AppSettings.js
    BalanceChart.js
    BalanceComparison.js
    HomeScreen.js
    InsightsPanel.js
    InstallPrompt.tsx
    JournalEntryForm.js
    JournalList.js
    MobileNav.tsx
    PerspectiveAnalytics.js
    PerspectiveCard.js
    PortfolioDashboard.js
    ProjectDetails.js
    ProjectForm.js
    ProjectsListView.js
    QuickTimeLog.js
    RecentActivityByPerspective.js
    TimeLogForm.js
    TimeLogsView.js
    UserInitializer.js
  config/
    firebase.js
  contexts/
    AuthContext.js
  db/
    firestore/
      firestoreDB.js
    unifiedDB.js
  hooks/
    usePortfolioContext.js
  lib/
    ai-prompt-generator.js
    appRegistry.ts
    balance-calculator.js
    offLineQueue.ts
  services/
    aiService.js
  types/
    app-registry.ts
  utils/
    migrateProjects.js
    perspectiveHelpers.js
.gitignore
eslint.config.mjs
jsconfig.json
next.config.js
next.config.mjs
package.json
postcss.config.js
postcss.config.mjs
README.md
tailwind.config.js
tsconfig.json
vercel.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/app/quick-log/page.tsx">
// app/quick-log/page.tsx
"use client";

import { useState, useEffect } from "react";
import { useAuth } from "@/contexts/AuthContext.js";
import { db } from "@/config/firebase.js";
import {
  collection,
  addDoc,
  query,
  getDocs,
  orderBy,
  limit,
} from "firebase/firestore";

const PERSPECTIVES = [
  { id: "enjoy", label: "Enjoy", icon: "ğŸ¨", color: "bg-purple-500" },
  { id: "learn", label: "Learn", icon: "ğŸ“š", color: "bg-blue-500" },
  { id: "earn", label: "Earn", icon: "ğŸ’°", color: "bg-green-500" },
  { id: "contribute", label: "Contribute", icon: "ğŸ¤", color: "bg-orange-500" },
];

const QUICK_DURATIONS = [
  { label: "15m", minutes: 15 },
  { label: "30m", minutes: 30 },
  { label: "1h", minutes: 60 },
  { label: "2h", minutes: 120 },
  { label: "Custom", minutes: null },
];

type Perspective = "enjoy" | "learn" | "earn" | "contribute";

export default function QuickLogPage() {
  const { user } = useAuth();
  const [perspective, setPerspective] = useState<Perspective | null>(null);
  const [project, setProject] = useState<string>("");
  const [duration, setDuration] = useState<number>(60);
  const [customDuration, setCustomDuration] = useState<string>("");
  const [note, setNote] = useState<string>("");
  const [recentProjects, setRecentProjects] = useState<string[]>([]);
  const [isLogging, setIsLogging] = useState<boolean>(false);
  const [showSuccess, setShowSuccess] = useState<boolean>(false);

  // Load recent projects
  useEffect(() => {
    if (!user) return;

    const loadRecentProjects = async () => {
      try {
        const timeLogsRef = collection(db, `users/${user.uid}/timeLogs`);
        const q = query(timeLogsRef, orderBy("timestamp", "desc"), limit(10));

        const snapshot = await getDocs(q);
        const projects = new Set<string>();
        snapshot.docs.forEach((doc) => {
          const projectName = doc.data().project;
          if (projectName) projects.add(projectName);
        });

        setRecentProjects(Array.from(projects).slice(0, 5));
      } catch (error) {
        console.error("Error loading recent projects:", error);
      }
    };

    loadRecentProjects();
  }, [user]);

  const handleLog = async () => {
    if (!user || !perspective || !project) return;

    setIsLogging(true);

    try {
      const timeLogsRef = collection(db, `users/${user.uid}/timeLogs`);
      await addDoc(timeLogsRef, {
        perspective,
        project,
        duration,
        note: note || null,
        timestamp: new Date().toISOString(),
        createdAt: new Date().toISOString(),
        source: "quick-log",
        appId: "retirewise", // Add this for multi-app support
      });

      // Show success animation
      setShowSuccess(true);

      // Reset form after brief delay
      setTimeout(() => {
        setPerspective(null);
        setProject("");
        setDuration(60);
        setCustomDuration("");
        setNote("");
        setShowSuccess(false);
      }, 1500);
    } catch (error) {
      console.error("Error logging time:", error);
      alert("Failed to log time. Please try again.");
    } finally {
      setIsLogging(false);
    }
  };

  const handleCustomDuration = (value: string) => {
    setCustomDuration(value);
    const parsed = parseInt(value);
    setDuration(isNaN(parsed) ? 0 : parsed);
  };

  const canSubmit = perspective && project && duration > 0;

  if (showSuccess) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-green-50">
        <div className="text-center">
          <div className="text-6xl mb-4">âœ“</div>
          <h2 className="text-2xl font-bold text-green-700">Logged!</h2>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      {/* Header */}
      <div className="bg-white border-b px-4 py-4 sticky top-0 z-10">
        <h1 className="text-xl font-bold">Quick Log</h1>
        <p className="text-sm text-gray-600">What did you just do?</p>
      </div>

      <div className="p-4 space-y-6">
        {/* Perspective Selection */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-3">
            Perspective
          </label>
          <div className="grid grid-cols-2 gap-3">
            {PERSPECTIVES.map((p) => (
              <button
                key={p.id}
                onClick={() => setPerspective(p.id as Perspective)}
                className={`
                  p-4 rounded-xl border-2 transition-all
                  ${
                    perspective === p.id
                      ? `${p.color} border-transparent text-white scale-105`
                      : "bg-white border-gray-200 text-gray-700"
                  }
                `}
              >
                <div className="text-3xl mb-1">{p.icon}</div>
                <div className="font-semibold">{p.label}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Project */}
        {perspective && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Project
            </label>
            {recentProjects.length > 0 && !project && (
              <div className="mb-3">
                <p className="text-xs text-gray-500 mb-2">Recent:</p>
                <div className="flex flex-wrap gap-2">
                  {recentProjects.map((p) => (
                    <button
                      key={p}
                      onClick={() => setProject(p)}
                      className="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium"
                    >
                      {p}
                    </button>
                  ))}
                </div>
              </div>
            )}
            <input
              type="text"
              value={project}
              onChange={(e) => setProject(e.target.value)}
              placeholder="Enter project name..."
              className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg"
              autoFocus={!recentProjects.length}
            />
          </div>
        )}

        {/* Duration */}
        {project && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Duration
            </label>
            <div className="grid grid-cols-5 gap-2 mb-2">
              {QUICK_DURATIONS.map((d) => (
                <button
                  key={d.label}
                  onClick={() => {
                    if (d.minutes) {
                      setDuration(d.minutes);
                      setCustomDuration("");
                    } else {
                      setCustomDuration("");
                    }
                  }}
                  className={`
                    py-3 rounded-lg border-2 font-semibold transition-all text-sm
                    ${
                      duration === d.minutes && d.minutes
                        ? "bg-blue-600 border-blue-600 text-white"
                        : "bg-white border-gray-200 text-gray-700"
                    }
                  `}
                >
                  {d.label}
                </button>
              ))}
            </div>
            {(customDuration ||
              !QUICK_DURATIONS.slice(0, -1).some(
                (d) => d.minutes === duration
              )) && (
              <input
                type="number"
                value={customDuration}
                onChange={(e) => handleCustomDuration(e.target.value)}
                placeholder="Custom minutes..."
                className="w-full px-4 py-3 border border-gray-300 rounded-lg"
              />
            )}
          </div>
        )}

        {/* Optional Note */}
        {duration > 0 && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Quick Note (Optional)
            </label>
            <textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              placeholder="Any quick thoughts?"
              rows={3}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none"
            />
          </div>
        )}
      </div>

      {/* Fixed Bottom Button */}
      <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t">
        <button
          onClick={handleLog}
          disabled={!canSubmit || isLogging}
          className={`
            w-full py-4 rounded-xl font-bold text-lg transition-all
            ${
              canSubmit && !isLogging
                ? "bg-blue-600 text-white active:scale-95"
                : "bg-gray-200 text-gray-400"
            }
          `}
        >
          {isLogging ? "Logging..." : "Log It âœ“"}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/InstallPrompt.tsx">
// components/InstallPrompt.tsx
"use client";

import { useState, useEffect } from "react";

export function InstallPrompt() {
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);
  const [showPrompt, setShowPrompt] = useState(false);

  useEffect(() => {
    const handler = (e: Event) => {
      e.preventDefault();
      setDeferredPrompt(e);

      // Show prompt if not installed and user has visited 2+ times
      const visits = parseInt(localStorage.getItem("visitCount") || "0");
      if (visits >= 2) {
        setShowPrompt(true);
      }
    };

    window.addEventListener("beforeinstallprompt", handler);

    // Track visits
    const visits = parseInt(localStorage.getItem("visitCount") || "0");
    localStorage.setItem("visitCount", (visits + 1).toString());

    return () => window.removeEventListener("beforeinstallprompt", handler);
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;

    if (outcome === "accepted") {
      setDeferredPrompt(null);
      setShowPrompt(false);
    }
  };

  if (!showPrompt) return null;

  return (
    <div className="fixed bottom-20 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-xl z-50">
      <div className="flex items-start gap-3">
        <span className="text-2xl">ğŸ“±</span>
        <div className="flex-1">
          <h3 className="font-semibold mb-1">Install RetireWise</h3>
          <p className="text-sm opacity-90">
            Add to your home screen for quick access and offline use
          </p>
        </div>
      </div>
      <div className="flex gap-2 mt-3">
        <button
          onClick={handleInstall}
          className="flex-1 bg-white text-blue-600 px-4 py-2 rounded font-medium"
        >
          Install
        </button>
        <button
          onClick={() => setShowPrompt(false)}
          className="px-4 py-2 rounded border border-white/30"
        >
          Not Now
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/MobileNav.tsx">
// components/MobileNav.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
  Home,
  PlusCircle,
  MessageCircle,
  BarChart3,
  Settings,
} from "lucide-react";

const NAV_ITEMS = [
  { href: "/dashboard", icon: Home, label: "Hub" },
  { href: "/quick-log", icon: PlusCircle, label: "Log", highlight: true },
  { href: "/ai-chat", icon: MessageCircle, label: "AI" },
  { href: "/analytics", icon: BarChart3, label: "Stats" },
  { href: "/settings", icon: Settings, label: "Settings" },
];

export function MobileNav() {
  const pathname = usePathname();

  return (
    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
      <div className="flex justify-around items-center h-16">
        {NAV_ITEMS.map((item) => {
          const isActive = pathname === item.href;
          const Icon = item.icon;

          return (
            <Link
              key={item.href}
              href={item.href}
              className={`
                flex flex-col items-center justify-center flex-1 h-full
                ${item.highlight ? "relative" : ""}
              `}
            >
              {item.highlight && (
                <div className="absolute -top-3 bg-blue-600 rounded-full p-3 shadow-lg">
                  <Icon className="w-6 h-6 text-white" />
                </div>
              )}
              {!item.highlight && (
                <>
                  <Icon
                    className={`w-6 h-6 ${
                      isActive ? "text-blue-600" : "text-gray-400"
                    }`}
                  />
                  <span
                    className={`text-xs mt-1 ${
                      isActive ? "text-blue-600 font-medium" : "text-gray-500"
                    }`}
                  >
                    {item.label}
                  </span>
                </>
              )}
            </Link>
          );
        })}
      </div>
    </nav>
  );
}
</file>

<file path="src/lib/appRegistry.ts">
// lib/appRegistry.ts

import { db } from '@/config/firebase';
import { 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  getDocs, 
  query, 
  where 
} from 'firebase/firestore';
import type { 
  App, 
  Integration, 
  CrossAppProject 
} from '@/types/app-registry';

export class AppRegistry {
  constructor(private userId: string) {}

  // ===== APP MANAGEMENT =====

  /**
   * Register a new app in the registry
   */
  async registerApp(
    app: Omit<App, 'id' | 'createdAt' | 'lastActive'>
  ): Promise<App> {
    const appId = app.name.toLowerCase().replace(/\s+/g, '-');
    const appDoc: App = {
      ...app,
      id: appId,
      createdAt: new Date().toISOString(),
      lastActive: new Date().toISOString(),
    };

    await setDoc(doc(db, `users/${this.userId}/apps/${appId}`), appDoc);
    return appDoc;
  }

  /**
   * Get all registered apps
   */
  async getApps(): Promise<App[]> {
    const appsRef = collection(db, `users/${this.userId}/apps`);
    const snapshot = await getDocs(appsRef);
    return snapshot.docs.map(doc => doc.data() as App);
  }

  /**
   * Get a specific app by ID
   */
  async getApp(appId: string): Promise<App | null> {
    const appDoc = await getDoc(
      doc(db, `users/${this.userId}/apps/${appId}`)
    );
    return appDoc.exists() ? (appDoc.data() as App) : null;
  }

  /**
   * Update app status
   */
  async updateAppStatus(
    appId: string, 
    status: 'active' | 'paused' | 'archived'
  ): Promise<void> {
    await setDoc(
      doc(db, `users/${this.userId}/apps/${appId}`),
      { 
        status, 
        lastActive: new Date().toISOString() 
      },
      { merge: true }
    );
  }

  // ===== INTEGRATION MANAGEMENT =====

  /**
   * Connect a new external integration
   */
  async connectIntegration(
    integration: Omit<Integration, 'id'>
  ): Promise<Integration> {
    const integrationId = `${integration.provider}-${Date.now()}`;
    const integrationDoc: Integration = {
      ...integration,
      id: integrationId,
    };

    await setDoc(
      doc(db, `users/${this.userId}/integrations/${integrationId}`),
      integrationDoc
    );
    return integrationDoc;
  }

  /**
   * Get all integrations for a specific app
   */
  async getIntegrations(appId: string): Promise<Integration[]> {
    const integrationsRef = collection(
      db, 
      `users/${this.userId}/integrations`
    );
    const q = query(integrationsRef, where('appId', '==', appId));
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => doc.data() as Integration);
  }

  /**
   * Get a specific integration
   */
  async getIntegration(integrationId: string): Promise<Integration | null> {
    const integrationDoc = await getDoc(
      doc(db, `users/${this.userId}/integrations/${integrationId}`)
    );
    return integrationDoc.exists() 
      ? (integrationDoc.data() as Integration) 
      : null;
  }

  /**
   * Update integration sync configuration
   */
  async updateSyncConfig(
    integrationId: string,
    syncConfig: Partial<Integration['syncConfig']>
  ): Promise<void> {
    await setDoc(
      doc(db, `users/${this.userId}/integrations/${integrationId}`),
      { syncConfig },
      { merge: true }
    );
  }

  /**
   * Disconnect an integration
   */
  async disconnectIntegration(integrationId: string): Promise<void> {
    await setDoc(
      doc(db, `users/${this.userId}/integrations/${integrationId}`),
      { 
        status: 'disconnected',
        syncConfig: { enabled: false }
      },
      { merge: true }
    );
  }

  // ===== PROJECT MANAGEMENT =====

  /**
   * Create a new cross-app project
   */
  async createProject(
    project: Omit<
      CrossAppProject, 
      'id' | 'createdAt' | 'updatedAt' | 'actualBalance' | 'totalTime'
    >
  ): Promise<CrossAppProject> {
    const projectId = crypto.randomUUID();
    const projectDoc: CrossAppProject = {
      ...project,
      id: projectId,
      actualBalance: { enjoy: 0, learn: 0, earn: 0, contribute: 0 },
      totalTime: 0,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    await setDoc(
      doc(db, `users/${this.userId}/projects/${projectId}`),
      projectDoc
    );
    return projectDoc;
  }

  /**
   * Get all active projects
   */
  async getProjects(): Promise<CrossAppProject[]> {
    const projectsRef = collection(db, `users/${this.userId}/projects`);
    const q = query(projectsRef, where('status', '==', 'active'));
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => doc.data() as CrossAppProject);
  }

  /**
   * Get a specific project
   */
  async getProject(projectId: string): Promise<CrossAppProject | null> {
    const projectDoc = await getDoc(
      doc(db, `users/${this.userId}/projects/${projectId}`)
    );
    return projectDoc.exists() 
      ? (projectDoc.data() as CrossAppProject) 
      : null;
  }

  /**
   * Update project balance based on time logs
   */
  async updateProjectBalance(
    projectId: string,
    actualBalance: CrossAppProject['actualBalance'],
    totalTime: number
  ): Promise<void> {
    await setDoc(
      doc(db, `users/${this.userId}/projects/${projectId}`),
      {
        actualBalance,
        totalTime,
        updatedAt: new Date().toISOString(),
      },
      { merge: true }
    );
  }

  /**
   * Update project status
   */
  async updateProjectStatus(
    projectId: string,
    status: 'active' | 'paused' | 'completed'
  ): Promise<void> {
    await setDoc(
      doc(db, `users/${this.userId}/projects/${projectId}`),
      { 
        status, 
        updatedAt: new Date().toISOString() 
      },
      { merge: true }
    );
  }
}
</file>

<file path="src/lib/offLineQueue.ts">
// lib/offlineQueue.ts
type QueuedOperation = {
  id: string;
  type: 'timeLog' | 'journal' | 'update';
  data: any;
  timestamp: string;
  retries: number;
};

class OfflineQueue {
  private queue: QueuedOperation[] = [];
  private processing = false;

  constructor() {
    // Load queue from localStorage on init
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem('offlineQueue');
      if (stored) {
        this.queue = JSON.parse(stored);
      }
    }
  }

  add(operation: Omit<QueuedOperation, 'id' | 'retries'>) {
    const queued: QueuedOperation = {
      ...operation,
      id: crypto.randomUUID(),
      retries: 0,
    };
    
    this.queue.push(queued);
    this.persist();
    
    // Try to process immediately if online
    if (navigator.onLine) {
      this.process();
    }
  }

  private persist() {
    localStorage.setItem('offlineQueue', JSON.stringify(this.queue));
  }

  async process() {
    if (this.processing || !navigator.onLine) return;
    
    this.processing = true;
    
    while (this.queue.length > 0 && navigator.onLine) {
      const operation = this.queue[0];
      
      try {
        await this.executeOperation(operation);
        this.queue.shift(); // Remove on success
        this.persist();
      } catch (error) {
        console.error('Failed to execute operation:', error);
        operation.retries++;
        
        if (operation.retries >= 3) {
          // Give up after 3 retries
          console.error('Max retries reached, removing operation:', operation);
          this.queue.shift();
        }
        
        this.persist();
        break; // Stop processing on error
      }
    }
    
    this.processing = false;
  }

  private async executeOperation(operation: QueuedOperation) {
    switch (operation.type) {
      case 'timeLog':
        const response = await fetch('/api/timeLogs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(operation.data),
        });
        if (!response.ok) throw new Error('Failed to sync time log');
        break;
      
      case 'journal':
        const journalResponse = await fetch('/api/journal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(operation.data),
        });
        if (!journalResponse.ok) throw new Error('Failed to sync journal');
        break;
      
      default:
        throw new Error(`Unknown operation type: ${operation.type}`);
    }
  }

  getQueueSize() {
    return this.queue.length;
  }

  clearQueue() {
    this.queue = [];
    this.persist();
  }
}

export const offlineQueue = new OfflineQueue();

// Listen for online/offline events
if (typeof window !== 'undefined') {
  window.addEventListener('online', () => {
    console.log('Back online, processing queue...');
    offlineQueue.process();
  });
  
  window.addEventListener('offline', () => {
    console.log('Gone offline, queueing operations...');
  });
}
</file>

<file path="src/types/app-registry.ts">
// types/app-registry.ts

export type AppType = 'core' | 'managed' | 'integrated';
export type AppStatus = 'active' | 'paused' | 'archived';
export type IntegrationStatus = 'connected' | 'disconnected' | 'error';
export type ProjectStatus = 'active' | 'paused' | 'completed';
export type Perspective = 'enjoy' | 'learn' | 'earn' | 'contribute';

export interface App {
  id: string;
  name: string;
  type: AppType;
  status: AppStatus;
  icon: string;
  description: string;
  capabilities: string[];
  createdAt: string;
  lastActive: string;
  metadata: {
    version?: string;
    url?: string;
    apiEndpoint?: string;
    syncEnabled?: boolean;
  };
}

export interface Integration {
  id: string;
  appId: string;
  provider: string;
  status: IntegrationStatus;
  credentials: {
    accessToken: string;
    refreshToken: string;
    expiresAt: string;
  };
  permissions: string[];
  syncConfig: {
    enabled: boolean;
    frequency: number;
    lastSync: string;
    nextSync: string;
  };
  dataMapping: {
    eventToPerspective: Record<string, Perspective>;
    defaultPerspective: Perspective;
  };
  stats: {
    itemsSynced: number;
    lastError?: string;
    errorCount: number;
  };
}

export interface CrossAppProject {
  id: string;
  name: string;
  description: string;
  perspective: Perspective;
  apps: string[];
  status: ProjectStatus;
  balance: {
    enjoy: number;
    learn: number;
    earn: number;
    contribute: number;
  };
  actualBalance: {
    enjoy: number;
    learn: number;
    earn: number;
    contribute: number;
  };
  totalTime: number;
  createdAt: string;
  updatedAt: string;
}

export interface TimeLog {
  id: string;
  appId: string;  // NEW: which app this came from
  projectId: string;
  perspective: Perspective;
  duration: number;
  timestamp: string;
  source: 'manual' | 'quick-log' | 'integrated' | 'imported';
  sourceData?: {
    provider: string;
    externalId: string;
    rawData: any;
  };
  note?: string;
}

export interface ExternalEvent {
  id: string;
  integrationId: string;
  title: string;
  startTime: string;
  endTime: string;
  attendees: string[];
  mappedTo: {
    perspective: Perspective;
    project: string;
    timeLogId?: string;
  };
  syncedAt: string;
  rawData: any;
}

export interface Insight {
  id: string;
  type: 'balance' | 'pattern' | 'recommendation' | 'cross-app';
  severity: 'info' | 'warning' | 'critical';
  title: string;
  description: string;
  sources: string[];
  data: any;
  dismissed: boolean;
  createdAt: string;
  expiresAt?: string;
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "target": "ES2017",
    "forceConsistentCasingInFileNames": true
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="docs/API_REFERENCE.md">
# RetireWise API Reference

Complete documentation of all database functions, API routes, and utilities.

---

## Table of Contents

- [Database Functions](#database-functions)
  - [Projects](#projects)
  - [Time Logs](#time-logs)
  - [Journal Entries](#journal-entries)
  - [Insights](#insights)
  - [Conversations](#conversations)
  - [Portfolio](#portfolio)
  - [User Profile](#user-profile)
- [API Routes](#api-routes)
- [Utility Functions](#utility-functions)
- [Hooks](#hooks)

---

## Database Functions

All database functions are accessed through `@/db/unifiedDB`. Authentication is handled automatically.

### Projects

#### `getAllProjects()`
Get all projects for the authenticated user.

```javascript
import { getAllProjects } from '@/db/unifiedDB';

const projects = await getAllProjects();
// Returns: Array<Project>
```

**Returns:**
```javascript
[
  {
    id: string,
    name: string,
    description: string,
    perspective: "builder" | "contributor" | "integrator" | "experimenter",
    status: "active" | "completed" | "paused" | "archived",
    totalHoursLogged: number,
    targetHours: number,
    color: string,
    icon: string,
    createdAt: string,
    updatedAt: string,
    lastWorkedAt: string
  }
]
```

---

#### `getActiveProjects()`
Get only active projects.

```javascript
const activeProjects = await getActiveProjects();
// Returns: Array<Project> (filtered by status === 'active')
```

---

#### `getProject(projectId)`
Get a single project by ID.

```javascript
const project = await getProject('proj_abc123');
// Returns: Project | null
```

**Parameters:**
- `projectId` (string) - The project ID

**Returns:** Project object or null if not found

---

#### `getProjectWithStats(projectId)`
Get project with calculated statistics.

```javascript
const { project, stats } = await getProjectWithStats('proj_abc123');
```

**Returns:**
```javascript
{
  project: Project,
  stats: {
    lastWeekHours: number,
    previousWeekHours: number,
    weeklyChange: number,        // Percentage change
    totalHours: number,
    targetHours: number,
    completionRate: number       // Percentage
  }
}
```

---

#### `createProject(projectData)`
Create a new project.

```javascript
const project = await createProject({
  name: "New Project",
  description: "Project description",
  perspective: "builder",
  status: "active",
  targetHours: 100,
  color: "#3B82F6",
  icon: "Code"
});
// Returns: { id: string, ...projectData }
```

**Parameters:**
```javascript
{
  name: string,              // Required
  description: string,
  perspective: string,       // Required: builder, contributor, integrator, experimenter
  status: string,            // Default: "active"
  motivation?: string,
  goals?: string[],
  tags?: string[],
  targetHours?: number,
  color?: string,
  icon?: string
}
```

---

#### `updateProject(projectId, updates)`
Update an existing project.

```javascript
await updateProject('proj_abc123', {
  status: 'completed',
  totalHoursLogged: 150
});
```

**Parameters:**
- `projectId` (string) - The project ID
- `updates` (object) - Fields to update

---

#### `deleteProject(projectId)`
Delete a project.

```javascript
await deleteProject('proj_abc123');
```

**Parameters:**
- `projectId` (string) - The project ID

---

#### `subscribeToProjects(callback)`
Subscribe to real-time project updates.

```javascript
const unsubscribe = subscribeToProjects((projects) => {
  console.log('Projects updated:', projects);
  setProjects(projects);
});

// Later, unsubscribe
unsubscribe();
```

**Parameters:**
- `callback` (function) - Called with updated projects array

**Returns:** Unsubscribe function

---

### Time Logs

#### `getAllTimeLogs()`
Get all time logs with enriched project data.

```javascript
const timeLogs = await getAllTimeLogs();
```

**Returns:**
```javascript
[
  {
    id: string,
    projectId: string,
    projectName: string,      // Enriched from project
    projectColor: string,     // Enriched from project
    projectIcon: string,      // Enriched from project
    date: string,             // ISO timestamp
    duration: number,         // Hours
    activityType: string,
    description: string,
    energy: number,           // 1-5
    productivity: number,     // 1-5
    enjoyment: number,        // 1-5
    location: string,
    mood: string,
    createdAt: string,
    updatedAt: string
  }
]
```

---

#### `getTodayTimeLogs()`
Get time logs for today only.

```javascript
const todayLogs = await getTodayTimeLogs();
// Returns: Array<TimeLog>
```

---

#### `createTimeLog(logData)`
Create a new time log.

```javascript
const log = await createTimeLog({
  projectId: 'proj_abc123',
  date: new Date().toISOString(),
  duration: 2.5,
  activityType: 'Coding',
  description: 'Implemented new feature',
  energy: 4,
  productivity: 5,
  enjoyment: 5
});
```

**Side Effects:**
- Updates project's `totalHoursLogged`
- Updates project's `lastWorkedAt`

---

#### `updateTimeLog(logId, updates)`
Update an existing time log.

```javascript
await updateTimeLog('log_abc123', {
  duration: 3.0,
  description: 'Updated description'
});
```

**Side Effects:**
- Recalculates project hours if duration or projectId changed

---

#### `deleteTimeLog(logId)`
Delete a time log.

```javascript
await deleteTimeLog('log_abc123');
```

**Side Effects:**
- Updates project's `totalHoursLogged` (subtracts deleted duration)

---

### Journal Entries

#### `getAllJournalEntries()`
Get all journal entries.

```javascript
const entries = await getAllJournalEntries();
```

**Returns:**
```javascript
[
  {
    id: string,
    title: string,
    content: string,
    entryType: "reflection" | "milestone" | "challenge" | "idea",
    projectId?: string,
    tags: string[],
    sentiment: "positive" | "neutral" | "negative",
    date: string,
    createdAt: string,
    updatedAt: string
  }
]
```

---

#### `createJournalEntry(entryData)`
Create a new journal entry.

```javascript
const entry = await createJournalEntry({
  title: "Big Breakthrough",
  content: "Today I realized...",
  entryType: "milestone",
  projectId: 'proj_abc123',
  tags: ["insight", "vision"],
  sentiment: "positive",
  date: new Date().toISOString()
});
```

---

#### `updateJournalEntry(entryId, updates)`
Update a journal entry.

```javascript
await updateJournalEntry('entry_abc123', {
  content: 'Updated content...',
  tags: ['updated', 'tags']
});
```

---

#### `deleteJournalEntry(entryId)`
Delete a journal entry.

```javascript
await deleteJournalEntry('entry_abc123');
```

---

### Insights

#### `getActiveInsights()`
Get all non-dismissed insights.

```javascript
const insights = await getActiveInsights();
```

**Returns:**
```javascript
[
  {
    id: string,
    type: "balance" | "suggestion" | "pattern" | "warning",
    title: string,
    description: string,
    confidence: number,       // 0.0-1.0
    priority: "critical" | "high" | "medium" | "low",
    actionable: boolean,
    suggestedActions: string[],
    dismissed: boolean,
    dismissedAt: string | null,
    dismissReason: string | null,
    actedOn: boolean,
    actedOnAt: string | null,
    userFeedback: string | null,
    basedOn: object,
    createdAt: string,
    lastShownAt: string,
    validUntil: string | null
  }
]
```

---

#### `dismissInsight(insightId, reason?)`
Dismiss an insight.

```javascript
await dismissInsight('insight_abc123', 'Not relevant right now');
```

**Parameters:**
- `insightId` (string) - The insight ID
- `reason` (string, optional) - Why the insight was dismissed

---

#### `markInsightActedOn(insightId)`
Mark an insight as acted upon.

```javascript
await markInsightActedOn('insight_abc123');
```

---

#### `provideFeedback(insightId, feedback)`
Provide feedback on an insight.

```javascript
await provideFeedback('insight_abc123', 'Very helpful!');
```

---

#### `generateInsights()`
Generate new insights based on current data.

```javascript
const insights = await generateInsights();
// Returns: Array<Insight>
```

**Generates insights for:**
- Portfolio balance (overconcentration, missing perspectives)
- Activity patterns
- Project engagement
- Time allocation trends

---

### Conversations

#### `getConversations()`
Get all AI chat conversations.

```javascript
const conversations = await getConversations();
```

**Returns:**
```javascript
[
  {
    id: string,
    title: string,
    conversationType: "general" | "planning" | "reflection",
    messages: Array<Message>,
    messageCount: number,
    archived: boolean,
    favorite: boolean,
    resolved: boolean,
    actionItems: string[],
    tags: string[],
    startedAt: string,
    lastMessageAt: string,
    createdAt: string,
    updatedAt: string
  }
]
```

---

#### `getConversation(conversationId)`
Get a single conversation.

```javascript
const conversation = await getConversation('conv_abc123');
// Returns: Conversation | null
```

---

#### `createConversation(conversationData)`
Create a new conversation.

```javascript
const conversationId = await createConversation({
  title: 'Portfolio Discussion',
  conversationType: 'general',
  messages: [
    {
      role: 'assistant',
      content: 'How can I help?',
      timestamp: new Date().toISOString()
    }
  ]
});
// Returns: string (conversation ID)
```

---

#### `updateConversation(conversationId, updates)`
Update a conversation.

```javascript
await updateConversation('conv_abc123', {
  messages: [...updatedMessages],
  messageCount: updatedMessages.length
});
```

---

#### `deleteConversation(conversationId)`
Delete a conversation.

```javascript
await deleteConversation('conv_abc123');
```

---

### Portfolio

#### `getPortfolio()`
Get portfolio settings and balance.

```javascript
const portfolio = await getPortfolio();
```

**Returns:**
```javascript
{
  targetBalance: {
    builder: number,
    contributor: number,
    integrator: number,
    experimenter: number
  },
  actualBalance: {
    builder: number,
    contributor: number,
    integrator: number,
    experimenter: number
  },
  balanceScore: {
    score: number,
    drift: number,
    grade: string,
    status: string
  },
  lastCalculated: string
}
```

---

#### `updatePortfolio(portfolioData)`
Update portfolio settings.

```javascript
await updatePortfolio({
  targetBalance: {
    builder: 30,
    contributor: 25,
    integrator: 25,
    experimenter: 20
  }
});
```

---

#### `calculatePortfolioBalance()`
Calculate actual balance from time logs.

```javascript
const balance = await calculatePortfolioBalance();
```

**Returns:**
```javascript
{
  actualBalance: {
    builder: number,      // Percentage
    contributor: number,
    integrator: number,
    experimenter: number
  },
  totalHours: number,
  perspectiveHours: {
    builder: number,      // Absolute hours
    contributor: number,
    integrator: number,
    experimenter: number
  },
  lastCalculated: string
}
```

---

#### `getProjectsByPerspective(perspective)`
Get all projects for a specific perspective.

```javascript
const builderProjects = await getProjectsByPerspective('builder');
// Returns: Array<Project>
```

---

#### `getPerspectiveStats()`
Get statistics for each perspective.

```javascript
const stats = await getPerspectiveStats();
```

**Returns:**
```javascript
{
  builder: {
    count: number,        // Number of projects
    hours: number         // Total hours
  },
  contributor: { ... },
  integrator: { ... },
  experimenter: { ... }
}
```

---

### User Profile

#### `getUserProfile()`
Get user profile data.

```javascript
const profile = await getUserProfile();
```

**Returns:**
```javascript
{
  email: string,
  displayName: string,
  portfolio: { ... },
  settings: { ... },
  createdAt: string,
  updatedAt: string
}
```

---

#### `updateUserProfile(updates)`
Update user profile.

```javascript
await updateUserProfile({
  displayName: 'New Name',
  settings: {
    ai: { apiKey: 'sk-ant-...' }
  }
});
```

---

#### `createUserProfile(profileData)`
Create a new user profile (called on signup).

```javascript
await createUserProfile({
  email: 'user@example.com',
  displayName: 'User Name'
});
```

---

## API Routes

### POST /api/chat

AI chat endpoint with Claude integration.

**Request:**
```javascript
POST /api/chat
Content-Type: application/json

{
  messages: [
    { role: "user", content: "How balanced is my portfolio?" }
  ],
  tools: [...],        // Optional: Agentic tools
  system: "..."        // Optional: Custom system prompt
}
```

**Response:**
```javascript
{
  model: "claude-sonnet-4-20250514",
  id: "msg_...",
  type: "message",
  role: "assistant",
  content: [
    {
      type: "text",
      text: "Your portfolio balance..."
    }
  ],
  stop_reason: "end_turn",
  usage: {
    input_tokens: 523,
    output_tokens: 187
  }
}
```

**Example Usage:**
```javascript
const response = await fetch('/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    messages: [
      { role: 'user', content: 'What should I focus on?' }
    ],
    system: portfolioAwareSystemPrompt
  })
});

const data = await response.json();
const reply = data.content[0].text;
```

---

## Utility Functions

### Balance Calculator

#### `calculateBalanceScore(actual, target)`

```javascript
import { calculateBalanceScore } from '@/lib/balance-calculator';

const score = calculateBalanceScore(
  { builder: 45, contributor: 20, integrator: 25, experimenter: 10 },
  { builder: 25, contributor: 25, integrator: 25, experimenter: 25 }
);
```

**Returns:**
```javascript
{
  score: number,          // 0-100
  drift: number,          // Percentage deviation
  grade: string,          // A, B, C, D
  status: string,         // "Excellent", "Good", etc.
  deviations: [
    {
      perspective: string,
      actual: number,
      target: number,
      deviation: number
    }
  ],
  recommendations: [
    {
      type: string,
      perspective: string,
      message: string
    }
  ]
}
```

---

### AI Prompt Generator

#### `generatePortfolioAwarePrompt(portfolioData)`

```javascript
import { generatePortfolioAwarePrompt } from '@/lib/ai-prompt-generator';

const systemPrompt = generatePortfolioAwarePrompt({
  userName: 'John',
  actualBalance: { builder: 45, ... },
  targetBalance: { builder: 25, ... },
  balanceScore: { score: 65, drift: 17.5, grade: 'C' },
  totalHours: 124,
  activeProjects: 8,
  recentActivity: [...]
});
```

**Returns:** String (system prompt for Claude)

---

## Hooks

### usePortfolioContext

Custom hook to load portfolio context for AI.

```javascript
import { usePortfolioContext } from '@/hooks/usePortfolioContext';

function MyComponent() {
  const { portfolioContext, loading, error, refresh } = usePortfolioContext();
  
  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  
  return (
    <div>
      Balance: {portfolioContext.balanceScore.score}/100
    </div>
  );
}
```

**Returns:**
```javascript
{
  portfolioContext: {
    userName: string,
    actualBalance: object,
    targetBalance: object,
    balanceScore: object,
    totalHours: number,
    activeProjects: number,
    recentActivity: array
  },
  loading: boolean,
  error: Error | null,
  refresh: function
}
```

---

### useAuth

Authentication context hook.

```javascript
import { useAuth } from '@/contexts/AuthContext';

function MyComponent() {
  const { user, loading } = useAuth();
  
  if (loading) return <div>Loading...</div>;
  if (!user) return <div>Please log in</div>;
  
  return <div>Welcome, {user.email}</div>;
}
```

**Returns:**
```javascript
{
  user: {
    uid: string,
    email: string,
    displayName: string
  } | null,
  loading: boolean
}
```

---

## Error Handling

All database functions throw errors that should be caught:

```javascript
try {
  const projects = await getAllProjects();
  setProjects(projects);
} catch (error) {
  if (error.message.includes('auth')) {
    // Redirect to login
  } else {
    // Show error message
    console.error('Failed to load:', error);
  }
}
```

**Common Error Messages:**
- `"User must be authenticated. Please log in."` - No current user
- `"Permission denied"` - Firestore security rules violation
- `"Document not found"` - Requested document doesn't exist

---

## Rate Limits

- **Firestore**: 1 write per second per document (handled automatically)
- **Claude API**: 50 requests per minute (check Anthropic docs for current limits)

---

## Best Practices

1. **Always use unifiedDB**, never direct Firestore access
2. **Handle errors** with try/catch
3. **Show loading states** during async operations
4. **Use real-time listeners** sparingly (they consume connections)
5. **Batch updates** when modifying multiple documents
6. **Cache portfolio context** during chat sessions

---

**For more information:**
- [DATABASE.md](./DATABASE.md) - Schema details
- [ARCHITECTURE.md](./ARCHITECTURE.md) - System design
- [CONTRIBUTING.md](./CONTRIBUTING.md) - Development guide
</file>

<file path="docs/ARCHITECTURE.md">
# RetireWise Architecture

## Overview

RetireWise is built on a modern, serverless architecture using Next.js 15 with the App Router, Firebase for backend services, and Anthropic Claude for AI capabilities.

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT LAYER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Next.js 15 App Router                                       â”‚
â”‚  â”œâ”€â”€ Pages (app/)                                            â”‚
â”‚  â”œâ”€â”€ Components (React 18)                                   â”‚
â”‚  â”œâ”€â”€ Contexts (AuthContext)                                  â”‚
â”‚  â””â”€â”€ Hooks (usePortfolioContext)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     APPLICATION LAYER                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Database Abstraction (db/)                                  â”‚
â”‚  â”œâ”€â”€ unifiedDB.js (Authentication + Routing)                â”‚
â”‚  â”‚   â”œâ”€â”€ requireAuth()                                       â”‚
â”‚  â”‚   â””â”€â”€ Exports: getAllProjects(), createTimeLog(), etc.   â”‚
â”‚  â””â”€â”€ firestore/                                              â”‚
â”‚      â””â”€â”€ firestoreDB.js (Direct Firestore Operations)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVICES LAYER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€â”€ API Routes (app/api/)                                   â”‚
â”‚  â”‚   â””â”€â”€ /api/chat (Claude AI integration)                  â”‚
â”‚  â”œâ”€â”€ AI Service (services/aiService.js)                     â”‚
â”‚  â”‚   â”œâ”€â”€ Agentic tools                                       â”‚
â”‚  â”‚   â””â”€â”€ Portfolio context generation                       â”‚
â”‚  â””â”€â”€ Libraries (lib/)                                        â”‚
â”‚      â””â”€â”€ ai-prompt-generator.js                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BACKEND SERVICES                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€â”€ Firebase Authentication                                 â”‚
â”‚  â”œâ”€â”€ Firestore Database                                      â”‚
â”‚  â”‚   â”œâ”€â”€ users/{userId}                                      â”‚
â”‚  â”‚   â”œâ”€â”€ projects/                                           â”‚
â”‚  â”‚   â”œâ”€â”€ timeLogs/                                           â”‚
â”‚  â”‚   â””â”€â”€ conversations/                                      â”‚
â”‚  â””â”€â”€ Anthropic Claude API                                    â”‚
â”‚      â””â”€â”€ claude-sonnet-4-20250514                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEPLOYMENT LAYER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Vercel Platform                                             â”‚
â”‚  â”œâ”€â”€ Edge Functions (API routes)                            â”‚
â”‚  â”œâ”€â”€ Static Assets (CDN)                                     â”‚
â”‚  â””â”€â”€ Automatic HTTPS                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Principles

### 1. **Offline-First Architecture**
- Firestore persistent cache enabled
- Local-first data mutations
- Background synchronization
- Conflict-free merges

### 2. **Authentication-First Design**
- All operations require authentication
- User ID injected at database layer
- No direct userId passing in components
- Automatic data isolation

### 3. **Layered Abstraction**
```
Components â†’ unifiedDB â†’ firestoreDB â†’ Firestore
```
- Components never access Firestore directly
- unifiedDB provides authentication layer
- firestoreDB handles raw operations
- Clean separation of concerns

### 4. **Portfolio-Centric AI**
- AI system prompts enriched with portfolio context
- Real-time balance calculation
- Agentic tools for data retrieval
- Context-aware recommendations

---

## Data Flow

### Read Operation Flow
```
1. User opens Portfolio Dashboard
   â†“
2. Component calls: getAllProjects()
   â†“
3. unifiedDB.getAllProjects()
   - Calls requireAuth() â†’ gets userId
   - Calls firestoreDB.getProjects(userId)
   â†“
4. firestoreDB.getProjects(userId)
   - Queries: users/{userId}/projects
   - Returns: Array of project documents
   â†“
5. Data flows back to component
   - Component updates state
   - UI re-renders with data
```

### Write Operation Flow
```
1. User creates a project
   â†“
2. Component calls: createProject(projectData)
   â†“
3. unifiedDB.createProject(projectData)
   - Calls requireAuth() â†’ gets userId
   - Calls firestoreDB.createProject(userId, projectData)
   â†“
4. firestoreDB.createProject(userId, projectData)
   - Adds to: users/{userId}/projects
   - Returns: Generated document ID
   â†“
5. Real-time listener notifies other tabs
   â†“
6. UI updates automatically
```

### AI Chat Flow with Portfolio Context
```
1. User opens AI Chat
   â†“
2. usePortfolioContext hook loads:
   - Portfolio settings
   - Time logs
   - Projects
   - Balance calculation
   â†“
3. User sends message
   â†“
4. generatePortfolioAwarePrompt(portfolioContext)
   - Creates enriched system prompt
   - Includes balance score, targets, recent activity
   â†“
5. sendMessage(userInput, history, systemPrompt)
   - Sends to /api/chat
   - API forwards to Claude with context
   â†“
6. Claude may use agentic tools:
   - get_recent_activity
   - search_journal
   - analyze_patterns
   - get_project_details
   â†“
7. Response includes portfolio-aware advice
   â†“
8. Conversation saved to Firestore
```

---

## Component Architecture

### Component Hierarchy
```
App Layout (app/layout.js)
â”œâ”€â”€ AuthProvider (AuthContext)
â”‚   â”œâ”€â”€ Navigation
â”‚   â””â”€â”€ Page Content
â”‚       â”œâ”€â”€ Dashboard (portfolio/page.js)
â”‚       â”‚   â”œâ”€â”€ PortfolioDashboard
â”‚       â”‚   â”œâ”€â”€ InsightsPanel
â”‚       â”‚   â””â”€â”€ ProjectsList
â”‚       â”œâ”€â”€ AI Chat (chat/page.js)
â”‚       â”‚   â””â”€â”€ AIChat
â”‚       â”‚       â””â”€â”€ usePortfolioContext
â”‚       â”œâ”€â”€ Analytics (analytics/page.js)
â”‚       â”‚   â””â”€â”€ AnalyticsDashboard
â”‚       â””â”€â”€ Projects (projects/[id]/page.js)
â”‚           â””â”€â”€ ProjectDetails
```

### Key Components

#### **PortfolioDashboard**
- Displays balance across 4 perspectives
- Shows balance score and grade
- Provides filtering by perspective
- Real-time updates via Firestore listeners

#### **AIChat**
- Manages conversation state
- Integrates portfolio context
- Handles message sending/receiving
- Displays tool usage indicators
- Persists conversations to Firestore

#### **InsightsPanel**
- Fetches active insights
- Groups by priority
- Handles dismiss actions
- Triggers insight generation

#### **ProjectDetails**
- Shows project information
- Displays time logs
- Tracks progress toward goals
- Allows editing and updates

---

## Database Layer Architecture

### Three-Tier Design

#### **Tier 1: Components**
```javascript
// Components only import unifiedDB
import { getAllProjects, createProject } from '@/db/unifiedDB';

// Never pass userId - it's handled automatically
const projects = await getAllProjects();
```

#### **Tier 2: unifiedDB.js**
```javascript
// Authentication layer
export const getAllProjects = async () => {
  const userId = requireAuth();  // Get userId from context
  return await firestoreDB.getProjects(userId);
};

// Business logic layer
export const createTimeLog = async (logData) => {
  const userId = requireAuth();
  const id = await firestoreDB.createTimeLog(userId, logData);
  
  // Update project hours (business logic)
  const project = await getProject(logData.projectId);
  if (project) {
    await updateProject(logData.projectId, {
      totalHoursLogged: project.totalHoursLogged + logData.duration
    });
  }
  
  return { id, ...logData };
};
```

#### **Tier 3: firestoreDB.js**
```javascript
// Raw Firestore operations
export const getProjects = async (userId) => {
  const ref = collection(db, `users/${userId}/projects`);
  const snapshot = await getDocs(ref);
  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};
```

### Benefits of This Architecture
- âœ… Authentication enforced automatically
- âœ… Business logic centralized
- âœ… Components stay clean and simple
- âœ… Easy to swap database implementations
- âœ… Consistent error handling

---

## AI Integration Architecture

### System Prompt Generation

```javascript
// Portfolio context fetched once on mount
const portfolioContext = {
  userName: "User",
  actualBalance: { builder: 45, contributor: 20, ... },
  targetBalance: { builder: 25, contributor: 25, ... },
  balanceScore: { score: 65, drift: 17.5, grade: 'C' },
  totalHours: 124,
  activeProjects: 8,
  recentActivity: [...]
};

// Transformed into rich system prompt
const systemPrompt = `
You are RetireWise AI...

Balance Score: 65/100 (Grade: C - Needs Attention)
Portfolio Drift: 17.5% from target

Perspective Breakdown:
  â€¢ Builder: 45% vs 25% target (+20% overweight)
  â€¢ Contributor: 20% vs 25% target (-5% underweight)
  ...
`;
```

### Agentic Tool Architecture

```javascript
// Tools defined in aiService.js
const AGENTIC_TOOLS = [
  {
    name: 'get_recent_activity',
    description: 'Get user activity from past N days',
    input_schema: { days: 'number' }
  },
  // ... other tools
];

// Tool execution
const executeToolFunction = async (toolName, input) => {
  switch (toolName) {
    case 'get_recent_activity':
      const timeLogs = await getAllTimeLogs();
      return filterAndAggregate(timeLogs, input.days);
    // ... other tools
  }
};

// Two-step AI flow
1. User message â†’ Claude â†’ Requests tool use
2. Execute tools â†’ Results â†’ Claude â†’ Final response
```

---

## State Management

### React Context Pattern

```javascript
// AuthContext provides authentication state
const AuthContext = createContext();

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setUser(user);
      if (user) {
        setCurrentUser(user.uid); // Set in unifiedDB
      }
    });
    return unsubscribe;
  }, []);
  
  return (
    <AuthContext.Provider value={{ user }}>
      {children}
    </AuthContext.Provider>
  );
}
```

### Custom Hooks Pattern

```javascript
// usePortfolioContext - Fetches portfolio data
export function usePortfolioContext() {
  const [portfolioContext, setPortfolioContext] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadPortfolioContext();
  }, []);
  
  async function loadPortfolioContext() {
    const data = await fetchAllPortfolioData();
    setPortfolioContext(data);
    setLoading(false);
  }
  
  return { portfolioContext, loading };
}
```

---

## Security Architecture

### Authentication Flow
```
1. User visits app
   â†“
2. useAuth() checks Firebase auth state
   â†“
3. If not authenticated:
   - Redirect to /login
   - Show authentication UI
   â†“
4. User logs in with email/password
   â†“
5. Firebase returns auth token
   â†“
6. setCurrentUser(userId) called
   â†“
7. All subsequent DB calls include userId
   â†“
8. Firestore rules verify: request.auth.uid == userId
```

### Data Isolation
```javascript
// Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Only authenticated user can access their data
      allow read, write: if request.auth != null 
                         && request.auth.uid == userId;
      
      // Applies to all subcollections
      match /{document=**} {
        allow read, write: if request.auth != null 
                           && request.auth.uid == userId;
      }
    }
  }
}
```

### API Security
```javascript
// API routes don't need separate authentication
// Firestore rules enforce security at data layer
export async function POST(request) {
  const body = await request.json();
  
  // API is stateless
  // Security enforced by Firestore rules
  // User must be authenticated to call unifiedDB functions
  
  return NextResponse.json(result);
}
```

---

## Performance Optimization

### Firestore Optimization
```javascript
// Indexed queries for fast retrieval
const q = query(
  collection(db, 'users', userId, 'timeLogs'),
  orderBy('date', 'desc'),
  limit(50)
);

// Offline persistence
enableIndexedDbPersistence(db);

// Real-time listeners for live updates
const unsubscribe = onSnapshot(projectsRef, (snapshot) => {
  updateUI(snapshot.docs);
});
```

### Code Splitting
```javascript
// Next.js automatic code splitting
import dynamic from 'next/dynamic';

// Lazy load heavy components
const AnalyticsDashboard = dynamic(
  () => import('@/components/AnalyticsDashboard'),
  { loading: () => <Loader /> }
);
```

### Caching Strategy
```javascript
// Portfolio context cached during chat session
const { portfolioContext, loading } = usePortfolioContext();
// Fetched once on mount, reused for all messages
```

---

## Error Handling

### Layered Error Handling

```javascript
// Component Level
try {
  const projects = await getAllProjects();
  setProjects(projects);
} catch (error) {
  console.error('Failed to load projects:', error);
  setError('Could not load projects. Please try again.');
}

// unifiedDB Level
export const getAllProjects = async () => {
  try {
    const userId = requireAuth();
    return await firestoreDB.getProjects(userId);
  } catch (error) {
    if (error.message.includes('auth')) {
      throw new Error('Please log in to access projects');
    }
    throw error;
  }
};

// firestoreDB Level
export const getProjects = async (userId) => {
  try {
    const ref = collection(db, `users/${userId}/projects`);
    const snapshot = await getDocs(ref);
    return snapshot.docs.map(doc => ({...}));
  } catch (error) {
    console.error('Firestore error:', error);
    throw new Error('Database error: ' + error.message);
  }
};
```

---

## Deployment Architecture

### Vercel Edge Network
```
User Request
    â†“
Vercel Edge (closest region)
    â†“
â”œâ”€ Static Assets (CDN cached)
â”œâ”€ Server Components (rendered)
â””â”€ API Routes (edge functions)
    â†“
Firebase Services (multi-region)
    â†“
Anthropic API (us-east)
```

### Environment Configuration
- **Production**: Vercel environment variables
- **Preview**: Branch-specific env vars
- **Development**: `.env.local` file
- **CI/CD**: GitHub Actions with secrets

---

## Design Patterns Used

### 1. **Repository Pattern**
- unifiedDB acts as repository
- Abstracts data source
- Provides consistent interface

### 2. **Provider Pattern**
- AuthContext provides auth state
- Wraps entire app
- Single source of truth

### 3. **Hook Pattern**
- usePortfolioContext encapsulates logic
- Reusable across components
- Manages own state

### 4. **Strategy Pattern**
- Different balance calculation strategies
- Pluggable insight generators
- Configurable AI tools

### 5. **Observer Pattern**
- Firestore real-time listeners
- React state updates
- Cross-tab synchronization

---

## Testing Strategy

### Unit Testing
```javascript
// Test database functions
test('getAllProjects returns user projects', async () => {
  const projects = await getAllProjects();
  expect(projects).toBeInstanceOf(Array);
});

// Test balance calculation
test('calculateBalanceScore returns correct grade', () => {
  const score = calculateBalanceScore(actual, target);
  expect(score.grade).toBe('B');
});
```

### Integration Testing
```javascript
// Test full flow
test('Creating project updates portfolio', async () => {
  const project = await createProject(data);
  const portfolio = await calculatePortfolioBalance();
  expect(portfolio.perspectiveHours.builder).toBeGreaterThan(0);
});
```

### E2E Testing (Future)
- Cypress for user flows
- Test authentication
- Test data persistence
- Test real-time sync

---

## Scalability Considerations

### Current Architecture Supports
- **Users**: 100,000+ (Firestore limit is much higher)
- **Documents per user**: Unlimited
- **Concurrent operations**: Firestore auto-scales
- **API calls**: Vercel edge functions scale automatically

### Future Scaling Needs
- **Pagination**: Implement for large datasets
- **Caching**: Add Redis for frequently accessed data
- **Background Jobs**: Cloud Functions for batch processing
- **Analytics**: BigQuery export for complex analysis

---

## Migration Path

### From Dexie to Firestore (Completed)
```
Phase 1: Add Firestore alongside Dexie
Phase 2: Implement dual-write to both
Phase 3: Read from Firestore, fall back to Dexie
Phase 4: Remove Dexie completely âœ…
```

### Future Database Considerations
- Current: Firestore (document-based)
- Possible: PostgreSQL (relational, if complex queries needed)
- Possible: Prisma ORM (type-safe queries)
- Migration path: Keep abstraction layer (unifiedDB)

---

## Architecture Decisions Log

### Why Next.js App Router?
- Server Components for better performance
- Built-in API routes
- File-based routing
- Excellent TypeScript support

### Why Firestore?
- Real-time synchronization
- Offline support built-in
- Auto-scaling
- Pay-per-use pricing
- Firebase Authentication integration

### Why Claude AI?
- Best-in-class reasoning
- Tool use (agentic capabilities)
- Large context window (200k tokens)
- API simplicity

### Why Vercel?
- Seamless Next.js deployment
- Edge functions for low latency
- Automatic HTTPS and CDN
- Preview deployments
- Zero configuration

---

**For more details, see:**
- [DATABASE.md](./DATABASE.md) - Schema details
- [API_REFERENCE.md](./API_REFERENCE.md) - Function documentation
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Deployment guide
</file>

<file path="docs/CONTRIBUTING.md">
# Contributing to RetireWise

Thank you for your interest in contributing to RetireWise! This guide will help you get started with development, coding standards, and the contribution workflow.

---

## Table of Contents

- [Getting Started](#getting-started)
- [Development Workflow](#development-workflow)
- [Code Standards](#code-standards)
- [Architecture Guidelines](#architecture-guidelines)
- [Testing](#testing)
- [Pull Request Process](#pull-request-process)
- [Feature Development](#feature-development)

---

## Getting Started

### Prerequisites

- Node.js 18+ and npm
- Git
- Firebase account (for testing)
- Anthropic API key (for AI features)
- Code editor (VS Code recommended)

### Initial Setup

1. **Fork and clone**
   ```bash
   git clone https://github.com/yourusername/retirewise.git
   cd retirewise
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Set up environment**
   ```bash
   cp .env.example .env.local
   # Edit .env.local with your credentials
   ```

4. **Start development server**
   ```bash
   npm run dev
   ```

5. **Verify setup**
   - Open http://localhost:3000
   - Sign up with test account
   - Create a project
   - Log some time
   - Test AI chat

---

## Development Workflow

### Branch Strategy

```
main (production)
  â””â”€â”€ develop (integration)
      â”œâ”€â”€ feature/your-feature
      â”œâ”€â”€ bugfix/issue-123
      â””â”€â”€ enhancement/improve-x
```

### Creating a Branch

```bash
# For new features
git checkout -b feature/portfolio-goals-ui

# For bug fixes
git checkout -b bugfix/fix-scroll-issue

# For enhancements
git checkout -b enhancement/improve-balance-calc
```

### Commit Messages

Follow conventional commits format:

```bash
# Features
git commit -m "feat: add portfolio goal setting UI"
git commit -m "feat(ai): enhance system prompt with targets"

# Fixes
git commit -m "fix: scroll to bottom on chat load"
git commit -m "fix(db): handle missing user profile gracefully"

# Refactoring
git commit -m "refactor: extract balance calculation to utility"

# Documentation
git commit -m "docs: update API reference for new functions"

# Chores
git commit -m "chore: update dependencies"
```

**Format:**
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:**
- `feat`: New feature
- `fix`: Bug fix
- `refactor`: Code change that neither fixes a bug nor adds a feature
- `docs`: Documentation only changes
- `style`: Code style changes (formatting, missing semi-colons, etc.)
- `test`: Adding or updating tests
- `chore`: Changes to build process or auxiliary tools

---

## Code Standards

### JavaScript/React

#### File Naming
```
Components:     PascalCase.js     (e.g., PortfolioDashboard.js)
Utilities:      camelCase.js      (e.g., balanceCalculator.js)
Hooks:          use*.js           (e.g., usePortfolioContext.js)
API Routes:     route.js          (Next.js convention)
```

#### Component Structure

```javascript
// 1. Imports
import React, { useState, useEffect } from 'react';
import { Icon } from 'lucide-react';
import { someFunction } from '@/lib/utils';

// 2. Component definition
export default function ComponentName({ prop1, prop2 }) {
  // 3. Hooks
  const [state, setState] = useState(initialValue);
  
  useEffect(() => {
    // Effect logic
  }, [dependencies]);
  
  // 4. Event handlers
  const handleClick = () => {
    // Handler logic
  };
  
  // 5. Helper functions
  const helperFunction = () => {
    // Logic
  };
  
  // 6. Render
  return (
    <div className="container">
      {/* JSX */}
    </div>
  );
}
```

#### Naming Conventions

```javascript
// Variables and functions: camelCase
const projectList = [];
const calculateBalance = () => {};

// Components: PascalCase
function ProjectCard() {}

// Constants: UPPER_SNAKE_CASE
const MAX_PROJECTS = 50;
const API_ENDPOINT = '/api/chat';

// Private functions: _prefixed (optional)
const _internalHelper = () => {};

// Boolean variables: is/has prefix
const isActive = true;
const hasProjects = false;
```

#### Code Style

```javascript
// âœ… Good
const projects = await getAllProjects();
const activeProjects = projects.filter(p => p.status === 'active');

// âŒ Avoid
const p = await getAllProjects();
const ap = p.filter(x => x.status === 'active');

// âœ… Good - Early returns
function getProjectStatus(project) {
  if (!project) return 'unknown';
  if (project.status === 'completed') return 'done';
  return 'in progress';
}

// âŒ Avoid - Nested conditions
function getProjectStatus(project) {
  if (project) {
    if (project.status === 'completed') {
      return 'done';
    } else {
      return 'in progress';
    }
  } else {
    return 'unknown';
  }
}
```

### CSS/Tailwind

```javascript
// âœ… Good - Organized classes
<div className="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200">

// âœ… Good - Conditional classes
<div className={`
  px-4 py-2 rounded-lg
  ${isActive ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}
`}>

// âŒ Avoid - Inline styles (unless dynamic)
<div style={{ padding: '16px', backgroundColor: 'white' }}>
```

### Database Operations

```javascript
// âœ… Good - Always use unifiedDB
import { getAllProjects } from '@/db/unifiedDB';
const projects = await getAllProjects();

// âŒ Never - Direct Firestore access in components
import { collection, getDocs } from 'firebase/firestore';
const ref = collection(db, 'users', userId, 'projects');

// âœ… Good - Error handling
try {
  const project = await getProject(projectId);
  setProject(project);
} catch (error) {
  console.error('Failed to load project:', error);
  setError('Could not load project');
}

// âŒ Avoid - No error handling
const project = await getProject(projectId);
setProject(project);
```

---

## Architecture Guidelines

### Layer Separation

```
Component Layer
  â†“ (imports from)
unifiedDB Layer
  â†“ (imports from)
firestoreDB Layer
  â†“ (uses)
Firestore SDK
```

**Rules:**
1. Components NEVER import firestoreDB directly
2. Components NEVER pass userId (unifiedDB handles it)
3. unifiedDB functions ALWAYS call requireAuth()
4. Business logic lives in unifiedDB
5. Raw operations live in firestoreDB

### Adding a New Database Function

**Step 1:** Add to firestoreDB.js
```javascript
// src/db/firestore/firestoreDB.js
export const getSomething = async (userId) => {
  const ref = collection(db, `users/${userId}/something`);
  const snapshot = await getDocs(ref);
  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};
```

**Step 2:** Add to unifiedDB.js
```javascript
// src/db/unifiedDB.js
export const getSomething = async () => {
  const userId = requireAuth();
  return await firestoreDB.getSomething(userId);
};

// Add to default export
export default {
  // ...
  getSomething,
};
```

**Step 3:** Use in component
```javascript
// Component
import { getSomething } from '@/db/unifiedDB';

const data = await getSomething();
```

### Adding a New Component

1. Create component file in appropriate directory
2. Follow component structure (see above)
3. Add `'use client'` if using hooks
4. Export as default
5. Document props with comments
6. Add to relevant page

```javascript
// src/components/NewComponent.js
'use client';

import React, { useState } from 'react';

/**
 * NewComponent - Description of what it does
 * 
 * @param {string} prop1 - Description
 * @param {number} prop2 - Description
 */
export default function NewComponent({ prop1, prop2 }) {
  // Implementation
}
```

---

## Testing

### Manual Testing Checklist

Before submitting a PR, test:

**Authentication:**
- [ ] Can sign up
- [ ] Can sign in
- [ ] Can sign out
- [ ] Redirect to login when not authenticated

**Core Features:**
- [ ] Can create projects
- [ ] Can log time
- [ ] Can view analytics
- [ ] Can use AI chat
- [ ] Balance calculates correctly

**Data Persistence:**
- [ ] Data saves to Firestore
- [ ] Data loads on refresh
- [ ] Real-time sync works (test in two tabs)

**Responsive Design:**
- [ ] Works on mobile (375px width)
- [ ] Works on tablet (768px width)
- [ ] Works on desktop (1920px width)

**Edge Cases:**
- [ ] Empty states display correctly
- [ ] Error messages are clear
- [ ] Loading states show
- [ ] Network errors handled gracefully

### Testing New Features

When adding a feature:

1. **Test happy path**
   - Feature works as expected
   - Data saves correctly
   - UI updates properly

2. **Test error cases**
   - What if API fails?
   - What if data is missing?
   - What if user is not authenticated?

3. **Test edge cases**
   - Empty data
   - Large datasets
   - Slow network
   - Offline mode

4. **Test integration**
   - Does it affect existing features?
   - Does navigation still work?
   - Do other components still load?

---

## Pull Request Process

### Before Opening a PR

1. **Pull latest changes**
   ```bash
   git checkout main
   git pull origin main
   git checkout your-branch
   git rebase main
   ```

2. **Test thoroughly**
   - Run manual tests (see above)
   - Verify no console errors
   - Check responsive design

3. **Clean up code**
   - Remove console.logs
   - Remove commented code
   - Fix formatting
   - Add comments for complex logic

4. **Update documentation**
   - Update README if needed
   - Update API_REFERENCE if added functions
   - Add code comments

### Opening a PR

1. **Push your branch**
   ```bash
   git push origin feature/your-feature
   ```

2. **Create PR on GitHub**
   - Use descriptive title
   - Fill out PR template
   - Link related issues
   - Add screenshots for UI changes

3. **PR Template**

   ```markdown
   ## Description
   Brief description of what this PR does.
   
   ## Type of Change
   - [ ] Bug fix
   - [ ] New feature
   - [ ] Breaking change
   - [ ] Documentation update
   
   ## Changes Made
   - List specific changes
   - Include technical details
   - Mention affected files
   
   ## Testing
   - [ ] Tested locally
   - [ ] Tested on mobile
   - [ ] Tested error cases
   - [ ] Tested integration
   
   ## Screenshots (if UI changes)
   ![Before](url)
   ![After](url)
   
   ## Related Issues
   Closes #123
   
   ## Checklist
   - [ ] Code follows style guidelines
   - [ ] Self-review completed
   - [ ] Comments added for complex logic
   - [ ] Documentation updated
   - [ ] No console errors
   - [ ] Mobile responsive
   ```

### Review Process

1. Maintainer reviews code
2. Feedback addressed
3. Approval granted
4. PR merged to main
5. Automatic deployment to Vercel

---

## Feature Development

### Planning a Feature

1. **Create an issue** describing the feature
2. **Discuss approach** in comments
3. **Break down into tasks** (if large)
4. **Estimate effort** (S/M/L)
5. **Get approval** before starting

### Implementing a Feature

1. **Create branch** from main
2. **Implement in small commits**
3. **Test frequently**
4. **Document as you go**
5. **Open PR when ready**

### Example: Adding Portfolio Goals UI

**Step 1: Create Component**
```javascript
// src/components/PortfolioGoalSetter.js
'use client';

export default function PortfolioGoalSetter() {
  // Implementation
}
```

**Step 2: Add Database Functions** (if needed)
```javascript
// Already exists: getPortfolio(), updatePortfolio()
```

**Step 3: Create Page**
```javascript
// src/app/portfolio/goals/page.js
import PortfolioGoalSetter from '@/components/PortfolioGoalSetter';

export default function GoalsPage() {
  return <PortfolioGoalSetter />;
}
```

**Step 4: Add Navigation**
```javascript
// Update navigation component
{ label: 'Goals', href: '/portfolio/goals', icon: Target }
```

**Step 5: Test**
- Can set target percentages?
- Does validation work (must sum to 100%)?
- Does it save to Firestore?
- Does dashboard reflect new targets?

**Step 6: Document**
- Add to README feature list
- Update API_REFERENCE if new functions
- Add code comments

---

## Code Review Guidelines

### As a Reviewer

**Check for:**
- [ ] Code follows style guidelines
- [ ] No security vulnerabilities
- [ ] Proper error handling
- [ ] Clear variable names
- [ ] Comments for complex logic
- [ ] No console.logs in production code
- [ ] Mobile responsive
- [ ] Database operations use unifiedDB
- [ ] No breaking changes (or clearly marked)

**Provide:**
- Constructive feedback
- Specific suggestions
- Examples of improvements
- Praise for good code

### As a Contributor

**Respond to:**
- All review comments
- Implement requested changes
- Ask questions if unclear
- Push updates
- Request re-review

---

## Common Patterns

### Fetching Data

```javascript
// Pattern: Fetch on mount
useEffect(() => {
  const fetchData = async () => {
    try {
      setLoading(true);
      const data = await getSomething();
      setData(data);
      setError(null);
    } catch (err) {
      console.error('Failed to fetch:', err);
      setError('Could not load data');
    } finally {
      setLoading(false);
    }
  };
  
  fetchData();
}, []);
```

### Forms

```javascript
// Pattern: Controlled form
const [formData, setFormData] = useState({
  name: '',
  description: ''
});

const handleChange = (e) => {
  setFormData(prev => ({
    ...prev,
    [e.target.name]: e.target.value
  }));
};

const handleSubmit = async (e) => {
  e.preventDefault();
  try {
    await createSomething(formData);
    setFormData({ name: '', description: '' });
    // Show success
  } catch (error) {
    // Show error
  }
};
```

### Conditional Rendering

```javascript
// Pattern: Loading, error, data
if (loading) return <Loader />;
if (error) return <Error message={error} />;
if (!data) return <Empty />;

return <DataDisplay data={data} />;
```

---

## Resources

### Documentation
- [Next.js Docs](https://nextjs.org/docs)
- [React Docs](https://react.dev)
- [Firebase Docs](https://firebase.google.com/docs)
- [Tailwind Docs](https://tailwindcss.com/docs)

### Project Docs
- [README.md](../README.md) - Project overview
- [ARCHITECTURE.md](./ARCHITECTURE.md) - System architecture
- [DATABASE.md](./DATABASE.md) - Database schema
- [API_REFERENCE.md](./API_REFERENCE.md) - API documentation
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Deployment guide

### Tools
- [VS Code](https://code.visualstudio.com/) - Recommended editor
- [React DevTools](https://react.dev/learn/react-developer-tools)
- [Firebase Console](https://console.firebase.google.com/)
- [Vercel Dashboard](https://vercel.com/dashboard)

---

## Getting Help

- **Issues:** Check existing issues or create a new one
- **Discussions:** Use GitHub Discussions for questions
- **Documentation:** Read the docs first
- **Code Examples:** Look at existing components

---

## License

By contributing, you agree that your contributions will be licensed under the MIT License.

---

**Thank you for contributing to RetireWise!** ğŸ‰
</file>

<file path="docs/DATABASE.md">
# RetireWise Database Schema

## Overview

RetireWise uses Firebase Firestore as its primary database with a user-centric document structure. All user data is isolated under `users/{userId}/` for security and scalability.

---

## Database Structure

```
firestore/
â””â”€â”€ users/
    â””â”€â”€ {userId}/                    # User document (root)
        â”œâ”€â”€ portfolio: object        # Portfolio settings and balance
        â”œâ”€â”€ settings: object         # User preferences
        â”œâ”€â”€ createdAt: timestamp
        â”œâ”€â”€ updatedAt: timestamp
        â”‚
        â”œâ”€â”€ projects/                # Projects subcollection
        â”‚   â””â”€â”€ {projectId}
        â”‚
        â”œâ”€â”€ timeLogs/                # Time logs subcollection
        â”‚   â””â”€â”€ {logId}
        â”‚
        â”œâ”€â”€ journalEntries/          # Journal entries subcollection
        â”‚   â””â”€â”€ {entryId}
        â”‚
        â”œâ”€â”€ insights/                # AI-generated insights
        â”‚   â””â”€â”€ {insightId}
        â”‚
        â””â”€â”€ conversations/           # AI chat conversations
            â””â”€â”€ {conversationId}
```

---

## User Document

**Path**: `users/{userId}`

### Fields

```javascript
{
  // Identity
  email: string,                    // User email
  displayName: string,              // User display name
  
  // Portfolio
  portfolio: {
    targetBalance: {
      builder: number,              // Target % for Builder (0-100)
      contributor: number,          // Target % for Contributor
      integrator: number,           // Target % for Integrator
      experimenter: number          // Target % for Experimenter
    },
    actualBalance: {
      builder: number,              // Calculated actual %
      contributor: number,
      integrator: number,
      experimenter: number
    },
    balanceScore: {
      score: number,                // 0-100 balance score
      drift: number,                // % deviation from target
      grade: string,                // A, B, C, or D
      status: string               // "Excellent", "Good", etc.
    },
    lastCalculated: string          // ISO timestamp
  },
  
  // Settings
  settings: {
    ai: {
      apiKey: string,               // Anthropic API key
      model: string                 // Claude model version
    },
    notifications: {
      enabled: boolean,
      frequency: string             // "realtime", "daily", "weekly"
    },
    display: {
      theme: string,                // "light" or "dark"
      compactMode: boolean
    }
  },
  
  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### Indexes
- `email` (for authentication)
- `createdAt` (for user queries)

---

## Projects Collection

**Path**: `users/{userId}/projects/{projectId}`

### Fields

```javascript
{
  // Basic Info
  name: string,                     // Project name
  description: string,              // Project description
  perspective: string,              // "builder", "contributor", "integrator", "experimenter"
  
  // Status
  status: string,                   // "active", "completed", "paused", "archived"
  
  // Details
  motivation: string,               // Why this project matters
  goals: string[],                  // Array of project goals
  tags: string[],                   // Custom tags
  
  // Metrics
  totalHoursLogged: number,         // Total hours spent
  targetHours: number,              // Target hours to complete
  
  // Visual
  color: string,                    // Hex color code
  icon: string,                     // Icon name (Lucide)
  
  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp,
  lastWorkedAt: timestamp           // Last time log entry
}
```

### Indexes
- `perspective` (for filtering)
- `status` (for active/completed queries)
- `lastWorkedAt` (for sorting by recency)
- `createdAt` (for chronological order)

### Example Document
```javascript
{
  name: "RetireWise Development",
  description: "Building an AI-powered portfolio management app",
  perspective: "builder",
  status: "active",
  motivation: "Create tool to help retirees find balance",
  goals: ["Launch MVP", "Get 100 users", "Add AI features"],
  tags: ["coding", "ai", "retirement"],
  totalHoursLogged: 124.5,
  targetHours: 200,
  color: "#3B82F6",
  icon: "Code",
  createdAt: "2024-01-15T10:00:00Z",
  updatedAt: "2024-12-28T14:30:00Z",
  lastWorkedAt: "2024-12-28T14:30:00Z"
}
```

---

## Time Logs Collection

**Path**: `users/{userId}/timeLogs/{logId}`

### Fields

```javascript
{
  // Reference
  projectId: string,                // Reference to project
  
  // Time
  date: string,                     // ISO date string
  duration: number,                 // Hours (can be decimal)
  
  // Activity
  activityType: string,             // Type of activity
  description: string,              // What was accomplished
  
  // Metrics
  energy: number,                   // 1-5 rating
  productivity: number,             // 1-5 rating
  enjoyment: number,                // 1-5 rating
  
  // Context
  location: string,                 // Where the work happened
  mood: string,                     // Emotional state
  
  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### Indexes
- `projectId` (for project-specific queries)
- `date` (descending, for chronological queries)
- Composite: `projectId + date` (for project timeline)

### Example Document
```javascript
{
  projectId: "proj_abc123",
  date: "2024-12-28T14:00:00Z",
  duration: 2.5,
  activityType: "Coding",
  description: "Implemented AI portfolio context features",
  energy: 4,
  productivity: 5,
  enjoyment: 5,
  location: "Home office",
  mood: "Focused",
  createdAt: "2024-12-28T16:30:00Z",
  updatedAt: "2024-12-28T16:30:00Z"
}
```

---

## Journal Entries Collection

**Path**: `users/{userId}/journalEntries/{entryId}`

### Fields

```javascript
{
  // Content
  title: string,                    // Entry title
  content: string,                  // Full entry text
  
  // Type
  entryType: string,                // "reflection", "milestone", "challenge", "idea"
  
  // References
  projectId: string,                // Associated project (optional)
  tags: string[],                   // Custom tags
  
  // Analysis
  sentiment: string,                // "positive", "neutral", "negative"
  
  // Timestamps
  date: string,                     // Entry date (ISO)
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### Indexes
- `date` (descending, for chronological order)
- `projectId` (for project-specific entries)
- `entryType` (for filtering by type)
- `tags` (array contains, for tag searches)

### Example Document
```javascript
{
  title: "Breakthrough with AI Integration",
  content: "Today I realized RetireWise could be the central hub...",
  entryType: "milestone",
  projectId: "proj_abc123",
  tags: ["ai", "vision", "breakthrough"],
  sentiment: "positive",
  date: "2024-12-28T20:00:00Z",
  createdAt: "2024-12-28T20:15:00Z",
  updatedAt: "2024-12-28T20:15:00Z"
}
```

---

## Insights Collection

**Path**: `users/{userId}/insights/{insightId}`

### Fields

```javascript
{
  // Content
  type: string,                     // "balance", "suggestion", "pattern", etc.
  title: string,                    // Insight headline
  description: string,              // Detailed explanation
  
  // Metadata
  confidence: number,               // 0.0-1.0 confidence score
  priority: string,                 // "critical", "high", "medium", "low"
  
  // Actions
  actionable: boolean,              // Can user act on this?
  suggestedActions: string[],       // List of suggested actions
  
  // State
  dismissed: boolean,               // Has user dismissed?
  dismissedAt: string,              // When dismissed (ISO)
  dismissReason: string,            // Why dismissed
  actedOn: boolean,                 // Has user acted?
  actedOnAt: string,                // When acted on
  
  // Feedback
  userFeedback: string,             // User's feedback
  
  // Context
  basedOn: object,                  // Data used to generate insight
  
  // Timestamps
  createdAt: timestamp,             // When generated
  lastShownAt: timestamp,           // Last time shown to user
  validUntil: string                // When insight expires (optional)
}
```

### Indexes
- `dismissed` (for active insights queries)
- `priority` (for sorting by importance)
- `createdAt` (descending, for recent insights)

### Example Document
```javascript
{
  type: "balance",
  title: "Portfolio Heavily Weighted Toward Builder",
  description: "You're spending 45% of your time on Builder projects...",
  confidence: 0.85,
  priority: "medium",
  actionable: true,
  suggestedActions: [
    "Review your portfolio balance",
    "Start a project in an underrepresented perspective"
  ],
  dismissed: false,
  dismissedAt: null,
  dismissReason: null,
  actedOn: false,
  actedOnAt: null,
  userFeedback: null,
  basedOn: {
    perspective: "builder",
    percentage: 45,
    totalHours: 124
  },
  createdAt: "2024-12-28T10:00:00Z",
  lastShownAt: "2024-12-28T10:00:00Z",
  validUntil: "2025-01-04T10:00:00Z"
}
```

---

## Conversations Collection

**Path**: `users/{userId}/conversations/{conversationId}`

### Fields

```javascript
{
  // Metadata
  title: string,                    // Conversation title
  conversationType: string,         // "general", "planning", "reflection"
  
  // Messages
  messages: array,                  // Array of message objects
  messageCount: number,             // Total messages
  
  // State
  archived: boolean,
  favorite: boolean,
  resolved: boolean,
  
  // Context
  actionItems: string[],            // Extracted action items
  tags: string[],                   // Topic tags
  
  // Timestamps
  startedAt: timestamp,
  lastMessageAt: timestamp,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### Message Object Structure
```javascript
{
  role: string,                     // "user" or "assistant"
  content: string,                  // Message text
  timestamp: string,                // ISO timestamp
  contextUsed: object,              // Context that informed response
  toolsUsed: string[]               // Tools AI used for this response
}
```

### Indexes
- `lastMessageAt` (descending, for recent conversations)
- `archived` (for filtering)
- `favorite` (for starred conversations)

### Example Document
```javascript
{
  title: "Portfolio Balance Discussion",
  conversationType: "general",
  messages: [
    {
      role: "user",
      content: "How balanced is my portfolio?",
      timestamp: "2024-12-28T15:00:00Z",
      contextUsed: null
    },
    {
      role: "assistant",
      content: "Your current balance score is 65/100...",
      timestamp: "2024-12-28T15:00:15Z",
      contextUsed: {
        balanceScore: 65,
        grade: "C"
      },
      toolsUsed: ["analyze_patterns"]
    }
  ],
  messageCount: 2,
  archived: false,
  favorite: false,
  resolved: false,
  actionItems: ["Reduce Builder time", "Increase Experimenter activities"],
  tags: ["balance", "planning"],
  startedAt: "2024-12-28T15:00:00Z",
  lastMessageAt: "2024-12-28T15:00:15Z",
  createdAt: "2024-12-28T15:00:00Z",
  updatedAt: "2024-12-28T15:00:15Z"
}
```

---

## Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User documents and all subcollections
    match /users/{userId} {
      // User can only access their own data
      allow read, write: if request.auth != null 
                         && request.auth.uid == userId;
      
      // Apply to all subcollections
      match /{document=**} {
        allow read, write: if request.auth != null 
                           && request.auth.uid == userId;
      }
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

---

## Data Relationships

```
User (1) â”€â”€â”€â”€â”€â”€â”€ (*) Projects
               â”‚
               â””â”€ (1) Project â”€â”€â”€â”€â”€â”€ (*) TimeLogs
                                   â”‚
                                   â””â”€ (*) JournalEntries
                                   â”‚
                                   â””â”€ Referenced in Insights
                                   â”‚
                                   â””â”€ Referenced in Conversations

User (1) â”€â”€â”€â”€â”€â”€â”€ (*) Insights
User (1) â”€â”€â”€â”€â”€â”€â”€ (*) Conversations
```

### Relationship Types
- **One-to-Many**: User â†’ Projects, TimeLogs, etc.
- **Soft References**: projectId fields link documents
- **No Foreign Key Enforcement**: Application-level integrity
- **Denormalization**: Project names stored in time logs for performance

---

## Calculated Fields

### Portfolio Balance
**Calculated from**: Time logs grouped by project perspective
**Stored in**: `users/{userId}/portfolio.actualBalance`
**Recalculated**: On demand via `calculatePortfolioBalance()`

```javascript
actualBalance: {
  builder: (builderHours / totalHours) * 100,
  contributor: (contributorHours / totalHours) * 100,
  integrator: (integratorHours / totalHours) * 100,
  experimenter: (experimenterHours / totalHours) * 100
}
```

### Balance Score
**Calculated from**: Deviation between actual and target balance
**Formula**: Graduated penalty system based on drift percentage

```javascript
drift = sum(|actual - target|) / 2
score = 100 - penalties(drift)
grade = scoreToGrade(score)
```

---

## Data Migration Scripts

### Initialize New User
```javascript
async function initializeUser(userId, email, displayName) {
  await setDoc(doc(db, 'users', userId), {
    email,
    displayName,
    portfolio: {
      targetBalance: {
        builder: 25,
        contributor: 25,
        integrator: 25,
        experimenter: 25
      },
      actualBalance: {
        builder: 0,
        contributor: 0,
        integrator: 0,
        experimenter: 0
      },
      balanceScore: {
        score: 100,
        drift: 0,
        grade: 'A',
        status: 'Excellent Balance'
      },
      lastCalculated: new Date().toISOString()
    },
    settings: {
      ai: { apiKey: '', model: 'claude-sonnet-4-20250514' },
      notifications: { enabled: true, frequency: 'daily' },
      display: { theme: 'light', compactMode: false }
    },
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
}
```

### Recalculate All Balances
```javascript
async function recalculateAllBalances(userId) {
  const balance = await calculatePortfolioBalance(userId);
  await updatePortfolio(userId, {
    actualBalance: balance.actualBalance,
    lastCalculated: new Date().toISOString()
  });
}
```

---

## Backup Strategy

### Firestore Automatic Backups
- Daily exports to Cloud Storage
- 30-day retention
- Region: Same as Firestore (multi-region)

### Manual Backup
```bash
# Export to JSON
gcloud firestore export gs://[BUCKET_NAME]

# Import from JSON
gcloud firestore import gs://[BUCKET_NAME]/[EXPORT_FOLDER]
```

---

## Performance Optimization

### Indexes Required
```javascript
// Projects
collection: projects
fields: [perspective ASC, createdAt DESC]

// Time Logs
collection: timeLogs
fields: [projectId ASC, date DESC]
fields: [date DESC]

// Insights
collection: insights
fields: [dismissed ASC, priority DESC, createdAt DESC]

// Conversations
collection: conversations
fields: [lastMessageAt DESC]
```

### Query Optimization Tips
- Use `limit()` for large collections
- Order by indexed fields
- Use `where()` before `orderBy()`
- Enable offline persistence
- Use real-time listeners sparingly

---

## Data Retention Policy

- **Time Logs**: Keep indefinitely (user history)
- **Journal Entries**: Keep indefinitely
- **Insights**: Delete after 90 days if dismissed
- **Conversations**: Keep last 50, archive older
- **Projects**: Keep even when completed (for analysis)

---

**For implementation details, see:**
- [API_REFERENCE.md](./API_REFERENCE.md) - Database function documentation
- [ARCHITECTURE.md](./ARCHITECTURE.md) - System architecture
- [CONTRIBUTING.md](./CONTRIBUTING.md) - Development guidelines
</file>

<file path="docs/DEPLOYMENT.md">
# RetireWise Deployment Guide

Complete guide for deploying RetireWise to production on Vercel.

---

## Prerequisites

- âœ… GitHub account
- âœ… Vercel account (free tier works)
- âœ… Firebase project with Firestore enabled
- âœ… Anthropic API key
- âœ… Code pushed to GitHub repository

---

## Quick Deployment (5 Minutes)

### Step 1: Push to GitHub

```bash
git add .
git commit -m "Ready for deployment"
git push origin main
```

### Step 2: Connect to Vercel

1. Go to [vercel.com](https://vercel.com)
2. Click "Add New..." â†’ "Project"
3. Import your GitHub repository
4. Vercel auto-detects Next.js configuration

### Step 3: Configure Environment Variables

Add these in Vercel dashboard â†’ Settings â†’ Environment Variables:

```env
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
NEXT_PUBLIC_ANTHROPIC_API_KEY=sk-ant-xxxxx
```

**Important:** Enable for all environments (Production, Preview, Development)

### Step 4: Deploy

Click "Deploy" and wait ~2 minutes.

âœ… **Done!** Your app is live at `your-project.vercel.app`

---

## Detailed Deployment Steps

### 1. Prepare Your Repository

#### Clean Up Development Files

Remove or gitignore:
```bash
# Add to .gitignore
.env.local
.next/
node_modules/
.vercel/
*.log
.DS_Store
```

#### Verify Build Locally

```bash
npm run build
npm start
```

Visit `http://localhost:3000` and test:
- [ ] Login/signup works
- [ ] Projects load
- [ ] Time logging works
- [ ] AI chat responds
- [ ] All pages render

---

### 2. Firebase Configuration

#### Enable Required Services

In Firebase Console:

1. **Authentication**
   - Enable Email/Password provider
   - Add authorized domain: `your-project.vercel.app`

2. **Firestore**
   - Create database (production mode)
   - Deploy security rules (see below)
   - Create indexes (auto-created on first query, or manually add)

3. **Firestore Rules**

Deploy these security rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User documents and subcollections
    match /users/{userId} {
      allow read, write: if request.auth != null 
                         && request.auth.uid == userId;
      
      match /{document=**} {
        allow read, write: if request.auth != null 
                           && request.auth.uid == userId;
      }
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

Deploy via Firebase Console â†’ Firestore â†’ Rules â†’ Publish

4. **Firestore Indexes**

These will be auto-created, but you can pre-create them:

```
Collection: projects
Fields: perspective (Ascending), createdAt (Descending)

Collection: timeLogs
Fields: date (Descending)

Collection: timeLogs
Fields: projectId (Ascending), date (Descending)

Collection: insights
Fields: dismissed (Ascending), priority (Descending), createdAt (Descending)

Collection: conversations
Fields: lastMessageAt (Descending)
```

---

### 3. Vercel Configuration

#### Project Settings

```javascript
// vercel.json (optional - Vercel auto-detects Next.js)
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["iad1"]  // US East (optional)
}
```

#### Environment Variables

| Variable | Value | Notes |
|----------|-------|-------|
| `NEXT_PUBLIC_FIREBASE_API_KEY` | From Firebase Console | Public |
| `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` | `project.firebaseapp.com` | Public |
| `NEXT_PUBLIC_FIREBASE_PROJECT_ID` | Your project ID | Public |
| `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET` | `project.appspot.com` | Public |
| `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID` | From Firebase | Public |
| `NEXT_PUBLIC_FIREBASE_APP_ID` | From Firebase | Public |
| `NEXT_PUBLIC_ANTHROPIC_API_KEY` | `sk-ant-xxxxx` | **Keep secret!** |

**Security Note:** Variables prefixed with `NEXT_PUBLIC_` are exposed to the client. The Anthropic API key will be visible in client code but should still be kept in env vars for easy rotation.

#### Build Settings

- **Framework Preset**: Next.js
- **Build Command**: `npm run build`
- **Output Directory**: `.next` (auto-detected)
- **Install Command**: `npm install`
- **Node Version**: 18.x (set in package.json or Vercel settings)

---

### 4. Domain Configuration (Optional)

#### Add Custom Domain

1. Go to Vercel dashboard â†’ Project â†’ Settings â†’ Domains
2. Add your domain (e.g., `retirewise.com`)
3. Update DNS records:

```
Type: A
Name: @
Value: 76.76.21.21

Type: CNAME
Name: www
Value: cname.vercel-dns.com
```

4. Wait for DNS propagation (5-30 minutes)

#### Update Firebase

Add custom domain to Firebase authorized domains:
1. Firebase Console â†’ Authentication â†’ Settings â†’ Authorized domains
2. Add: `retirewise.com` and `www.retirewise.com`

---

### 5. Post-Deployment Verification

#### Smoke Tests

Test these critical paths:

1. **Authentication**
   ```
   âœ“ Sign up with new email
   âœ“ Sign in with existing account
   âœ“ Sign out
   âœ“ Password reset (if implemented)
   ```

2. **Core Features**
   ```
   âœ“ Create a project
   âœ“ Log time
   âœ“ View portfolio dashboard
   âœ“ Check analytics
   âœ“ Open AI chat
   âœ“ Send message to AI
   ```

3. **Data Persistence**
   ```
   âœ“ Refresh page - data remains
   âœ“ Close and reopen tab - still logged in
   âœ“ Open in different browser - data syncs
   ```

4. **Performance**
   ```
   âœ“ Initial load < 3 seconds
   âœ“ Navigation is instant
   âœ“ AI response < 5 seconds
   ```

#### Monitor Errors

Check Vercel dashboard â†’ Project â†’ Logs for:
- Build errors
- Runtime errors
- API route errors

---

## Environment-Specific Configurations

### Development
```env
# .env.local
NEXT_PUBLIC_FIREBASE_PROJECT_ID=retirewise-dev
NEXT_PUBLIC_ANTHROPIC_API_KEY=sk-ant-dev-xxxxx
```

### Staging (Preview Deployments)
```env
# Vercel Preview environment
NEXT_PUBLIC_FIREBASE_PROJECT_ID=retirewise-staging
NEXT_PUBLIC_ANTHROPIC_API_KEY=sk-ant-staging-xxxxx
```

### Production
```env
# Vercel Production environment
NEXT_PUBLIC_FIREBASE_PROJECT_ID=retirewise-prod
NEXT_PUBLIC_ANTHROPIC_API_KEY=sk-ant-prod-xxxxx
```

**Best Practice:** Use separate Firebase projects for dev/staging/prod

---

## Continuous Deployment

### Automatic Deployments

Vercel automatically deploys:
- **Production**: Pushes to `main` branch
- **Preview**: Pushes to feature branches
- **Pull Request**: Each PR gets a preview URL

### Deployment Workflow

```
1. Developer pushes to feature branch
   â†“
2. Vercel builds preview deployment
   â†“
3. Preview URL generated (e.g., project-git-feature-username.vercel.app)
   â†“
4. Test preview deployment
   â†“
5. Merge PR to main
   â†“
6. Vercel deploys to production
   â†“
7. Live at your-project.vercel.app
```

### Build Hooks

Create a deploy hook for manual triggers:

1. Vercel â†’ Settings â†’ Git â†’ Deploy Hooks
2. Create hook â†’ Copy URL
3. Trigger deployment:

```bash
curl -X POST https://api.vercel.com/v1/integrations/deploy/...
```

---

## Performance Optimization

### Enable Caching

Vercel automatically caches:
- Static assets (images, CSS, JS)
- API routes with caching headers
- Server-rendered pages

Add caching headers to API routes:

```javascript
export async function GET(request) {
  return NextResponse.json(data, {
    headers: {
      'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=300'
    }
  });
}
```

### Image Optimization

Use Next.js Image component:

```javascript
import Image from 'next/image';

<Image 
  src="/logo.png" 
  width={200} 
  height={100}
  alt="RetireWise"
/>
```

Vercel automatically optimizes images on-demand.

### Analytics

Enable Vercel Analytics:
1. Project â†’ Analytics â†’ Enable
2. Add `<Analytics />` to root layout (optional)

```javascript
// app/layout.js
import { Analytics } from '@vercel/analytics/react';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
      </body>
    </html>
  );
}
```

---

## Monitoring & Debugging

### Vercel Logs

View logs in real-time:
```bash
vercel logs your-project.vercel.app
```

Or in Vercel dashboard â†’ Project â†’ Logs

### Error Tracking

Consider adding error tracking:

**Option 1: Sentry**
```bash
npm install @sentry/nextjs
```

**Option 2: LogRocket**
```bash
npm install logrocket
```

### Performance Monitoring

Use Vercel Speed Insights:
```bash
npm install @vercel/speed-insights
```

```javascript
import { SpeedInsights } from '@vercel/speed-insights/next';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <SpeedInsights />
      </body>
    </html>
  );
}
```

---

## Backup & Disaster Recovery

### Firestore Backups

#### Automated Backups

Set up scheduled exports:

1. Enable Cloud Scheduler API
2. Create export bucket:
```bash
gsutil mb gs://retirewise-backups
```

3. Schedule daily backup:
```bash
gcloud scheduler jobs create http firestore-export \
  --schedule="0 2 * * *" \
  --uri="https://firestore.googleapis.com/v1/projects/YOUR_PROJECT/databases/(default):exportDocuments" \
  --message-body='{
    "outputUriPrefix": "gs://retirewise-backups",
    "collectionIds": []
  }'
```

#### Manual Backup

```bash
gcloud firestore export gs://retirewise-backups/manual-backup-$(date +%Y%m%d)
```

### Code Backups

- GitHub repository (primary)
- Vercel keeps deployment history (last 100 deployments)

### Rollback

Instant rollback in Vercel:
1. Dashboard â†’ Deployments
2. Find previous working deployment
3. Click "..." â†’ Promote to Production

Or via CLI:
```bash
vercel rollback
```

---

## Security Best Practices

### Environment Variables
- âœ… Never commit `.env.local` to git
- âœ… Rotate API keys quarterly
- âœ… Use different keys for dev/staging/prod
- âœ… Limit API key permissions (if possible)

### Firebase Security
- âœ… Firestore rules enforce user isolation
- âœ… Enable App Check (for production)
- âœ… Monitor Firebase usage for anomalies
- âœ… Set up budget alerts

### Vercel Security
- âœ… Enable Vercel Authentication (if needed)
- âœ… Use environment-specific secrets
- âœ… Enable HTTPS only (automatic)
- âœ… Set up security headers:

```javascript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin'
          }
        ]
      }
    ];
  }
};
```

---

## Cost Optimization

### Vercel Pricing

**Hobby (Free):**
- âœ“ 100 GB bandwidth/month
- âœ“ Unlimited preview deployments
- âœ“ 6,000 build minutes/month
- âœ“ Perfect for personal projects

**Pro ($20/month):**
- Analytics
- Priority support
- Password protection
- 1TB bandwidth

### Firebase Pricing

**Spark (Free):**
- 50,000 reads/day
- 20,000 writes/day
- 1 GB storage
- Good for starting out

**Blaze (Pay-as-you-go):**
- $0.06 per 100,000 reads
- $0.18 per 100,000 writes
- $0.18/GB storage
- Typical cost: $5-20/month for small apps

### Anthropic Pricing

**Claude Sonnet 4:**
- Input: ~$3 per million tokens
- Output: ~$15 per million tokens

**Typical usage:**
- 1,000 messages/month â‰ˆ $6-10
- Set spending limits in Anthropic dashboard

---

## Troubleshooting

### Build Failures

**"Module not found"**
```bash
# Clear cache and reinstall
rm -rf .next node_modules package-lock.json
npm install
npm run build
```

**"Environment variable not defined"**
- Check Vercel dashboard â†’ Settings â†’ Environment Variables
- Ensure all `NEXT_PUBLIC_*` vars are set
- Redeploy after adding vars

### Runtime Errors

**"Firebase permission denied"**
- Verify Firestore rules are deployed
- Check user is authenticated
- Ensure userId matches document path

**"API key invalid"**
- Verify ANTHROPIC_API_KEY is correct
- Check for extra spaces/newlines
- Regenerate key if needed

### Performance Issues

**"Slow initial load"**
- Enable Vercel Analytics to identify bottlenecks
- Consider code splitting for large components
- Optimize images with Next.js Image

**"AI responses slow"**
- Check Anthropic API status
- Consider caching common prompts
- Reduce system prompt size

---

## Advanced Configuration

### Custom Build Command

```json
// package.json
{
  "scripts": {
    "build": "next build",
    "build:production": "NODE_ENV=production next build",
    "start": "next start -p 3000"
  }
}
```

### Edge Functions

Move API routes to Edge Runtime for lower latency:

```javascript
// app/api/chat/route.js
export const runtime = 'edge';

export async function POST(request) {
  // Your code here
}
```

### Middleware

Add global middleware:

```javascript
// middleware.js
import { NextResponse } from 'next/server';

export function middleware(request) {
  // Add custom headers, redirects, etc.
  return NextResponse.next();
}

export const config = {
  matcher: '/api/:path*'
};
```

---

## Checklist: Pre-Deployment

- [ ] All features tested locally
- [ ] Build succeeds without warnings
- [ ] Environment variables documented
- [ ] Firebase rules deployed
- [ ] Security rules tested
- [ ] Performance acceptable (< 3s load)
- [ ] Mobile responsive
- [ ] Error handling in place
- [ ] Backup strategy configured
- [ ] Monitoring set up

---

## Checklist: Post-Deployment

- [ ] All critical paths tested in production
- [ ] Custom domain configured (if applicable)
- [ ] Firebase authorized domains updated
- [ ] SSL certificate active
- [ ] Logs monitored for errors
- [ ] Performance metrics checked
- [ ] Backup verified
- [ ] Team notified
- [ ] Documentation updated

---

## Support & Resources

- **Vercel Docs**: https://vercel.com/docs
- **Next.js Docs**: https://nextjs.org/docs
- **Firebase Docs**: https://firebase.google.com/docs
- **Anthropic Docs**: https://docs.anthropic.com

---

**Your app is now live!** ğŸ‰

Monitor, iterate, and enjoy your deployed RetireWise application.
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/advisor/page.js">
import AIChat from '@/components/AIChat';

export default function AdvisorPage() {
  return <AIChat />;
}
</file>

<file path="src/app/api/chat/route.js">
import { NextResponse } from 'next/server';

export async function POST(request) {
  try {
    const body = await request.json();
    const { messages, tools, system } = body;  // Changed from req.body

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': process.env.ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4096,
        messages,
        tools,
        system
      })
    });

    const data = await response.json();
    return NextResponse.json(data);
  } catch (error) {
    console.error('Chat API error:', error);
    return NextResponse.json(
      { error: 'Failed to process chat request' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/dashboard/page.jsx">
// app/dashboard/page.jsx
import { InstallPrompt } from '@/components/InstallPrompt';

export default function Dashboard() {
  return (
    <>
      <InstallPrompt />
      {/* rest of your dashboard */}
    </>
  );
}
</file>

<file path="src/app/portfolio/page.js">
// src/app/portfolio/page.js
'use client';

import React from 'react';
import AppLayout from '@/components/AppLayout';
import PortfolioDashboard from '@/components/PortfolioDashboard';

export default function PortfolioPage() {
  return (
    <AppLayout>
      <PortfolioDashboard />
    </AppLayout>
  );
}
</file>

<file path="src/app/settings/page.js">
'use client';

import AppLayout from '@/components/AppLayout';
import AppSettings from '@/components/AppSettings';

export default function SettingsPage() {
  return (
    <AppLayout>
      <AppSettings />
    </AppLayout>
  );
}
</file>

<file path="src/app/test-migration/page.js">
'use client';

import { useState } from 'react';

export default function TestMigrationPage() {
  const [result, setResult] = useState(null);
  const [balance, setBalance] = useState(null);
  const [projects, setProjects] = useState(null);
  const [loading, setLoading] = useState(false);

  const runMigration = async () => {
    setLoading(true);
    try {
      const { runFullMigration } = await import('@/utils/migrateProjects');
      const migrationResult = await runFullMigration();
      setResult(migrationResult);
      
      await loadData();
    } catch (error) {
      console.error('Migration error:', error);
      setResult({ error: error.message });
    } finally {
      setLoading(false);
    }
  };

  const loadData = async () => {
    try {
      const unifiedDB = await import('@/db/unifiedDB');
      
      const [balanceData, projectsData] = await Promise.all([
        unifiedDB.calculatePortfolioBalance(),
        unifiedDB.getAllProjects()
      ]);
      
      setBalance(balanceData);
      setProjects(projectsData);
    } catch (error) {
      console.error('Load data error:', error);
    }
  };

  const testBalance = async () => {
    await loadData();
  };

  const debugData = async () => {
    const unifiedDB = await import('@/db/unifiedDB');
    
    const projects = await unifiedDB.getAllProjects();
    const timeLogs = await unifiedDB.getAllTimeLogs();
    
    console.log('=== DEBUG DATA ===');
    console.log('Projects:', projects.map(p => ({
      id: p.id,
      name: p.name,
      perspective: p.perspective,
      type: p.type
    })));
    
    console.log('Time Logs:', timeLogs.map(t => ({
      id: t.id,
      projectId: t.projectId,
      duration: t.duration,
      date: t.date
    })));
    
    const projectPerspectives = {};
    projects.forEach(p => {
      if (p.perspective) {
        projectPerspectives[p.id] = p.perspective;
        console.log(`Project ${p.name} (${p.id}) â†’ ${p.perspective}`);
      }
    });
    
    const perspectiveHours = {
      builder: 0,
      contributor: 0,
      integrator: 0,
      experimenter: 0
    };
    
    timeLogs.forEach(log => {
      const perspective = projectPerspectives[log.projectId];
      console.log(`Log for project ${log.projectId} â†’ perspective: ${perspective}, hours: ${log.duration}`);
      if (perspective && perspectiveHours[perspective] !== undefined) {
        perspectiveHours[perspective] += log.duration;
      }
    });
    
    console.log('Calculated perspective hours:', perspectiveHours);
    
    const totalHours = Object.values(perspectiveHours).reduce((sum, h) => sum + h, 0);
    console.log('Total hours:', totalHours);
  };

  const recalculatePortfolio = async () => {
    setLoading(true);
    try {
      const unifiedDB = await import('@/db/unifiedDB');
      
      const balance = await unifiedDB.calculatePortfolioBalance();
      console.log('Fresh calculation:', balance);
      
      let portfolio = await unifiedDB.getPortfolio();
      if (!portfolio) {
        portfolio = {
          targetBalance: {
            builder: 25,
            contributor: 25,
            integrator: 25,
            experimenter: 25
          }
        };
      }
      
      portfolio.actualBalance = balance.actualBalance;
      portfolio.totalHours = balance.totalHours;
      portfolio.perspectiveHours = balance.perspectiveHours;
      portfolio.lastCalculated = balance.lastCalculated;
      portfolio.updatedAt = new Date().toISOString();
      
      await unifiedDB.updatePortfolio(portfolio);
      
      console.log('âœ… Portfolio recalculated and saved');
      alert('âœ… Portfolio recalculated successfully!');
      
      await loadData();
    } catch (error) {
      console.error('Recalculation error:', error);
      alert('Error recalculating: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const cleanupOrphanedLogs = async () => {
    setLoading(true);
    try {
      const unifiedDB = await import('@/db/unifiedDB');
      
      const projects = await unifiedDB.getAllProjects();
      const timeLogs = await unifiedDB.getAllTimeLogs();
      
      const validProjectIds = new Set(projects.map(p => p.id));
      const orphanedLogs = timeLogs.filter(log => !validProjectIds.has(log.projectId));
      
      console.log('Found orphaned logs:', orphanedLogs.length);
      
      if (orphanedLogs.length === 0) {
        alert('No orphaned logs found! âœ…');
        setLoading(false);
        return;
      }
      
      const totalOrphanedHours = orphanedLogs.reduce((sum, log) => sum + log.duration, 0);
      const confirmed = window.confirm(
        `Found ${orphanedLogs.length} orphaned time logs (${totalOrphanedHours.toFixed(1)} hours).\n\n` +
        `These logs belong to deleted projects.\n\n` +
        `Delete these orphaned logs?`
      );
      
      if (!confirmed) {
        console.log('Cleanup cancelled by user');
        setLoading(false);
        return;
      }
      
      for (const log of orphanedLogs) {
        await unifiedDB.deleteTimeLog(log.id);
        console.log('Deleted orphaned log:', log.id);
      }
      
      alert(`âœ… Deleted ${orphanedLogs.length} orphaned logs (${totalOrphanedHours.toFixed(1)} hours)`);
      
      await loadData();
    } catch (error) {
      console.error('Cleanup error:', error);
      alert('Error during cleanup: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const reassignOrphanedLogs = async () => {
    setLoading(true);
    try {
      const unifiedDB = await import('@/db/unifiedDB');
      
      const projects = await unifiedDB.getAllProjects();
      const timeLogs = await unifiedDB.getAllTimeLogs();
      
      const validProjectIds = new Set(projects.map(p => p.id));
      const orphanedLogs = timeLogs.filter(log => !validProjectIds.has(log.projectId));
      
      if (orphanedLogs.length === 0) {
        alert('No orphaned logs found! âœ…');
        setLoading(false);
        return;
      }
      
      const projectList = projects.map((p, i) => `${i + 1}. ${p.name} (${p.perspective})`).join('\n');
      const selection = prompt(
        `Found ${orphanedLogs.length} orphaned time logs.\n\n` +
        `Which project should they be reassigned to?\n\n` +
        projectList +
        `\n\nEnter number (1-${projects.length}):`
      );
      
      if (!selection) {
        setLoading(false);
        return;
      }
      
      const index = parseInt(selection) - 1;
      if (index < 0 || index >= projects.length) {
        alert('Invalid selection');
        setLoading(false);
        return;
      }
      
      const targetProject = projects[index];
      
      for (const log of orphanedLogs) {
        await unifiedDB.updateTimeLog(log.id, {
          projectId: targetProject.id
        });
        console.log(`Reassigned log ${log.id} to ${targetProject.name}`);
      }
      
      alert(`âœ… Reassigned ${orphanedLogs.length} logs to ${targetProject.name}`);
      
      await loadData();
    } catch (error) {
      console.error('Reassign error:', error);
      alert('Error during reassign: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl font-bold mb-8">Phase 1 Migration Test</h1>
        
        <div className="space-y-4 mb-8">
          <div className="flex flex-wrap gap-3">
            <button
              onClick={runMigration}
              disabled={loading}
              className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
            >
              {loading ? 'Running...' : 'ğŸš€ Run Full Migration'}
            </button>

            <button
              onClick={testBalance}
              className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              ğŸ“Š Load Current Data
            </button>

            <button
              onClick={debugData}
              className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
            >
              ğŸ› Debug Data
            </button>

            <button
              onClick={recalculatePortfolio}
              disabled={loading}
              className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
            >
              ğŸ”„ Recalculate Portfolio
            </button>

            <button
              onClick={cleanupOrphanedLogs}
              disabled={loading}
              className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
            >
              ğŸ§¹ Clean Up Orphaned Logs
            </button>

            <button
              onClick={reassignOrphanedLogs}
              disabled={loading}
              className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50"
            >
              ğŸ”— Reassign Orphaned Logs
            </button>
          </div>
          
          <p className="text-sm text-gray-600">
            Use these tools to manage your portfolio data migration.
          </p>
        </div>

        {/* Migration Result */}
        {result && (
          <div className="mb-8 p-6 bg-white rounded-lg shadow">
            <h2 className="text-xl font-bold mb-4">Migration Result</h2>
            {result.error ? (
              <div className="text-red-600">
                <p className="font-semibold">Error:</p>
                <p>{result.error}</p>
              </div>
            ) : (
              <div className="space-y-2">
                <p>âœ… <strong>Projects migrated:</strong> {result.projects?.migrated || 0}</p>
                <p>â­ï¸ <strong>Projects skipped:</strong> {result.projects?.skipped || 0}</p>
                <p>ğŸ“Š <strong>Total projects:</strong> {result.projects?.total || 0}</p>
                <p className="mt-4">
                  {result.portfolio?.skipped 
                    ? 'â„¹ï¸ Portfolio already initialized' 
                    : 'âœ… Portfolio initialized'}
                </p>
              </div>
            )}
          </div>
        )}

        {/* Projects List */}
        {projects && (
          <div className="mb-8 p-6 bg-white rounded-lg shadow">
            <h2 className="text-xl font-bold mb-4">Projects ({projects.length})</h2>
            <div className="space-y-3">
              {projects.map(project => (
                <div key={project.id} className="p-4 bg-gray-50 rounded-lg">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-semibold">{project.name}</p>
                      <p className="text-sm text-gray-600">Type: {project.type}</p>
                    </div>
                    <div className="text-right">
                      {project.perspective ? (
                        <>
                          <p className="text-sm font-semibold text-green-600">
                            âœ… {project.perspective}
                          </p>
                          <p className="text-xs text-gray-500">
                            Alignment: {project.perspectiveAlignment}%
                          </p>
                        </>
                      ) : (
                        <p className="text-sm text-red-600">âŒ No perspective</p>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Portfolio Balance */}
        {balance && (
          <div className="p-6 bg-white rounded-lg shadow">
            <h2 className="text-xl font-bold mb-4">Portfolio Balance</h2>
            <div className="space-y-3">
              <div>
                <span className="font-semibold">Total Hours Logged:</span> {balance.totalHours.toFixed(1)}
              </div>
              <div>
                <h3 className="font-semibold mb-3 mt-4">Distribution:</h3>
                <div className="space-y-3">
                  <div>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-sm font-medium">ğŸ”¨ Builder</span>
                      <span className="text-sm font-semibold">{balance.actualBalance.builder.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div 
                        className="bg-blue-600 h-3 rounded-full transition-all" 
                        style={{ width: `${balance.actualBalance.builder}%` }}
                      />
                    </div>
                    <p className="text-xs text-gray-600 mt-1">
                      {balance.perspectiveHours.builder.toFixed(1)} hours
                    </p>
                  </div>

                  <div>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-sm font-medium">ğŸ¤ Contributor</span>
                      <span className="text-sm font-semibold">{balance.actualBalance.contributor.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div 
                        className="bg-green-600 h-3 rounded-full transition-all" 
                        style={{ width: `${balance.actualBalance.contributor}%` }}
                      />
                    </div>
                    <p className="text-xs text-gray-600 mt-1">
                      {balance.perspectiveHours.contributor.toFixed(1)} hours
                    </p>
                  </div>

                  <div>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-sm font-medium">ğŸ”„ Integrator</span>
                      <span className="text-sm font-semibold">{balance.actualBalance.integrator.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div 
                        className="bg-purple-600 h-3 rounded-full transition-all" 
                        style={{ width: `${balance.actualBalance.integrator}%` }}
                      />
                    </div>
                    <p className="text-xs text-gray-600 mt-1">
                      {balance.perspectiveHours.integrator.toFixed(1)} hours
                    </p>
                  </div>

                  <div>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-sm font-medium">ğŸ§ª Experimenter</span>
                      <span className="text-sm font-semibold">{balance.actualBalance.experimenter.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div 
                        className="bg-orange-600 h-3 rounded-full transition-all" 
                        style={{ width: `${balance.actualBalance.experimenter}%` }}
                      />
                    </div>
                    <p className="text-xs text-gray-600 mt-1">
                      {balance.perspectiveHours.experimenter.toFixed(1)} hours
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/timelogs/page.js">
'use client';

import AppLayout from '@/components/AppLayout';
import TimeLogsView from '@/components/TimeLogsView';

export default function TimeLogsPage() {
  return (
    <AppLayout>
      <TimeLogsView />
    </AppLayout>
  );
}
</file>

<file path="src/components/Auth/AuthScreen.js">
// src/components/Auth/AuthScreen.js
'use client';

import React, { useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { Mail, Lock, User, AlertCircle } from 'lucide-react';

const AuthScreen = () => {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [displayName, setDisplayName] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [resetSent, setResetSent] = useState(false);
  
  const { signup, login, resetPassword } = useAuth();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      if (isLogin) {
        await login(email, password);
      } else {
        if (!displayName.trim()) {
          throw new Error('Please enter your name');
        }
        await signup(email, password, displayName);
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleResetPassword = async () => {
    if (!email) {
      setError('Please enter your email address');
      return;
    }
    
    setError('');
    setLoading(true);
    
    try {
      await resetPassword(email);
      setResetSent(true);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        {/* Logo/Header */}
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-3xl mx-auto mb-4 flex items-center justify-center text-white font-bold text-3xl shadow-lg">
            R
          </div>
          <h1 className="text-3xl font-bold text-gray-900 mb-2">RetireWise</h1>
          <p className="text-gray-600">Your intelligent retirement portfolio advisor</p>
        </div>

        {/* Auth Card */}
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="flex gap-2 mb-6">
            <button
              onClick={() => {
                setIsLogin(true);
                setError('');
                setResetSent(false);
              }}
              className={`flex-1 py-3 rounded-xl font-semibold transition-colors ${
                isLogin
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              Login
            </button>
            <button
              onClick={() => {
                setIsLogin(false);
                setError('');
                setResetSent(false);
              }}
              className={`flex-1 py-3 rounded-xl font-semibold transition-colors ${
                !isLogin
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              Sign Up
            </button>
          </div>

          {error && (
            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-xl flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
              <p className="text-sm text-red-800">{error}</p>
            </div>
          )}

          {resetSent && (
            <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-xl">
              <p className="text-sm text-green-800">
                Password reset email sent! Check your inbox.
              </p>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            {!isLogin && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Your Name
                </label>
                <div className="relative">
                  <User className="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" />
                  <input
                    type="text"
                    value={displayName}
                    onChange={(e) => setDisplayName(e.target.value)}
                    placeholder="John Doe"
                    className="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required={!isLogin}
                  />
                </div>
              </div>
            )}

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Email
              </label>
              <div className="relative">
                <Mail className="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" />
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="you@example.com"
                  className="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Password
              </label>
              <div className="relative">
                <Lock className="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  className="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                  minLength={6}
                />
              </div>
              {!isLogin && (
                <p className="text-xs text-gray-500 mt-1">
                  At least 6 characters
                </p>
              )}
            </div>

            {isLogin && (
              <div className="text-right">
                <button
                  type="button"
                  onClick={handleResetPassword}
                  className="text-sm text-blue-600 hover:underline"
                  disabled={loading}
                >
                  Forgot password?
                </button>
              </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'Please wait...' : isLogin ? 'Login' : 'Create Account'}
            </button>
          </form>
        </div>

        {/* Footer */}
        <p className="text-center text-sm text-gray-600 mt-6">
          {isLogin ? "Don't have an account? " : 'Already have an account? '}
          <button
            onClick={() => {
              setIsLogin(!isLogin);
              setError('');
              setResetSent(false);
            }}
            className="text-blue-600 font-semibold hover:underline"
          >
            {isLogin ? 'Sign up' : 'Login'}
          </button>
        </p>
      </div>
    </div>
  );
};

export default AuthScreen;
</file>

<file path="src/components/BalanceChart.js">
// src/components/BalanceChart.js
'use client';

import React from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { PERSPECTIVES } from '@/utils/perspectiveHelpers';

const BalanceChart = ({ balance }) => {
  const data = Object.entries(balance.actualBalance).map(([key, value]) => ({
    name: PERSPECTIVES[key].label,
    value: value,
    icon: PERSPECTIVES[key].icon,
    color: PERSPECTIVES[key].color
  })).filter(item => item.value > 0); // Only show perspectives with hours

  const CustomTooltip = ({ active, payload }) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white px-3 py-2 rounded-lg shadow-lg border border-gray-200">
          <p className="font-semibold text-gray-800">
            {payload[0].payload.icon} {payload[0].name}
          </p>
          <p className="text-sm text-gray-600">
            {payload[0].value.toFixed(1)}%
          </p>
        </div>
      );
    }
    return null;
  };

  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
      <h3 className="text-lg font-semibold text-gray-800 mb-4">Current Distribution</h3>
      
      {data.length === 0 ? (
        <div className="flex items-center justify-center h-64">
          <p className="text-gray-500">No time logged yet</p>
        </div>
      ) : (
        <ResponsiveContainer width="100%" height={300}>
          <PieChart>
            <Pie
              data={data}
              cx="50%"
              cy="50%"
              innerRadius={60}
              outerRadius={100}
              paddingAngle={2}
              dataKey="value"
            >
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={entry.color} />
              ))}
            </Pie>
            <Tooltip content={<CustomTooltip />} />
            <Legend 
              verticalAlign="bottom" 
              height={36}
              formatter={(value, entry) => `${entry.payload.icon} ${value}`}
            />
          </PieChart>
        </ResponsiveContainer>
      )}
    </div>
  );
};

export default BalanceChart;
</file>

<file path="src/components/BalanceComparison.js">
// src/components/BalanceComparison.js
'use client';

import React from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { PERSPECTIVES } from '@/utils/perspectiveHelpers';

const BalanceComparison = ({ actualBalance, targetBalance }) => {
  const data = Object.keys(PERSPECTIVES).map(key => ({
    name: PERSPECTIVES[key].label,
    icon: PERSPECTIVES[key].icon,
    actual: actualBalance[key],
    target: targetBalance[key],
    color: PERSPECTIVES[key].color
  }));

  const CustomTooltip = ({ active, payload }) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white px-3 py-2 rounded-lg shadow-lg border border-gray-200">
          <p className="font-semibold text-gray-800 mb-1">
            {payload[0].payload.icon} {payload[0].payload.name}
          </p>
          <p className="text-sm text-blue-600">
            Actual: {payload[0].value.toFixed(1)}%
          </p>
          <p className="text-sm text-gray-600">
            Target: {payload[1].value.toFixed(1)}%
          </p>
        </div>
      );
    }
    return null;
  };

  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
      <h3 className="text-lg font-semibold text-gray-800 mb-4">Target vs Actual</h3>
      
      <ResponsiveContainer width="100%" height={300}>
        <BarChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
          <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
          <XAxis 
            dataKey="icon" 
            tick={{ fontSize: 20 }}
          />
          <YAxis 
            label={{ value: 'Percentage (%)', angle: -90, position: 'insideLeft' }}
          />
          <Tooltip content={<CustomTooltip />} />
          <Legend 
            wrapperStyle={{ paddingTop: '10px' }}
          />
          <Bar dataKey="actual" fill="#3B82F6" name="Actual" radius={[8, 8, 0, 0]} />
          <Bar dataKey="target" fill="#E5E7EB" name="Target" radius={[8, 8, 0, 0]} />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};

export default BalanceComparison;
</file>

<file path="src/components/JournalEntryForm.js">
// src/components/JournalEntryForm.js
'use client';

import React, { useState, useEffect } from 'react';
import { X, Save, Calendar, Tag, BookOpen, Smile, Meh, Frown } from 'lucide-react';
import * as unifiedDB from '@/db/unifiedDB';

const JournalEntryForm = ({ entry, onClose, onSaved }) => {
  const [formData, setFormData] = useState({
    title: '',
    content: '',
    entryType: 'general',
    date: new Date().toISOString(),
    projectId: null,
    tags: [],
    sentiment: 'neutral',
    favorite: false
  });
  const [tagInput, setTagInput] = useState('');
  const [projects, setProjects] = useState([]);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    loadProjects();
    
    if (entry) {
      setFormData({
        title: entry.title || '',
        content: entry.content || '',
        entryType: entry.entryType || 'general',
        date: entry.date || new Date().toISOString(),
        projectId: entry.projectId || null,
        tags: entry.tags || [],
        sentiment: entry.sentiment || 'neutral',
        favorite: entry.favorite || false
      });
    }
  }, [entry]);

  const loadProjects = async () => {
    try {
      const allProjects = await unifiedDB.getAllProjects();
      setProjects(allProjects);
    } catch (error) {
      console.error('Error loading projects:', error);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.content.trim()) {
      alert('Please write some content');
      return;
    }

    setSaving(true);
    
    try {
      if (entry) {
        // Update existing entry
        await unifiedDB.updateJournalEntry(entry.id, formData);
        console.log('âœ… Journal entry updated');
      } else {
        // Create new entry
        await unifiedDB.createJournalEntry(formData);
        console.log('âœ… Journal entry created');
      }
      
      onSaved();
      onClose();
    } catch (error) {
      console.error('Error saving journal entry:', error);
      alert('Failed to save journal entry');
    } finally {
      setSaving(false);
    }
  };

  const handleAddTag = () => {
    if (tagInput.trim() && !formData.tags.includes(tagInput.trim())) {
      setFormData({
        ...formData,
        tags: [...formData.tags, tagInput.trim()]
      });
      setTagInput('');
    }
  };

  const handleRemoveTag = (tagToRemove) => {
    setFormData({
      ...formData,
      tags: formData.tags.filter(tag => tag !== tagToRemove)
    });
  };

  const entryTypes = [
    { value: 'general', label: 'General', emoji: 'ğŸ“' },
    { value: 'reflection', label: 'Reflection', emoji: 'ğŸ’­' },
    { value: 'learning', label: 'Learning', emoji: 'ğŸ“š' },
    { value: 'decision', label: 'Decision', emoji: 'ğŸ¯' },
    { value: 'milestone', label: 'Milestone', emoji: 'ğŸ†' },
    { value: 'struggle', label: 'Struggle', emoji: 'ğŸ’ª' },
    { value: 'idea', label: 'Idea', emoji: 'ğŸ’¡' }
  ];

  return (
    <div className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-4">
      <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-xl">
        {/* Header */}
        <div className="p-6 border-b border-gray-200 flex items-center justify-between">
          <h2 className="text-xl font-bold text-gray-900">
            {entry ? 'Edit Entry' : 'New Journal Entry'}
          </h2>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-6 space-y-4">
          {/* Title (Optional) */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Title (Optional)
            </label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              placeholder="Give your entry a title..."
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* Entry Type */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Entry Type
            </label>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
              {entryTypes.map(type => (
                <button
                  key={type.value}
                  type="button"
                  onClick={() => setFormData({ ...formData, entryType: type.value })}
                  className={`p-3 rounded-lg border-2 transition-colors ${
                    formData.entryType === type.value
                      ? 'border-blue-500 bg-blue-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <span className="text-2xl mb-1 block">{type.emoji}</span>
                  <span className="text-xs font-medium">{type.label}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Content */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Content *
            </label>
            <textarea
              value={formData.content}
              onChange={(e) => setFormData({ ...formData, content: e.target.value })}
              placeholder="What's on your mind?"
              rows={8}
              required
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            />
          </div>

          {/* Project Link */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Link to Project (Optional)
            </label>
            <select
              value={formData.projectId || ''}
              onChange={(e) => setFormData({ ...formData, projectId: e.target.value || null })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">None</option>
              {projects.map(project => (
                <option key={project.id} value={project.id}>
                  {project.icon || 'ğŸ“'} {project.name}
                </option>
              ))}
            </select>
          </div>

          {/* Tags */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Tags
            </label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={tagInput}
                onChange={(e) => setTagInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddTag())}
                placeholder="Add a tag..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="button"
                onClick={handleAddTag}
                className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
              >
                Add
              </button>
            </div>
            {formData.tags.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {formData.tags.map((tag, idx) => (
                  <span
                    key={idx}
                    className="flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"
                  >
                    <Tag className="w-3 h-3" />
                    {tag}
                    <button
                      type="button"
                      onClick={() => handleRemoveTag(tag)}
                      className="ml-1 hover:text-blue-900"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>

          {/* Sentiment */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              How are you feeling?
            </label>
            <div className="grid grid-cols-3 gap-3">
              <button
                type="button"
                onClick={() => setFormData({ ...formData, sentiment: 'positive' })}
                className={`p-4 rounded-lg border-2 transition-colors ${
                  formData.sentiment === 'positive'
                    ? 'border-green-500 bg-green-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <Smile className={`w-8 h-8 mx-auto mb-1 ${
                  formData.sentiment === 'positive' ? 'text-green-600' : 'text-gray-400'
                }`} />
                <span className="text-xs font-medium">Positive</span>
              </button>
              <button
                type="button"
                onClick={() => setFormData({ ...formData, sentiment: 'neutral' })}
                className={`p-4 rounded-lg border-2 transition-colors ${
                  formData.sentiment === 'neutral'
                    ? 'border-gray-500 bg-gray-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <Meh className={`w-8 h-8 mx-auto mb-1 ${
                  formData.sentiment === 'neutral' ? 'text-gray-600' : 'text-gray-400'
                }`} />
                <span className="text-xs font-medium">Neutral</span>
              </button>
              <button
                type="button"
                onClick={() => setFormData({ ...formData, sentiment: 'negative' })}
                className={`p-4 rounded-lg border-2 transition-colors ${
                  formData.sentiment === 'negative'
                    ? 'border-red-500 bg-red-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <Frown className={`w-8 h-8 mx-auto mb-1 ${
                  formData.sentiment === 'negative' ? 'text-red-600' : 'text-gray-400'
                }`} />
                <span className="text-xs font-medium">Negative</span>
              </button>
            </div>
          </div>

          {/* Date */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Date
            </label>
            <input
              type="datetime-local"
              value={new Date(formData.date).toISOString().slice(0, 16)}
              onChange={(e) => setFormData({ ...formData, date: new Date(e.target.value).toISOString() })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </form>

        {/* Footer */}
        <div className="p-6 border-t border-gray-200 flex gap-3">
          <button
            type="button"
            onClick={onClose}
            className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving}
            className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {saving ? (
              <>
                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                Saving...
              </>
            ) : (
              <>
                <Save className="w-5 h-5" />
                {entry ? 'Update' : 'Save'} Entry
              </>
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

export default JournalEntryForm;
</file>

<file path="src/components/PerspectiveAnalytics.js">
// src/components/PerspectiveAnalytics.js
'use client';

import React, { useState, useEffect } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from 'recharts';
import * as unifiedDB from '@/db/unifiedDB';
import { PERSPECTIVES, getAllPerspectives } from '@/utils/perspectiveHelpers';

const PerspectiveAnalytics = () => {
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState(null);
  const [balance, setBalance] = useState(null);
  const [timeLogs, setTimeLogs] = useState([]);
  const [projects, setProjects] = useState([]);

  useEffect(() => {
    loadAnalytics();
  }, []);

  const loadAnalytics = async () => {
    try {
      const [statsData, balanceData, logsData, projectsData] = await Promise.all([
        unifiedDB.getPerspectiveStats(),
        unifiedDB.calculatePortfolioBalance(),
        unifiedDB.getAllTimeLogs(),
        unifiedDB.getAllProjects()
      ]);

      setStats(statsData);
      setBalance(balanceData);
      setTimeLogs(logsData);
      setProjects(projectsData);
    } catch (error) {
      console.error('Error loading analytics:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  // Prepare data for charts
  const perspectives = getAllPerspectives();
  
  const perspectiveData = perspectives.map(p => ({
    name: p.label,
    icon: p.icon,
    hours: stats[p.id].hours,
    projects: stats[p.id].count,
    color: p.color
  }));

  // Calculate weekly trends
  const getWeeklyTrends = () => {
    const now = new Date();
    const weeks = [];
    
    for (let i = 3; i >= 0; i--) {
      const weekEnd = new Date(now);
      weekEnd.setDate(weekEnd.getDate() - (i * 7));
      const weekStart = new Date(weekEnd);
      weekStart.setDate(weekStart.getDate() - 7);
      
      const weekData = {
        week: `Week ${4 - i}`,
        builder: 0,
        contributor: 0,
        integrator: 0,
        experimenter: 0
      };
      
      timeLogs.forEach(log => {
        const logDate = new Date(log.date);
        if (logDate >= weekStart && logDate < weekEnd) {
          const project = projects.find(p => p.id === log.projectId);
          if (project && project.perspective) {
            weekData[project.perspective] += log.duration;
          }
        }
      });
      
      weeks.push(weekData);
    }
    
    return weeks;
  };

  const weeklyTrends = getWeeklyTrends();

  const CustomTooltip = ({ active, payload }) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white px-4 py-2 rounded-lg shadow-lg border border-gray-200">
          <p className="font-semibold text-gray-800 mb-1">{payload[0].payload.name}</p>
          {payload.map((entry, index) => (
            <p key={index} className="text-sm" style={{ color: entry.color }}>
              {entry.name}: {entry.value.toFixed(1)}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  return (
    <div className="space-y-6">
{/* Summary Cards - STACKED LAYOUT */}
<div className="space-y-3">
  {perspectives.map((perspective) => {
    const data = stats[perspective.id];
    return (
      <div
        key={perspective.id}
        className="bg-white rounded-xl p-4 shadow-sm border-2"
        style={{ borderLeftColor: perspective.color, borderLeftWidth: '4px' }}
      >
        {/* Row 1: Icon + Name */}
        <div className="flex items-center gap-3 mb-3">
          <span className="text-2xl">{perspective.icon}</span>
          <h3 className="font-semibold text-gray-800 text-lg">{perspective.label}</h3>
        </div>

        {/* Row 2: Headings */}
        <div className="flex items-center gap-8 mb-1">
          <p className="text-xs text-gray-600 w-24">Hours</p>
          <p className="text-xs text-gray-600 w-24">Projects</p>
          <p className="text-xs text-gray-600 w-24">Portfolio</p>
        </div>

        {/* Row 3: Numbers */}
        <div className="flex items-center gap-8">
          <p className="text-2xl font-bold text-gray-800 w-24">{data.hours.toFixed(1)}</p>
          <p className="text-2xl font-bold text-gray-800 w-24">{data.count}</p>
          <p className="text-2xl font-bold w-24" style={{ color: perspective.color }}>
            {balance.actualBalance[perspective.id].toFixed(1)}%
          </p>
        </div>
      </div>
    );
  })}
</div>

      {/* Hours by Perspective Chart */}
      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">Hours by Perspective</h3>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={perspectiveData}>
            <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
            <XAxis 
              dataKey="icon" 
              tick={{ fontSize: 20 }}
            />
            <YAxis label={{ value: 'Hours', angle: -90, position: 'insideLeft' }} />
            <Tooltip content={<CustomTooltip />} />
            <Bar dataKey="hours" name="Hours" radius={[8, 8, 0, 0]}>
              {perspectiveData.map((entry, index) => (
                <Bar key={`cell-${index}`} dataKey="hours" fill={entry.color} />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      </div>

      {/* Weekly Trends */}
      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">4-Week Trend by Perspective</h3>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={weeklyTrends}>
            <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
            <XAxis dataKey="week" />
            <YAxis label={{ value: 'Hours', angle: -90, position: 'insideLeft' }} />
            <Tooltip content={<CustomTooltip />} />
            <Legend />
            <Line 
              type="monotone" 
              dataKey="builder" 
              name="ğŸ”¨ Builder" 
              stroke={PERSPECTIVES.builder.color} 
              strokeWidth={2}
            />
            <Line 
              type="monotone" 
              dataKey="contributor" 
              name="ğŸ¤ Contributor" 
              stroke={PERSPECTIVES.contributor.color} 
              strokeWidth={2}
            />
            <Line 
              type="monotone" 
              dataKey="integrator" 
              name="ğŸ”„ Integrator" 
              stroke={PERSPECTIVES.integrator.color} 
              strokeWidth={2}
            />
            <Line 
              type="monotone" 
              dataKey="experimenter" 
              name="ğŸ§ª Experimenter" 
              stroke={PERSPECTIVES.experimenter.color} 
              strokeWidth={2}
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Projects by Perspective */}
      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">Projects by Perspective</h3>
        <div className="space-y-4">
          {perspectives.map((perspective) => {
            const perspectiveProjects = projects.filter(p => p.perspective === perspective.id);
            return (
              <div key={perspective.id} className="border-l-4 pl-4" style={{ borderColor: perspective.color }}>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <span className="text-xl">{perspective.icon}</span>
                    <h4 className="font-semibold text-gray-800">{perspective.label}</h4>
                  </div>
                  <span className="text-sm text-gray-500">{perspectiveProjects.length} projects</span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {perspectiveProjects.map((project) => (
                    <div
                      key={project.id}
                      className="inline-flex items-center gap-1 px-3 py-1 bg-gray-50 rounded-full text-sm"
                    >
                      {project.icon && <span>{project.icon}</span>}
                      <span className="text-gray-700">{project.name}</span>
                      <span className="text-gray-400 text-xs">
                        ({project.totalHoursLogged?.toFixed(1) || 0}h)
                      </span>
                    </div>
                  ))}
                  {perspectiveProjects.length === 0 && (
                    <p className="text-sm text-gray-400 italic">No projects yet</p>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

export default PerspectiveAnalytics;
</file>

<file path="src/components/PerspectiveCard.js">
// src/components/PerspectiveCard.js
'use client';

import React from 'react';
import { ArrowRight } from 'lucide-react';
import { useRouter } from 'next/navigation';

const PerspectiveCard = ({ perspective, stats, actualPercentage, targetPercentage }) => {
  const router = useRouter();
  
  const deviation = actualPercentage - targetPercentage;
  const isUnderrepresented = deviation < -10;
  const isOverrepresented = deviation > 10;

  const handleClick = () => {
    // Navigate to projects filtered by this perspective
    router.push(`/projects?perspective=${perspective.id}`);
  };

  return (
    <div 
      className="bg-white rounded-xl p-5 shadow-sm border-2 border-gray-100 hover:border-gray-300 transition-all cursor-pointer"
      onClick={handleClick}
      style={{ borderTopColor: perspective.color, borderTopWidth: '4px' }}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-3xl">{perspective.icon}</span>
          <div>
            <h3 className="font-semibold text-gray-800">{perspective.label}</h3>
          </div>
        </div>
        <ArrowRight className="w-4 h-4 text-gray-400" />
      </div>

      {/* Stats */}
      <div className="space-y-3">
        {/* Hours & Projects */}
        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">Hours:</span>
          <span className="font-semibold text-gray-800">{stats.hours.toFixed(1)}h</span>
        </div>
        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">Projects:</span>
          <span className="font-semibold text-gray-800">{stats.count}</span>
        </div>

        {/* Progress Bar */}
        <div className="pt-2">
          <div className="flex items-center justify-between text-xs mb-1">
            <span className="text-gray-500">Current</span>
            <span className="font-semibold" style={{ color: perspective.color }}>
              {actualPercentage.toFixed(1)}%
            </span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div
              className="h-2 rounded-full transition-all"
              style={{
                width: `${actualPercentage}%`,
                backgroundColor: perspective.color
              }}
            />
          </div>
          <div className="flex items-center justify-between text-xs mt-1">
            <span className="text-gray-400">Target: {targetPercentage}%</span>
            {Math.abs(deviation) > 5 && (
              <span className={`font-medium ${deviation > 0 ? 'text-orange-600' : 'text-blue-600'}`}>
                {deviation > 0 ? '+' : ''}{deviation.toFixed(0)}%
              </span>
            )}
          </div>
        </div>

        {/* Status Badge */}
        {isUnderrepresented && (
          <div className="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full text-center">
            Underrepresented
          </div>
        )}
        {isOverrepresented && (
          <div className="bg-orange-50 text-orange-700 text-xs px-2 py-1 rounded-full text-center">
            Overrepresented
          </div>
        )}
      </div>
    </div>
  );
};

export default PerspectiveCard;
</file>

<file path="src/components/QuickTimeLog.js">
// src/components/QuickTimeLog.js
'use client';

import React, { useState } from 'react';
import { Clock } from 'lucide-react';
import TimeLogForm from '@/components/TimeLogForm';

const QuickTimeLog = ({ projectId = null }) => {
  const [showForm, setShowForm] = useState(false);

  return (
    <>
      <button
        onClick={() => setShowForm(true)}
        className="fixed bottom-36 right-6 w-12 h-12 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 transition-all hover:scale-110 flex items-center justify-center z-40"
        title="Quick time log"
      >
        <Clock className="w-5 h-5" />
      </button>

      {showForm && (
        <TimeLogForm
          preselectedProjectId={projectId}
          onClose={() => setShowForm(false)}
          onSaved={() => {
            setShowForm(false);
            // Optionally trigger a refresh of parent component
            window.dispatchEvent(new Event('timeLogAdded'));
          }}
        />
      )}
    </>
  );
};

export default QuickTimeLog;
</file>

<file path="src/components/RecentActivityByPerspective.js">
// src/components/RecentActivityByPerspective.js
'use client';

import React from 'react';
import { PERSPECTIVES } from '@/utils/perspectiveHelpers';
import { Clock } from 'lucide-react';

const RecentActivityByPerspective = ({ projects }) => {
  // Group projects by perspective
  const projectsByPerspective = projects.reduce((acc, project) => {
    if (project.perspective) {
      if (!acc[project.perspective]) {
        acc[project.perspective] = [];
      }
      acc[project.perspective].push(project);
    }
    return acc;
  }, {});

  // Sort by last worked date
  Object.keys(projectsByPerspective).forEach(key => {
    projectsByPerspective[key].sort((a, b) => {
      const dateA = a.lastWorkedAt ? new Date(a.lastWorkedAt) : new Date(0);
      const dateB = b.lastWorkedAt ? new Date(b.lastWorkedAt) : new Date(0);
      return dateB - dateA;
    });
  });

  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
      <h3 className="text-lg font-semibold text-gray-800 mb-4">Projects by Perspective</h3>
      
      <div className="space-y-4">
        {Object.values(PERSPECTIVES).map(perspective => {
          const perspectiveProjects = projectsByPerspective[perspective.id] || [];
          
          return (
            <div key={perspective.id} className="border-l-4 pl-4" style={{ borderColor: perspective.color }}>
              <div className="flex items-center gap-2 mb-2">
                <span className="text-xl">{perspective.icon}</span>
                <h4 className="font-semibold text-gray-800">{perspective.label}</h4>
                <span className="text-sm text-gray-500">({perspectiveProjects.length})</span>
              </div>
              
              {perspectiveProjects.length === 0 ? (
                <p className="text-sm text-gray-400 ml-7">No projects yet</p>
              ) : (
                <div className="space-y-2 ml-7">
                  {perspectiveProjects.slice(0, 3).map(project => (
                    <div key={project.id} className="flex items-center justify-between text-sm">
                      <div className="flex items-center gap-2">
                        {project.icon && <span>{project.icon}</span>}
                        <span className="text-gray-700">{project.name}</span>
                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                          project.status === 'active' ? 'bg-green-100 text-green-700' :
                          project.status === 'planning' ? 'bg-blue-100 text-blue-700' :
                          project.status === 'paused' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {project.status}
                        </span>
                      </div>
                      {project.lastWorkedAt && (
                        <div className="flex items-center gap-1 text-gray-400">
                          <Clock className="w-3 h-3" />
                          <span className="text-xs">
                            {new Date(project.lastWorkedAt).toLocaleDateString()}
                          </span>
                        </div>
                      )}
                    </div>
                  ))}
                  {perspectiveProjects.length > 3 && (
                    <p className="text-xs text-gray-400">
                      +{perspectiveProjects.length - 3} more
                    </p>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
};

export default RecentActivityByPerspective;
</file>

<file path="src/components/TimeLogForm.js">
// src/components/TimeLogForm.js
'use client';

import React, { useState, useEffect } from 'react';
import { X, Clock, Calendar, Zap, TrendingUp, Smile } from 'lucide-react';
import * as unifiedDB from '@/db/unifiedDB';
import { format } from 'date-fns';

const TimeLogForm = ({ log, onClose, onSaved, preselectedProjectId = null }) => {
  const isEdit = !!log;
  
  const [formData, setFormData] = useState({
    projectId: preselectedProjectId || '',
    date: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
    duration: '',
    activityType: 'coding',
    description: '',
    energyLevel: null,
    productivityFeeling: null,
    enjoymentLevel: null,
    location: '',
    notes: ''
  });
  
  const [projects, setProjects] = useState([]);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    loadProjects();
    
    if (log) {
      setFormData({
        projectId: log.projectId || '',
        date: log.date ? format(new Date(log.date), "yyyy-MM-dd'T'HH:mm") : format(new Date(), "yyyy-MM-dd'T'HH:mm"),
        duration: log.duration || '',
        activityType: log.activityType || 'coding',
        description: log.description || '',
        energyLevel: log.energyLevel || null,
        productivityFeeling: log.productivityFeeling || null,
        enjoymentLevel: log.enjoymentLevel || null,
        location: log.location || '',
        notes: log.notes || ''
      });
    }
  }, [log]);

  const loadProjects = async () => {
    const allProjects = await unifiedDB.getAllProjects();
    setProjects(allProjects);
  };

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.projectId || !formData.duration) return;
    
    setSaving(true);

    try {
      const logData = {
        ...formData,
        date: new Date(formData.date).toISOString(),
        duration: parseFloat(formData.duration)
      };

      if (isEdit) {
        await unifiedDB.updateTimeLog(log.id, logData);
      } else {
        await unifiedDB.createTimeLog(logData);
      }

      onSaved();
      onClose();
    } catch (error) {
      console.error('Error saving time log:', error);
      alert('Failed to save time log');
    } finally {
      setSaving(false);
    }
  };

  const activityTypes = [
    { value: 'coding', label: 'Coding' },
    { value: 'planning', label: 'Planning' },
    { value: 'learning', label: 'Learning' },
    { value: 'meeting', label: 'Meeting' },
    { value: 'writing', label: 'Writing' },
    { value: 'testing', label: 'Testing' },
    { value: 'research', label: 'Research' },
    { value: 'other', label: 'Other' }
  ];

  const RatingButtons = ({ value, onChange, icon: Icon, label }) => (
    <div>
      <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
        <Icon className="w-4 h-4" />
        {label}
      </label>
      <div className="flex gap-2">
        {[1, 2, 3, 4, 5].map(rating => (
          <button
            key={rating}
            type="button"
            onClick={() => onChange(value === rating ? null : rating)}
            className={`flex-1 py-2 rounded-lg border-2 transition-colors ${
              value === rating
                ? 'border-blue-600 bg-blue-50 text-blue-700 font-semibold'
                : 'border-gray-200 hover:border-gray-300 text-gray-600'
            }`}
          >
            {rating}
          </button>
        ))}
      </div>
    </div>
  );

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-4">
      <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
            <Clock className="w-6 h-6" />
            {isEdit ? 'Edit Time Log' : 'Log Time'}
          </h2>
          <button 
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <X className="w-6 h-6 text-gray-600" />
          </button>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="p-6 space-y-6">
          {/* Project Selection */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Project *
            </label>
            <select
              value={formData.projectId}
              onChange={(e) => handleChange('projectId', e.target.value)}
              required
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select a project...</option>
              {projects.map((project) => (
                <option key={project.id} value={project.id}>
                  {project.icon || 'ğŸ“'} {project.name}
                </option>
              ))}
            </select>
          </div>

          {/* Date & Time */}
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Date & Time *
              </label>
              <input
                type="datetime-local"
                value={formData.date}
                onChange={(e) => handleChange('date', e.target.value)}
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Duration (hours) *
              </label>
              <input
                type="number"
                value={formData.duration}
                onChange={(e) => handleChange('duration', e.target.value)}
                required
                min="0.25"
                step="0.25"
                placeholder="e.g., 2.5"
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>

          {/* Activity Type */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Activity Type
            </label>
            <select
              value={formData.activityType}
              onChange={(e) => handleChange('activityType', e.target.value)}
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              {activityTypes.map((type) => (
                <option key={type.value} value={type.value}>
                  {type.label}
                </option>
              ))}
            </select>
          </div>

          {/* Description */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              What did you work on?
            </label>
            <textarea
              value={formData.description}
              onChange={(e) => handleChange('description', e.target.value)}
              placeholder="Brief description of what you accomplished..."
              rows="3"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            />
          </div>

          {/* Ratings */}
          <div className="space-y-4 bg-gray-50 rounded-xl p-4">
            <h3 className="text-sm font-semibold text-gray-700">How did it feel? (Optional)</h3>
            
            <RatingButtons
              value={formData.energyLevel}
              onChange={(val) => handleChange('energyLevel', val)}
              icon={Zap}
              label="Energy Level"
            />
            
            <RatingButtons
              value={formData.productivityFeeling}
              onChange={(val) => handleChange('productivityFeeling', val)}
              icon={TrendingUp}
              label="Productivity"
            />
            
            <RatingButtons
              value={formData.enjoymentLevel}
              onChange={(val) => handleChange('enjoymentLevel', val)}
              icon={Smile}
              label="Enjoyment"
            />
          </div>

          {/* Location */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Location (optional)
            </label>
            <input
              type="text"
              value={formData.location}
              onChange={(e) => handleChange('location', e.target.value)}
              placeholder="e.g., home, coffee shop, office"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Additional Notes (optional)
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => handleChange('notes', e.target.value)}
              placeholder="Any other observations or context..."
              rows="2"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            />
          </div>

          {/* Submit Buttons */}
          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={saving || !formData.projectId || !formData.duration}
              className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {saving ? 'Saving...' : isEdit ? 'Save Changes' : 'Log Time'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default TimeLogForm;
</file>

<file path="src/contexts/AuthContext.js">
// src/contexts/AuthContext.js
'use client';

import React, { createContext, useContext, useState, useEffect } from 'react';
import { 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  sendPasswordResetEmail,
  updateProfile
} from 'firebase/auth';
import { auth } from '@/config/firebase';

const AuthContext = createContext();

// Custom hook to use auth context
export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

export function AuthProvider({ children }) {
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Sign up new user
  async function signup(email, password, displayName) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      
      // Set display name
      if (displayName) {
        await updateProfile(userCredential.user, { displayName });
      }
      
      console.log('âœ… User created:', userCredential.user.uid);
      return userCredential.user;
    } catch (error) {
      console.error('âŒ Signup error:', error);
      setError(error.message);
      throw error;
    }
  }

  // Sign in existing user
  async function login(email, password) {
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      console.log('âœ… User logged in:', userCredential.user.uid);
      return userCredential.user;
    } catch (error) {
      console.error('âŒ Login error:', error);
      setError(error.message);
      throw error;
    }
  }

  // Sign out
  async function logout() {
    try {
      await signOut(auth);
      console.log('âœ… User logged out');
    } catch (error) {
      console.error('âŒ Logout error:', error);
      setError(error.message);
      throw error;
    }
  }

  // Reset password
  async function resetPassword(email) {
    try {
      await sendPasswordResetEmail(auth, email);
      console.log('âœ… Password reset email sent');
    } catch (error) {
      console.error('âŒ Password reset error:', error);
      setError(error.message);
      throw error;
    }
  }

  // Update user profile
  async function updateUserProfile(updates) {
    try {
      await updateProfile(auth.currentUser, updates);
      console.log('âœ… Profile updated');
    } catch (error) {
      console.error('âŒ Profile update error:', error);
      setError(error.message);
      throw error;
    }
  }

  // Listen for auth state changes
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setCurrentUser(user);
      setLoading(false);
      
      if (user) {
        console.log('ğŸ‘¤ Auth state: Logged in as', user.email);
      } else {
        console.log('ğŸ‘¤ Auth state: Logged out');
      }
    });

    // Cleanup subscription
    return unsubscribe;
  }, []);

  const value = {
    currentUser,
    loading,
    error,
    signup,
    login,
    logout,
    resetPassword,
    updateUserProfile
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

export default AuthContext;
</file>

<file path="src/lib/ai-prompt-generator.js">
// src/lib/ai-prompt-generator.js
/**
 * Generate portfolio-aware system prompt for Claude
 * (Copy from previous artifact or use this simplified version)
 */

export function generatePortfolioAwarePrompt(portfolioData) {
  const {
    actualBalance = { builder: 25, contributor: 25, integrator: 25, experimenter: 25 },
    targetBalance = { builder: 25, contributor: 25, integrator: 25, experimenter: 25 },
    balanceScore = { score: 100, drift: 0, grade: 'A', status: 'Excellent Balance' },
    totalHours = 0,
    activeProjects = 0,
    userName = 'User'
  } = portfolioData;

  const perspectives = ['builder', 'contributor', 'integrator', 'experimenter'];
  
  const perspectiveDetails = perspectives
    .map(p => {
      const actual = Math.round(actualBalance[p] || 0);
      const target = Math.round(targetBalance[p] || 0);
      const deviation = actual - target;
      const deviationText = deviation > 0 
        ? `+${deviation}% (overweight)`
        : deviation < 0 
        ? `${deviation}% (underweight)`
        : 'on target';
      
      return `  â€¢ ${capitalize(p)}: ${actual}% current vs ${target}% target (${deviationText})`;
    })
    .join('\n');

  return `You are an AI advisor for RetireWise, a retirement portfolio management app that helps users balance their time across four perspectives of fulfillment:

**THE FOUR PERSPECTIVES:**

1. **Builder** - Creating new things, entrepreneurship, building projects from scratch
2. **Contributor** - Adding value to existing systems, helping others, mentorship
3. **Integrator** - Connecting ideas/people, facilitating collaboration, synthesis
4. **Experimenter** - Trying new things, learning, exploration without specific outcomes

---

**${userName.toUpperCase()}'S CURRENT PORTFOLIO STATUS:**

Balance Score: ${balanceScore.score}/100 (Grade: ${balanceScore.grade} - ${balanceScore.status})
Portfolio Drift: ${balanceScore.drift}% from target allocation
Total Time Tracked: ${totalHours} hours
Active Projects: ${activeProjects}

**Perspective Breakdown:**
${perspectiveDetails}

---

**YOUR ROLE:**

Provide thoughtful, balanced advice about portfolio management considering the user's current allocation and goals. When the user asks for advice:

1. **Be perspective-aware**: Acknowledge their current balance (or imbalance)
2. **Suggest concrete actions**: Recommend specific activities aligned with underweight perspectives
3. **Explain the "why"**: Help them understand benefits of balanced engagement
4. **Be encouraging**: Celebrate progress toward balance, don't be judgmental about imbalances
5. **Context matters**: Consider their total time commitment and life circumstances

**Balance Guidelines:**
- Drift <5%: Excellent balance, maintain current approach
- Drift 5-10%: Good balance, minor adjustments helpful
- Drift 10-15%: Moderate imbalance, suggest rebalancing over next 2-4 weeks
- Drift >15%: Significant imbalance, recommend focused rebalancing plan

Remember: The goal is sustainable fulfillment in retirement, not perfect mathematical balance. Help them find their own optimal mix.`;
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
</file>

<file path="src/lib/balance-calculator.js">
/**
 * Calculate portfolio balance score (0-100) based on deviation from target allocation
 * Uses industry-standard drift calculation with graduated penalty system
 * 
 * @param {Object} actual - Current allocation {builder: 30, contributor: 20, integrator: 35, experimenter: 15}
 * @param {Object} target - Target allocation {builder: 25, contributor: 25, integrator: 25, experimenter: 25}
 * @returns {Object} - {score, drift, deviations, grade, recommendations}
 */
export function calculateBalanceScore(actual, target) {
  const perspectives = ['builder', 'contributor', 'integrator', 'experimenter'];
  
  // Calculate absolute deviations for each perspective
  const deviations = perspectives.map(p => ({
    perspective: p,
    actual: actual[p] || 0,
    target: target[p] || 25,
    deviation: Math.abs((actual[p] || 0) - (target[p] || 25))
  }));
  
  // Industry-standard drift calculation: sum of absolute deviations / 2
  const totalDrift = deviations.reduce((sum, d) => sum + d.deviation, 0) / 2;
  
  // Calculate score with graduated penalties
  let score = 100;
  
  if (totalDrift <= 5) {
    // Excellent: within 5% total drift
    score = 100 - (totalDrift * 2); // Minor penalty: 90-100
  } else if (totalDrift <= 10) {
    // Good: 5-10% drift
    score = 90 - ((totalDrift - 5) * 3); // 75-90
  } else if (totalDrift <= 15) {
    // Needs attention: 10-15% drift
    score = 75 - ((totalDrift - 10) * 3); // 60-75
  } else {
    // Critical: >15% drift
    score = Math.max(0, 60 - ((totalDrift - 15) * 4)); // 0-60
  }
  
  // Grade assignment
  let grade, status;
  if (score >= 90) {
    grade = 'A';
    status = 'Excellent Balance';
  } else if (score >= 75) {
    grade = 'B';
    status = 'Good Balance';
  } else if (score >= 60) {
    grade = 'C';
    status = 'Needs Attention';
  } else {
    grade = 'D';
    status = 'Rebalancing Required';
  }
  
  // Identify problem areas (deviations >10%)
  const problemAreas = deviations
    .filter(d => d.deviation > 10)
    .sort((a, b) => b.deviation - a.deviation);
  
  // Generate recommendations
  const recommendations = [];
  
  if (problemAreas.length > 0) {
    problemAreas.forEach(area => {
      const diff = area.actual - area.target;
      if (diff > 10) {
        recommendations.push({
          type: 'overweight',
          perspective: area.perspective,
          message: `Reduce ${area.perspective} time by ${Math.round(diff)}% (currently ${Math.round(area.actual)}%, target ${Math.round(area.target)}%)`
        });
      } else if (diff < -10) {
        recommendations.push({
          type: 'underweight',
          perspective: area.perspective,
          message: `Increase ${area.perspective} time by ${Math.round(Math.abs(diff))}% (currently ${Math.round(area.actual)}%, target ${Math.round(area.target)}%)`
        });
      }
    });
  }
  
  // Check for extreme concentration (>50% in one perspective)
  const maxPerspective = deviations.reduce((max, d) => 
    d.actual > max.actual ? d : max
  );
  
  if (maxPerspective.actual > 50) {
    recommendations.unshift({
      type: 'concentration_risk',
      perspective: maxPerspective.perspective,
      message: `High concentration risk: ${Math.round(maxPerspective.actual)}% in ${maxPerspective.perspective}. Diversify across perspectives for better balance.`
    });
  }
  
  // Check for missing perspectives (<5%)
  const missingPerspectives = deviations.filter(d => d.actual < 5);
  if (missingPerspectives.length > 0) {
    missingPerspectives.forEach(mp => {
      recommendations.push({
        type: 'missing_perspective',
        perspective: mp.perspective,
        message: `Consider adding ${mp.perspective} activities (currently ${Math.round(mp.actual)}%)`
      });
    });
  }
  
  return {
    score: Math.round(score * 10) / 10, // Round to 1 decimal
    drift: Math.round(totalDrift * 10) / 10,
    grade,
    status,
    deviations,
    recommendations,
    lastCalculated: new Date().toISOString()
  };
}

// Example usage and test cases
console.log('=== Test Case 1: Perfect Balance ===');
const test1 = calculateBalanceScore(
  { builder: 25, contributor: 25, integrator: 25, experimenter: 25 },
  { builder: 25, contributor: 25, integrator: 25, experimenter: 25 }
);
console.log(test1);

console.log('\n=== Test Case 2: Slight Imbalance (Good) ===');
const test2 = calculateBalanceScore(
  { builder: 30, contributor: 23, integrator: 27, experimenter: 20 },
  { builder: 25, contributor: 25, integrator: 25, experimenter: 25 }
);
console.log(test2);

console.log('\n=== Test Case 3: Moderate Imbalance (Needs Attention) ===');
const test3 = calculateBalanceScore(
  { builder: 40, contributor: 20, integrator: 30, experimenter: 10 },
  { builder: 25, contributor: 25, integrator: 25, experimenter: 25 }
);
console.log(test3);

console.log('\n=== Test Case 4: Severe Imbalance (Critical) ===');
const test4 = calculateBalanceScore(
  { builder: 60, contributor: 15, integrator: 20, experimenter: 5 },
  { builder: 25, contributor: 25, integrator: 25, experimenter: 25 }
);
console.log(test4);

console.log('\n=== Test Case 5: Custom Target ===');
const test5 = calculateBalanceScore(
  { builder: 42, contributor: 28, integrator: 20, experimenter: 10 },
  { builder: 40, contributor: 30, integrator: 20, experimenter: 10 }
);
console.log(test5);
</file>

<file path="src/utils/migrateProjects.js">
// src/utils/migrateProjects.js
import * as unifiedDB from '@/db/unifiedDB';
import { inferPerspectiveFromType } from './perspectiveHelpers';

/**
 * Migrate existing projects to add perspective field
 * This should be run once after deploying the new schema
 */
export const migrateProjectsAddPerspective = async () => {
  console.log('ğŸ”„ Starting project perspective migration...');
  
  try {
    const projects = await unifiedDB.getAllProjects();
    
    let migratedCount = 0;
    let skippedCount = 0;
    
    for (const project of projects) {
      // Skip if already has perspective
      if (project.perspective) {
        skippedCount++;
        continue;
      }
      
      // Infer perspective from type
      const perspective = inferPerspectiveFromType(project.type);
      
      // Update project with perspective
      await unifiedDB.updateProject(project.id, {
        perspective,
        perspectiveAlignment: 75 // Default alignment
      });
      
      migratedCount++;
      console.log(`âœ… Migrated: ${project.name} â†’ ${perspective}`);
    }
    
    console.log(`
âœ… Migration complete!
   Migrated: ${migratedCount}
   Skipped: ${skippedCount}
   Total: ${projects.length}
    `);
    
    return {
      success: true,
      migrated: migratedCount,
      skipped: skippedCount,
      total: projects.length
    };
  } catch (error) {
    console.error('âŒ Migration failed:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Initialize default portfolio settings
 */
export const initializeDefaultPortfolio = async () => {
  console.log('ğŸ”„ Initializing default portfolio...');
  
  try {
    const existingPortfolio = await unifiedDB.getPortfolio();
    
    if (existingPortfolio) {
      console.log('â„¹ï¸ Portfolio already exists, skipping initialization');
      return { success: true, skipped: true };
    }
    
    // Create default portfolio with balanced targets
    const defaultPortfolio = {
      targetBalance: {
        builder: 25,
        contributor: 25,
        integrator: 25,
        experimenter: 25
      },
      actualBalance: {
        builder: 0,
        contributor: 0,
        integrator: 0,
        experimenter: 0
      },
      balanceScore: 0,
      lastCalculated: new Date().toISOString(),
      goals: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    await unifiedDB.updatePortfolio(defaultPortfolio);
    
    console.log('âœ… Default portfolio initialized');
    return { success: true, skipped: false };
  } catch (error) {
    console.error('âŒ Portfolio initialization failed:', error);
    return { success: false, error: error.message };
  }
};

/**
 * Run full migration
 */
export const runFullMigration = async () => {
  console.log('ğŸš€ Running full Phase 1 migration...');
  
  const projectMigration = await migrateProjectsAddPerspective();
  const portfolioInit = await initializeDefaultPortfolio();
  
  return {
    projects: projectMigration,
    portfolio: portfolioInit
  };
};
</file>

<file path="src/utils/perspectiveHelpers.js">
// src/utils/perspectiveHelpers.js

// Perspective definitions
export const PERSPECTIVES = {
  builder: {
    id: 'builder',
    label: 'Builder',
    icon: 'ğŸ”¨',
    color: '#3B82F6',
    description: 'Creating tangible value through products, projects, or businesses',
    examples: 'Building a SaaS, writing a book, creating art'
  },
  contributor: {
    id: 'contributor',
    label: 'Contributor',
    icon: 'ğŸ¤',
    color: '#10B981',
    description: 'Giving back through teaching, mentoring, or community service',
    examples: 'Mentoring startups, volunteering, teaching courses'
  },
  integrator: {
    id: 'integrator',
    label: 'Integrator',
    icon: 'ğŸ”„',
    color: '#8B5CF6',
    description: 'Exploring connections between different interests and experiences',
    examples: 'Cross-pollinating ideas, interdisciplinary projects'
  },
  experimenter: {
    id: 'experimenter',
    label: 'Experimenter',
    icon: 'ğŸ§ª',
    color: '#F59E0B',
    description: 'Learning new skills and trying new things without pressure to complete',
    examples: 'Learning languages, trying hobbies, exploring interests'
  }
};

// Map old project types to perspectives (for migration)
export const TYPE_TO_PERSPECTIVE_MAP = {
  building: 'builder',
  consulting: 'contributor',
  learning: 'experimenter',
  contributing: 'contributor',
  wildcard: 'experimenter'
};

// Get perspective config
export const getPerspective = (perspectiveId) => {
  return PERSPECTIVES[perspectiveId] || null;
};

// Get perspective icon
export const getPerspectiveIcon = (perspectiveId) => {
  return PERSPECTIVES[perspectiveId]?.icon || 'ğŸ“‹';
};

// Get perspective label
export const getPerspectiveLabel = (perspectiveId) => {
  return PERSPECTIVES[perspectiveId]?.label || 'Unknown';
};

// Get perspective color
export const getPerspectiveColor = (perspectiveId) => {
  return PERSPECTIVES[perspectiveId]?.color || '#6B7280';
};

// Infer perspective from project type (for migration)
export const inferPerspectiveFromType = (projectType) => {
  return TYPE_TO_PERSPECTIVE_MAP[projectType] || 'experimenter';
};

// Get all perspectives as array
export const getAllPerspectives = () => {
  return Object.values(PERSPECTIVES);
};

// Calculate balance score (0-100)
// Higher score = better balance across perspectives
export const calculateBalanceScore = (actualBalance, targetBalance) => {
  if (!targetBalance) {
    // Default: perfect balance = 25% each
    targetBalance = {
      builder: 25,
      contributor: 25,
      integrator: 25,
      experimenter: 25
    };
  }
  
  // Calculate deviation from target
  const deviations = [
    Math.abs(actualBalance.builder - targetBalance.builder),
    Math.abs(actualBalance.contributor - targetBalance.contributor),
    Math.abs(actualBalance.integrator - targetBalance.integrator),
    Math.abs(actualBalance.experimenter - targetBalance.experimenter)
  ];
  
  const totalDeviation = deviations.reduce((sum, d) => sum + d, 0);
  const maxDeviation = 400; // Worst case: 100% deviation on all 4
  
  // Convert to 0-100 score (100 = perfect balance)
  const score = Math.max(0, 100 - (totalDeviation / maxDeviation) * 100);
  
  return Math.round(score);
};

// Get balance status
export const getBalanceStatus = (score) => {
  if (score >= 80) return { label: 'Excellent', color: 'green' };
  if (score >= 60) return { label: 'Good', color: 'blue' };
  if (score >= 40) return { label: 'Fair', color: 'yellow' };
  return { label: 'Needs Work', color: 'red' };
};

// Find underrepresented perspectives
export const getUnderrepresentedPerspectives = (actualBalance, threshold = 15) => {
  return Object.entries(actualBalance)
    .filter(([_, percentage]) => percentage < threshold)
    .map(([perspective, percentage]) => ({
      perspective,
      percentage,
      ...PERSPECTIVES[perspective]
    }));
};

// Find overrepresented perspectives
export const getOverrepresentedPerspectives = (actualBalance, threshold = 50) => {
  return Object.entries(actualBalance)
    .filter(([_, percentage]) => percentage > threshold)
    .map(([perspective, percentage]) => ({
      perspective,
      percentage,
      ...PERSPECTIVES[perspective]
    }));
};
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";

const eslintConfig = defineConfig([
  ...nextVitals,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="jsconfig.json">
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="postcss.config.js">
// postcss.config.js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="src/components/AppLayout.js">
'use client';

import React, { useState } from 'react';
import { Home as HomeIcon, MessageSquare, BookOpen, BarChart3, Settings, Plus, FolderOpen, Lightbulb, Target } from 'lucide-react';
import { usePathname, useRouter } from 'next/navigation';
import Link from 'next/link';
import QuickTimeLog from './QuickTimeLog';
import ProjectForm from './ProjectForm';

export default function AppLayout({ children, showFAB = false }) {
  const pathname = usePathname();
  const router = useRouter();

  const navItems = [
    { id: 'home', path: '/', icon: HomeIcon, label: 'Home' },
    { id: 'chat', path: '/chat', icon: MessageSquare, label: 'AI Advisor' },
    { id: 'journal', path: '/journal', icon: BookOpen, label: 'Journal' },
    { id: 'stats', path: '/analytics', icon: BarChart3, label: 'Analytics' },

    { id: 'portfolio', path: '/portfolio', icon: Target, label: 'Portfolio' }
  ];

  const [showProjectForm, setShowProjectForm] = useState(false);

  return (
    <div className="flex flex-col h-screen max-w-md mx-auto bg-gray-50 relative">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-lg overflow-hidden">
            <img src="/icons/icon-192x192.png" alt="RetireWise" className="w-full h-full" />
          </div>
          <div>
            <h1 className="text-lg font-bold text-gray-800">RetireWise</h1>
            <p className="text-xs text-gray-500">MVP v0.1</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => router.push('/projects')}
            className="p-2 hover:bg-gray-100 rounded-lg"
          >
            <FolderOpen className="w-5 h-5" />
          </button>
          <button
            onClick={() => router.push('/insights')}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative"
          >
            <Lightbulb className="w-5 h-5 text-gray-600" />
          </button>
          <button 
            onClick={() => router.push('/settings')}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <Settings className="w-5 h-5 text-gray-600" />
          </button>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-4">
        {children}
      </div>

      {/* Quick Time Log (only on home) */}
      {pathname === '/' && <QuickTimeLog />}

      {/* Floating Action Button (only on home) */}
      {showProjectForm && (
        <ProjectForm
          onClose={() => setShowProjectForm(false)}
          onSaved={() => {
          setShowProjectForm(false);
        // Optionally refresh projects list if on projects page
          if (pathname === '/projects') {
            window.location.reload();
          }
        }}
      />
      )}

      {showFAB && pathname === '/' && (
      <button
        onClick={() => setShowProjectForm(true)}
        className="fixed bottom-20 right-4 md:bottom-6 md:right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all z-50 flex items-center justify-center"
        aria-label="New Project"
      >
        <Plus className="w-6 h-6" />
      </button>
      )}

      {/* Bottom Navigation */}
      <div className="bg-white border-t border-gray-200 px-4 py-2 flex items-center justify-around">
        {navItems.map((item) => {
          const Icon = item.icon;
          const isActive = pathname === item.path;
          return (
            <button
              key={item.id}
              onClick={() => router.push(item.path)}
              className="flex flex-col items-center gap-1 py-2 px-3 rounded-lg transition-colors"
            >
              <Icon className={`w-6 h-6 ${isActive ? 'text-blue-600' : 'text-gray-400'}`} />
              <span className={`text-xs ${isActive ? 'text-blue-600 font-medium' : 'text-gray-500'}`}>
                {item.label}
              </span>
            </button>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="src/components/InsightsPanel.js">
'use client';

import React, { useState, useEffect } from 'react';
import { Lightbulb, X, CheckCircle, ThumbsUp, ThumbsDown, AlertTriangle, TrendingUp, Star, Target } from 'lucide-react';
import { getActiveInsights, dismissInsight, markInsightActedOn, provideFeedback } from '@/db/unifiedDB';
import * as unifiedDB from '@/db/unifiedDB';


const InsightsPanel = () => {
  const [insights, setInsights] = useState([]);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState(false);

  useEffect(() => {
    console.log('InsightsPanel mounted');
    loadInsights();
  }, []);

  const loadInsights = async () => {
    console.log('Loading insights...');
    try {
      const activeInsights = await getActiveInsights();
      console.log('Loaded insights:', activeInsights);
      console.log('Number of insights:', activeInsights.length);
      setInsights(activeInsights);
      setLoading(false);
    } catch (error) {
      console.error('Error loading insights:', error);
      setLoading(false);
    }
  };

  const handleGenerateInsights = async () => {
    setGenerating(true);
    try {
      const newInsights = await unifiedDB.generateInsights();
      console.log(`âœ… Generated ${newInsights.length} new insights`);
      await loadInsights();
    } catch (error) {
      console.error('Error generating insights:', error);
      alert('Failed to generate insights');
    } finally {
      setGenerating(false);
    }
  };

  const handleDismiss = async (insightId, reason = null) => {
    try {
      await dismissInsight(insightId, reason);
      await loadInsights();
    } catch (error) {
      console.error('Error dismissing insight:', error);
    }
  };

  const handleActedOn = async (insightId) => {
    try {
      await markInsightActedOn(insightId);
      await loadInsights();
    } catch (error) {
      console.error('Error marking insight:', error);
    }
  };

  const handleFeedback = async (insightId, feedback) => {
    try {
      await provideFeedback(insightId, feedback);
      // Don't reload, just update locally
      setInsights(prev => prev.map(insight => 
        insight.id === insightId 
          ? { ...insight, userFeedback: feedback }
          : insight
      ));
    } catch (error) {
      console.error('Error providing feedback:', error);
    }
  };

  const getInsightIcon = (type) => {
    switch (type) {
      case 'pattern': return TrendingUp;
      case 'achievement': return Star;
      case 'suggestion': return Lightbulb;
      case 'alert': return AlertTriangle;
      case 'milestone': return Target;
      default: return Lightbulb;
    }
  };

  const getInsightColor = (priority) => {
    switch (priority) {
      case 'high': return 'border-red-300 bg-red-50';
      case 'medium': return 'border-yellow-300 bg-yellow-50';
      case 'low': return 'border-blue-300 bg-blue-50';
      default: return 'border-gray-300 bg-gray-50';
    }
  };

  const getPriorityBadge = (priority) => {
    const colors = {
      high: 'bg-red-100 text-red-700',
      medium: 'bg-yellow-100 text-yellow-700',
      low: 'bg-blue-100 text-blue-700'
    };
    return colors[priority] || colors.low;
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-full">
        <p className="text-gray-500">Loading insights...</p>
      </div>
    );
  }

  return (
    <div className="space-y-4 pb-20">


      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <Lightbulb className="w-7 h-7 text-yellow-500" />
            Insights
          </h1>
          <p className="text-sm text-gray-600 mt-1">
            AI-powered recommendations based on your activity
          </p>
        </div>
        <button
          onClick={handleGenerateInsights}
          disabled={generating}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium disabled:opacity-50"
        >
          {generating ? 'Generating...' : 'Generate New'}
        </button>
      </div>

      {/* Insights List */}
      {insights.length === 0 ? (
        <div className="bg-white rounded-xl p-8 shadow-sm text-center">
          <Lightbulb className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500 mb-4">
            No insights yet. Click "Generate New" to analyze your activity and get personalized recommendations.
          </p>
          <button
            onClick={handleGenerateInsights}
            disabled={generating}
            className="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium"
          >
            {generating ? 'Generating...' : 'Generate Insights'}
          </button>
        </div>
      ) : (
        <div className="space-y-4">
          {insights.map((insight) => {
            const Icon = getInsightIcon(insight.type);
            
            return (
              <div 
                key={insight.id}
                className={`border-2 rounded-xl p-5 shadow-sm ${getInsightColor(insight.priority)}`}
              >
                {/* Header */}
                <div className="flex items-start justify-between mb-3">
                  <div className="flex items-start gap-3 flex-1">
                    <div className={`p-2 rounded-lg ${
                      insight.priority === 'high' ? 'bg-red-100' :
                      insight.priority === 'medium' ? 'bg-yellow-100' :
                      'bg-blue-100'
                    }`}>
                      <Icon className="w-5 h-5" />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-bold text-gray-800">{insight.title}</h3>
                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${getPriorityBadge(insight.priority)}`}>
                          {insight.priority}
                        </span>
                      </div>
                      <p className="text-sm text-gray-700">{insight.description}</p>
                    </div>
                  </div>
                  <button
                    onClick={() => handleDismiss(insight.id)}
                    className="p-1 hover:bg-white rounded-lg transition-colors flex-shrink-0"
                  >
                    <X className="w-5 h-5 text-gray-500" />
                  </button>
                </div>

                {/* Suggested Actions */}
                {insight.actionable && insight.suggestedActions.length > 0 && (
                  <div className="mb-3 pl-11">
                    <p className="text-xs font-semibold text-gray-600 mb-2">Suggested actions:</p>
                    <ul className="space-y-1">
                      {insight.suggestedActions.map((action, idx) => (
                        <li key={idx} className="text-sm text-gray-700 flex items-start gap-2">
                          <span className="text-blue-600 mt-1">â†’</span>
                          <span>{action}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="flex items-center gap-2 pl-11">
                  {insight.actionable && !insight.actedOn && (
                    <button
                      onClick={() => handleActedOn(insight.id)}
                      className="flex items-center gap-1 px-3 py-1.5 bg-white text-green-700 rounded-lg hover:bg-green-50 transition-colors text-sm font-medium"
                    >
                      <CheckCircle className="w-4 h-4" />
                      Done
                    </button>
                  )}
                  
                  {insight.actedOn && (
                    <span className="flex items-center gap-1 px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium">
                      <CheckCircle className="w-4 h-4" />
                      Acted on
                    </span>
                  )}

                  {/* Feedback */}
                  {!insight.userFeedback && (
                    <div className="flex items-center gap-1 ml-auto">
                      <span className="text-xs text-gray-500 mr-1">Helpful?</span>
                      <button
                        onClick={() => handleFeedback(insight.id, 'helpful')}
                        className="p-1.5 hover:bg-white rounded-lg transition-colors"
                      >
                        <ThumbsUp className="w-4 h-4 text-gray-600" />
                      </button>
                      <button
                        onClick={() => handleFeedback(insight.id, 'not-helpful')}
                        className="p-1.5 hover:bg-white rounded-lg transition-colors"
                      >
                        <ThumbsDown className="w-4 h-4 text-gray-600" />
                      </button>
                    </div>
                  )}

                  {insight.userFeedback === 'helpful' && (
                    <span className="text-xs text-green-600 ml-auto flex items-center gap-1">
                      <ThumbsUp className="w-3 h-3" />
                      Marked helpful
                    </span>
                  )}
                </div>

                {/* Metadata */}
                <div className="mt-3 pt-3 border-t border-gray-200/50 flex items-center justify-between text-xs text-gray-500 pl-11">
                  <span>
                    Generated {new Date(insight.generatedAt).toLocaleDateString()}
                  </span>
                  <span>
                    {Math.round(insight.confidence * 100)}% confidence
                  </span>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Info Card */}
      <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
        <p className="font-medium mb-1">ğŸ’¡ About Insights</p>
        <p>
          Insights are automatically generated based on your projects, time logs, and journal entries. 
          They help you notice patterns, stay on track, and make better decisions about where to focus your energy.
        </p>
      </div>
    </div>
  );
};

export default InsightsPanel;
</file>

<file path="src/components/PortfolioDashboard.js">
// src/components/PortfolioDashboard.js
'use client';

import React, { useState, useEffect } from 'react';
import { Target, TrendingUp, Clock, Award } from 'lucide-react';
import * as unifiedDB from '@/db/unifiedDB';
import { 
  PERSPECTIVES, 
  calculateBalanceScore, 
  getBalanceStatus,
  getUnderrepresentedPerspectives,
  getOverrepresentedPerspectives 
} from '@/utils/perspectiveHelpers';
import PerspectiveCard from './PerspectiveCard';
import BalanceChart from './BalanceChart';
import BalanceComparison from './BalanceComparison';
import RecentActivityByPerspective from './RecentActivityByPerspective';

const PortfolioDashboard = () => {
  const [loading, setLoading] = useState(true);
  const [portfolio, setPortfolio] = useState(null);
  const [balance, setBalance] = useState(null);
  const [stats, setStats] = useState(null);
  const [projects, setProjects] = useState([]);

  useEffect(() => {
    loadDashboardData();
  }, []);

  const loadDashboardData = async () => {
    setLoading(true);
    try {
      const [portfolioData, balanceData, statsData, projectsData] = await Promise.all([
        unifiedDB.getPortfolio(),
        unifiedDB.calculatePortfolioBalance(),
        unifiedDB.getPerspectiveStats(),
        unifiedDB.getAllProjects()
      ]);

      setPortfolio(portfolioData);
      setBalance(balanceData);
      setStats(statsData);
      setProjects(projectsData);
    } catch (error) {
      console.error('Error loading dashboard data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = async () => {
    await loadDashboardData();
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading portfolio...</p>
        </div>
      </div>
    );
  }

  if (!portfolio || !balance) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <p className="text-gray-600 mb-4">No portfolio data found</p>
          <button
            onClick={handleRefresh}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Initialize Portfolio
          </button>
        </div>
      </div>
    );
  }

  const balanceScore = calculateBalanceScore(balance.actualBalance, portfolio.targetBalance);
  const balanceStatus = getBalanceStatus(balanceScore);
  const underrepresented = getUnderrepresentedPerspectives(balance.actualBalance);
  const overrepresented = getOverrepresentedPerspectives(balance.actualBalance);

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 pb-24">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">Portfolio Overview</h1>
        <p className="text-gray-600">
          Track your balance across the four perspectives
        </p>
      </div>

      {/* Balance Score Card */}
      <div className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-6 mb-6 text-white shadow-lg">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-blue-100 text-sm font-medium mb-1">Portfolio Balance Score</p>
            <div className="flex items-baseline gap-2">
              <span className="text-5xl font-bold">{balanceScore}</span>
              <span className="text-2xl text-blue-100">/100</span>
            </div>
            <p className="text-blue-100 mt-2">
              Status: <span className="font-semibold">{balanceStatus.label}</span>
            </p>
          </div>
          <div className="bg-white bg-opacity-20 rounded-full p-4">
            <Target className="w-12 h-12" />
          </div>
        </div>
      </div>

      {/* Key Metrics */}
      {/* <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6"> */}
      <div className="grid grid-cols-1 gap-2 mb-6">
        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <div className="flex items-center gap-3">
            <div className="bg-blue-100 rounded-lg p-3">
              <Clock className="w-5 h-5 text-blue-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Total Hours</p>
              <p className="text-2xl font-bold text-gray-800">{balance.totalHours.toFixed(1)}</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <div className="flex items-center gap-3">
            <div className="bg-purple-100 rounded-lg p-3">
              <Target className="w-5 h-5 text-purple-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Active Projects</p>
              <p className="text-2xl font-bold text-gray-800">
                {projects.filter(p => p.status === 'active').length}
              </p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <div className="flex items-center gap-3">
            <div className="bg-green-100 rounded-lg p-3">
              <Award className="w-5 h-5 text-green-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Perspectives</p>
              <p className="text-2xl font-bold text-gray-800">
                {Object.values(balance.actualBalance).filter(v => v > 0).length}/4
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Balance Insights */}
      {(underrepresented.length > 0 || overrepresented.length > 0) && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
          <div className="flex items-start gap-3">
            <TrendingUp className="w-5 h-5 text-yellow-600 mt-0.5" />
            <div className="flex-1">
              <h3 className="font-semibold text-yellow-900 mb-2">Balance Insights</h3>
              {underrepresented.length > 0 && (
                <p className="text-sm text-yellow-800 mb-2">
                  <strong>Underrepresented:</strong>{' '}
                  {underrepresented.map(p => `${p.icon} ${p.label}`).join(', ')} - 
                  Consider adding more activities in these areas.
                </p>
              )}
              {overrepresented.length > 0 && (
                <p className="text-sm text-yellow-800">
                  <strong>Overrepresented:</strong>{' '}
                  {overrepresented.map(p => `${p.icon} ${p.label}`).join(', ')} - 
                  You are focusing heavily here.
                </p>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Balance Visualization */}
      <div className="grid grid-cols-1 lg:grid-cols-1 gap-6 mb-6">
        <BalanceChart balance={balance} />
        <BalanceComparison 
          actualBalance={balance.actualBalance} 
          targetBalance={portfolio.targetBalance} 
        />
      </div>

      {/* Perspective Cards */}
      <div className="mb-6">
        <h2 className="text-xl font-bold text-gray-800 mb-4">Perspectives</h2>
        <div className="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-2">
          {Object.values(PERSPECTIVES).map(perspective => (
            <PerspectiveCard
              key={perspective.id}
              perspective={perspective}
              stats={stats[perspective.id]}
              actualPercentage={balance.actualBalance[perspective.id]}
              targetPercentage={portfolio.targetBalance[perspective.id]}
            />
          ))}
        </div>
      </div>

      {/* Recent Activity */}
      <RecentActivityByPerspective projects={projects} />

      {/* Refresh Button */}
      <div className="mt-6 text-center">
        <button
          onClick={handleRefresh}
          className="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm"
        >
          Refresh Data
        </button>
      </div>
    </div>
  );
};

export default PortfolioDashboard;
</file>

<file path="src/components/ProjectForm.js">
// src/components/ProjectForm.js
'use client';

import React, { useState, useEffect } from 'react';
import { X, Plus, Info } from 'lucide-react';
import * as unifiedDB from '@/db/unifiedDB';
import { PERSPECTIVES, getAllPerspectives } from '@/utils/perspectiveHelpers';

const ProjectForm = ({ project, onClose, onSaved }) => {
  const isEdit = !!project;
  
  const [formData, setFormData] = useState({
    name: '',
    type: 'building',
    status: 'planning',
    description: '',
    motivation: '',
    goals: [],
    tags: [],
    color: '#3B82F6',
    icon: '',
    targetHours: '',
    perspective: 'builder',
    perspectiveAlignment: 75,
    // Perspective-specific metrics
    builderMetrics: {},
    contributorMetrics: {},
    integratorMetrics: {},
    experimenterMetrics: {}
  });
  
  const [goalInput, setGoalInput] = useState('');
  const [tagInput, setTagInput] = useState('');
  const [saving, setSaving] = useState(false);
  const [showPerspectiveInfo, setShowPerspectiveInfo] = useState(false);

  useEffect(() => {
    if (project) {
      setFormData({
        name: project.name || '',
        type: project.type || 'building',
        status: project.status || 'planning',
        description: project.description || '',
        motivation: project.motivation || '',
        goals: project.goals || [],
        tags: project.tags || [],
        color: project.color || '#3B82F6',
        icon: project.icon || '',
        targetHours: project.targetHours || '',
        perspective: project.perspective || 'builder',
        perspectiveAlignment: project.perspectiveAlignment || 75,
        builderMetrics: project.builderMetrics || {},
        contributorMetrics: project.contributorMetrics || {},
        integratorMetrics: project.integratorMetrics || {},
        experimenterMetrics: project.experimenterMetrics || {}
      });
    }
  }, [project]);

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const addGoal = () => {
    if (goalInput.trim()) {
      setFormData(prev => ({
        ...prev,
        goals: [...prev.goals, goalInput.trim()]
      }));
      setGoalInput('');
    }
  };

  const removeGoal = (index) => {
    setFormData(prev => ({
      ...prev,
      goals: prev.goals.filter((_, i) => i !== index)
    }));
  };

  const addTag = () => {
    if (tagInput.trim()) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, tagInput.trim()]
      }));
      setTagInput('');
    }
  };

  const removeTag = (index) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter((_, i) => i !== index)
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSaving(true);

    try {
      const projectData = {
        ...formData,
        targetHours: formData.targetHours ? parseFloat(formData.targetHours) : null
      };

      if (isEdit) {
        await unifiedDB.updateProject(project.id, projectData);
      } else {
        await unifiedDB.createProject(projectData);
      }
      
      // Dispatch event
      window.dispatchEvent(new Event('projectUpdated'));

      onSaved();
      onClose();
    } catch (error) {
      console.error('Error saving project:', error);
      alert('Failed to save project');
    } finally {
      setSaving(false);
    }
  };

  const projectTypes = [
    { value: 'building', label: 'Building', description: 'Creating products or tools' },
    { value: 'consulting', label: 'Consulting', description: 'Advising others' },
    { value: 'learning', label: 'Learning', description: 'Acquiring new skills' },
    { value: 'contributing', label: 'Contributing', description: 'Helping others directly' },
    { value: 'wildcard', label: 'Wildcard', description: 'Something completely different' }
  ];

  const statusOptions = [
    { value: 'planning', label: 'Planning' },
    { value: 'active', label: 'Active' },
    { value: 'paused', label: 'Paused' },
    { value: 'complete', label: 'Complete' },
    { value: 'archived', label: 'Archived' }
  ];

  const colorPresets = [
    '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', 
    '#EF4444', '#EC4899', '#06B6D4', '#84CC16'
  ];

  const perspectives = getAllPerspectives();
  const selectedPerspective = PERSPECTIVES[formData.perspective];

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-4">
      <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold text-gray-800">
            {isEdit ? 'Edit Project' : 'New Project'}
          </h2>
          <button 
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <X className="w-6 h-6 text-gray-600" />
          </button>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="p-6 space-y-6">
          {/* Name */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Project Name *
            </label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => handleChange('name', e.target.value)}
              required
              placeholder="e.g., Wanderwise, AI Learning"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* Perspective Selection - NEW */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <label className="block text-sm font-semibold text-gray-700">
                Primary Perspective *
              </label>
              <button
                type="button"
                onClick={() => setShowPerspectiveInfo(!showPerspectiveInfo)}
                className="text-blue-600 hover:text-blue-700"
              >
                <Info className="w-4 h-4" />
              </button>
            </div>

            {showPerspectiveInfo && (
              <div className="mb-3 p-3 bg-blue-50 rounded-lg text-sm text-blue-900">
                <p className="font-semibold mb-2">What are perspectives?</p>
                <p>Perspectives help you maintain a balanced portfolio of activities:</p>
                <ul className="mt-2 space-y-1 ml-4">
                  <li>ğŸ”¨ <strong>Builder:</strong> Creating tangible value</li>
                  <li>ğŸ¤ <strong>Contributor:</strong> Giving back to others</li>
                  <li>ğŸ”„ <strong>Integrator:</strong> Connecting different ideas</li>
                  <li>ğŸ§ª <strong>Experimenter:</strong> Learning and exploring</li>
                </ul>
              </div>
            )}

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {perspectives.map((perspective) => (
                <button
                  key={perspective.id}
                  type="button"
                  onClick={() => handleChange('perspective', perspective.id)}
                  className={`p-4 border-2 rounded-xl text-left transition-all ${
                    formData.perspective === perspective.id
                      ? 'border-2 shadow-md'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                  style={{
                    borderColor: formData.perspective === perspective.id ? perspective.color : undefined,
                    backgroundColor: formData.perspective === perspective.id ? `${perspective.color}10` : undefined
                  }}
                >
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-2xl">{perspective.icon}</span>
                    <p className="font-semibold text-gray-800">{perspective.label}</p>
                  </div>
                  <p className="text-xs text-gray-600">{perspective.description}</p>
                </button>
              ))}
            </div>
          </div>

          {/* Alignment Strength - NEW */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Alignment Strength
            </label>
            <div className="flex items-center gap-4">
              <input
                type="range"
                min="0"
                max="100"
                value={formData.perspectiveAlignment}
                onChange={(e) => handleChange('perspectiveAlignment', parseInt(e.target.value))}
                className="flex-1"
                style={{
                  accentColor: selectedPerspective?.color
                }}
              />
              <div className="flex items-center gap-2">
                <span className="text-2xl font-bold" style={{ color: selectedPerspective?.color }}>
                  {formData.perspectiveAlignment}%
                </span>
              </div>
            </div>
            <p className="text-xs text-gray-500 mt-1">
              How well does this project align with the {selectedPerspective?.label} perspective?
            </p>
          </div>

          {/* Visual Separator */}
          <div className="border-t border-gray-200 my-6"></div>

          {/* Type */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Project Type
            </label>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {projectTypes.map((type) => (
                <button
                  key={type.value}
                  type="button"
                  onClick={() => handleChange('type', type.value)}
                  className={`p-3 border-2 rounded-xl text-left transition-colors ${
                    formData.type === type.value
                      ? 'border-blue-600 bg-blue-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <p className="font-medium text-gray-800 text-sm">{type.label}</p>
                  <p className="text-xs text-gray-500 mt-1">{type.description}</p>
                </button>
              ))}
            </div>
          </div>

          {/* Status (only show for edit) */}
          {isEdit && (
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Status
              </label>
              <select
                value={formData.status}
                onChange={(e) => handleChange('status', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                {statusOptions.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>
          )}

          {/* Description */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Description
            </label>
            <textarea
              value={formData.description}
              onChange={(e) => handleChange('description', e.target.value)}
              placeholder="What is this project about?"
              rows="3"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            />
          </div>

          {/* Motivation */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Motivation
            </label>
            <textarea
              value={formData.motivation}
              onChange={(e) => handleChange('motivation', e.target.value)}
              placeholder="Why are you doing this?"
              rows="2"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            />
          </div>

          {/* Goals */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Goals
            </label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={goalInput}
                onChange={(e) => setGoalInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addGoal())}
                placeholder="Add a goal..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="button"
                onClick={addGoal}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
            {formData.goals.length > 0 && (
              <ul className="space-y-2">
                {formData.goals.map((goal, idx) => (
                  <li key={idx} className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg">
                    <span className="flex-1 text-sm text-gray-700">{goal}</span>
                    <button
                      type="button"
                      onClick={() => removeGoal(idx)}
                      className="text-red-600 hover:text-red-700 text-sm"
                    >
                      Remove
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>

          {/* Tags */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Tags
            </label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={tagInput}
                onChange={(e) => setTagInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addTag())}
                placeholder="Add a tag..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="button"
                onClick={addTag}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
            {formData.tags.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {formData.tags.map((tag, idx) => (
                  <span 
                    key={idx}
                    className="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full"
                  >
                    {tag}
                    <button
                      type="button"
                      onClick={() => removeTag(idx)}
                      className="text-gray-500 hover:text-red-600"
                    >
                      Ã—
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>

          {/* Color & Icon */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Color
              </label>
              <div className="flex gap-2 flex-wrap">
                {colorPresets.map((color) => (
                  <button
                    key={color}
                    type="button"
                    onClick={() => handleChange('color', color)}
                    className={`w-10 h-10 rounded-lg transition-all ${
                      formData.color === color ? 'ring-2 ring-offset-2 ring-gray-400' : ''
                    }`}
                    style={{ backgroundColor: color }}
                  />
                ))}
              </div>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Icon (emoji)
              </label>
              <input
                type="text"
                value={formData.icon}
                onChange={(e) => handleChange('icon', e.target.value)}
                placeholder="ğŸš€"
                maxLength="2"
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl"
              />
            </div>
          </div>

          {/* Target Hours */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Target Hours (optional)
            </label>
            <input
              type="number"
              value={formData.targetHours}
              onChange={(e) => handleChange('targetHours', e.target.value)}
              placeholder="e.g., 100"
              min="0"
              step="1"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* Submit Buttons */}
          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={saving || !formData.name}
              className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {saving ? 'Saving...' : isEdit ? 'Save Changes' : 'Create Project'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default ProjectForm;
</file>

<file path="src/config/firebase.js">
// src/config/firebase.js
import { initializeApp } from 'firebase/app';
import { getAnalytics } from 'firebase/analytics';
import { getAuth } from 'firebase/auth';
import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager } from 'firebase/firestore';

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
  measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
};

const app = initializeApp(firebaseConfig);

export const auth = getAuth(app);

// Initialize Firestore with offline persistence
export const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    tabManager: persistentMultipleTabManager()
  })
});

// Only initialize analytics in browser
export const analytics = typeof window !== 'undefined' ? getAnalytics(app) : null;

console.log('ğŸ”¥ Firebase initialized with offline persistence');
</file>

<file path="src/hooks/usePortfolioContext.js">
// src/hooks/usePortfolioContext.js
// COMPLETE VERSION - Copy this entire file
'use client';

import { useState, useEffect } from 'react';
import { getPortfolio, calculatePortfolioBalance, getAllProjects, getAllTimeLogs } from '@/db/unifiedDB';

export function usePortfolioContext() {
  const [portfolioContext, setPortfolioContext] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    loadPortfolioContext();
  }, []);

  async function loadPortfolioContext() {
    try {
      setLoading(true);
      
      const [portfolio, balance, projects, timeLogs] = await Promise.all([
        getPortfolio(),
        calculatePortfolioBalance(),
        getAllProjects(),
        getAllTimeLogs()
      ]);

      const activeProjects = projects.filter(p => p.status !== 'completed').length;
      const targetBalance = portfolio?.targetBalance || {
        builder: 25, contributor: 25, integrator: 25, experimenter: 25
      };

      // Calculate balance score using the helper function below
      const balanceScore = calculateBalanceScore(balance.actualBalance, targetBalance);

      const recentActivity = timeLogs.slice(0, 20).map(log => ({
        perspective: log.perspective,
        date: log.date,
        hours: log.duration
      }));

      const context = {
        userName: portfolio?.displayName || 'User',
        actualBalance: balance.actualBalance,
        targetBalance,
        balanceScore,
        totalHours: Math.round(balance.totalHours || 0),
        activeProjects,
        recentActivity
      };

      setPortfolioContext(context);
      setError(null);
    } catch (err) {
      console.error('Failed to load portfolio context:', err);
      setError(err);
      setPortfolioContext(null);
    } finally {
      setLoading(false);
    }
  }

  return { portfolioContext, loading, error, refresh: loadPortfolioContext };
}

// Helper function to calculate balance score
// This was missing - causing your error!
function calculateBalanceScore(actual, target) {
  const perspectives = ['builder', 'contributor', 'integrator', 'experimenter'];
  
  // Calculate absolute deviations
  const deviations = perspectives.map(p => 
    Math.abs((actual[p] || 0) - (target[p] || 25))
  );
  
  // Total drift (industry standard formula)
  const totalDrift = deviations.reduce((sum, d) => sum + d, 0) / 2;
  
  // Calculate score with graduated penalties
  let score = 100;
  if (totalDrift <= 5) {
    score = 100 - (totalDrift * 2);
  } else if (totalDrift <= 10) {
    score = 90 - ((totalDrift - 5) * 3);
  } else if (totalDrift <= 15) {
    score = 75 - ((totalDrift - 10) * 3);
  } else {
    score = Math.max(0, 60 - ((totalDrift - 15) * 4));
  }
  
  // Assign grade
  let grade = 'A';
  if (score < 90) grade = 'B';
  if (score < 75) grade = 'C';
  if (score < 60) grade = 'D';
  
  // Assign status
  let status;
  if (score >= 90) status = 'Excellent Balance';
  else if (score >= 75) status = 'Good Balance';
  else if (score >= 60) status = 'Needs Attention';
  else status = 'Critical - Rebalancing Required';
  
  return {
    score: Math.round(score * 10) / 10,
    drift: Math.round(totalDrift * 10) / 10,
    grade,
    status
  };
}
</file>

<file path="README.md">
# RetireWise ğŸ¯

> AI-powered retirement portfolio management app that helps retirees balance their time across four perspectives of fulfillment: Builder, Contributor, Integrator, and Experimenter.

[![Next.js](https://img.shields.io/badge/Next.js-15-black)](https://nextjs.org/)
[![React](https://img.shields.io/badge/React-18-blue)](https://reactjs.org/)
[![Firebase](https://img.shields.io/badge/Firebase-10-orange)](https://firebase.google.com/)
[![Tailwind CSS](https://img.shields.io/badge/Tailwind-3-38B2AC)](https://tailwindcss.com/)
[![Vercel](https://img.shields.io/badge/Deployed%20on-Vercel-black)](https://vercel.com/)

## ğŸŒŸ Features

### Core Functionality
- **Portfolio Management** - Track projects across four perspectives of retirement fulfillment
- **Time Logging** - Record hours spent on each project with detailed metrics
- **Balance Tracking** - Real-time calculation of time allocation across perspectives
- **AI Advisor** - Claude-powered chat with portfolio context awareness
- **Journal Integration** - Reflect on projects and track insights
- **Analytics Dashboard** - Visualize patterns and trends in your retirement activities

### AI Capabilities
- **Portfolio-Aware Responses** - AI knows your balance score, targets, and recent activity
- **Agentic Tools** - AI can search your journal, analyze patterns, and retrieve project details
- **Smart Insights** - Automated suggestions based on balance deviations and activity patterns
- **Personalized Recommendations** - Context-aware advice for rebalancing and focus areas

### Technical Features
- **Offline Support** - Firestore persistent cache for offline access
- **Real-time Sync** - Automatic synchronization across devices
- **PWA Ready** - Progressive Web App with service worker
- **Responsive Design** - Mobile-first, works on all screen sizes
- **Type-Safe** - Consistent database operations with validation

---

## ğŸš€ Quick Start

### Prerequisites
- Node.js 18+ and npm/yarn
- Firebase project with Firestore enabled
- Anthropic API key (for AI features)

### Installation

1. **Clone the repository**
   ```bash
   git clone https://github.com/yourusername/retirewise.git
   cd retirewise
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Configure environment variables**
   
   Create `.env.local`:
   ```env
   # Firebase Configuration
   NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
   NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
   NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
   NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
   NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
   NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
   
   # Anthropic AI
   NEXT_PUBLIC_ANTHROPIC_API_KEY=sk-ant-xxxxx
   ```

4. **Set up Firebase**
   - Enable Authentication (Email/Password)
   - Enable Firestore Database
   - Configure Firestore rules (see `DATABASE.md`)
   - Enable offline persistence

5. **Run development server**
   ```bash
   npm run dev
   ```

6. **Open your browser**
   ```
   http://localhost:3000
   ```

---

## ğŸ“– Documentation

- **[ARCHITECTURE.md](./docs/ARCHITECTURE.md)** - Application structure and design patterns
- **[DATABASE.md](./docs/DATABASE.md)** - Firestore schema and data models
- **[API_REFERENCE.md](./docs/API_REFERENCE.md)** - API routes and database functions
- **[DEPLOYMENT.md](./docs/DEPLOYMENT.md)** - Deployment guide for Vercel
- **[CONTRIBUTING.md](./docs/CONTRIBUTING.md)** - Development guidelines

---

## ğŸ—ï¸ Project Structure

```
retirewise/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Next.js 15 App Router
â”‚   â”‚   â”œâ”€â”€ page.js            # Landing page
â”‚   â”‚   â”œâ”€â”€ chat/              # AI chat interface
â”‚   â”‚   â”œâ”€â”€ portfolio/         # Portfolio dashboard
â”‚   â”‚   â”œâ”€â”€ analytics/         # Analytics views
â”‚   â”‚   â””â”€â”€ api/               # API routes
â”‚   â”œâ”€â”€ components/            # React components
â”‚   â”‚   â”œâ”€â”€ AIChat.js         # AI chat component
â”‚   â”‚   â”œâ”€â”€ PortfolioDashboard.js
â”‚   â”‚   â”œâ”€â”€ InsightsPanel.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ contexts/              # React contexts
â”‚   â”‚   â””â”€â”€ AuthContext.js    # Authentication state
â”‚   â”œâ”€â”€ hooks/                 # Custom hooks
â”‚   â”‚   â””â”€â”€ usePortfolioContext.js
â”‚   â”œâ”€â”€ db/                    # Database layer
â”‚   â”‚   â”œâ”€â”€ firestore/        # Firestore operations
â”‚   â”‚   â”‚   â””â”€â”€ firestoreDB.js
â”‚   â”‚   â””â”€â”€ unifiedDB.js      # Unified database API
â”‚   â”œâ”€â”€ lib/                   # Utilities
â”‚   â”‚   â””â”€â”€ ai-prompt-generator.js
â”‚   â”œâ”€â”€ services/              # External services
â”‚   â”‚   â””â”€â”€ aiService.js      # Claude AI integration
â”‚   â””â”€â”€ config/                # Configuration
â”‚       â””â”€â”€ firebase.js       # Firebase setup
â”œâ”€â”€ public/                    # Static assets
â”œâ”€â”€ docs/                      # Documentation
â””â”€â”€ package.json
```

---

## ğŸ¯ The Four Perspectives

RetireWise is built around four modes of retirement engagement:

### ğŸ”¨ Builder
Creating new things from scratch - entrepreneurship, writing, building projects, starting businesses.

### ğŸ¤ Contributor
Adding value to existing systems - teaching, mentoring, volunteering, consulting, helping others.

### ğŸ”„ Integrator
Connecting ideas and people - facilitating collaboration, curating content, synthesis, networking.

### ğŸ§ª Experimenter
Trying new things without pressure - learning, exploration, hobbies, travel, creative play.

---

## ğŸ”§ Key Technologies

- **Frontend**: Next.js 15, React 18, Tailwind CSS
- **Backend**: Next.js API Routes, Firebase Functions
- **Database**: Firebase Firestore with offline persistence
- **Authentication**: Firebase Authentication
- **AI**: Anthropic Claude (Sonnet 4) via API
- **Deployment**: Vercel with edge functions
- **Icons**: Lucide React
- **Date Handling**: date-fns

---

## ğŸ“Š Database Schema

### Collections Structure
```
users/{userId}
  â”œâ”€â”€ portfolio: { targetBalance, actualBalance, balanceScore }
  â”œâ”€â”€ settings: { ai, notifications, display }
  â”œâ”€â”€ projects/
  â”‚   â””â”€â”€ {projectId}: { name, perspective, status, ... }
  â”œâ”€â”€ timeLogs/
  â”‚   â””â”€â”€ {logId}: { projectId, duration, date, ... }
  â”œâ”€â”€ journalEntries/
  â”‚   â””â”€â”€ {entryId}: { content, date, tags, ... }
  â”œâ”€â”€ insights/
  â”‚   â””â”€â”€ {insightId}: { type, title, dismissed, ... }
  â””â”€â”€ conversations/
      â””â”€â”€ {conversationId}: { messages, title, ... }
```

See [DATABASE.md](./docs/DATABASE.md) for complete schema details.

---

## ğŸ¤– AI Integration

### Portfolio-Aware System Prompts

The AI receives enriched context about your portfolio:

```javascript
Balance Score: 65/100 (Grade: C - Needs Attention)
Portfolio Drift: 17.5% from target allocation
Total Time Tracked: 124 hours
Active Projects: 8

Perspective Breakdown:
  â€¢ Builder: 45% current vs 25% target (+20% overweight)
  â€¢ Contributor: 20% current vs 25% target (-5% underweight)
  â€¢ Integrator: 25% current vs 25% target (on target)
  â€¢ Experimenter: 10% current vs 25% target (-15% underweight)
```

### Agentic Tools

Claude has access to tools that query your data:
- `get_recent_activity` - Retrieve time logs from past N days
- `search_journal` - Search journal entries by keywords
- `analyze_patterns` - Calculate perspective distribution and trends
- `get_project_details` - Get comprehensive project information

---

## ğŸ” Security

### Authentication
- Firebase Authentication with email/password
- Forced login required for all app features
- Secure token-based API authentication

### Data Privacy
- User data isolated by userId
- Firestore security rules enforce data ownership
- No cross-user data access
- API keys stored in environment variables

### Firestore Rules
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
```

---

## ğŸ“ˆ Performance

- **Offline-First**: Firestore persistent cache enables offline access
- **Optimistic Updates**: UI updates immediately, syncs in background
- **Efficient Queries**: Indexed queries for fast data retrieval
- **Code Splitting**: Next.js automatic code splitting
- **Image Optimization**: Next.js Image component for optimized loading
- **Edge Functions**: API routes deployed to Vercel edge network

---

## ğŸ§ª Testing

### Manual Testing Checklist
- [ ] User can sign up and log in
- [ ] Projects can be created with perspectives
- [ ] Time logs save and appear in analytics
- [ ] Portfolio balance calculates correctly
- [ ] AI chat responds with portfolio context
- [ ] Insights generate based on balance
- [ ] Offline mode works (disable network)
- [ ] Real-time sync works (multiple tabs)

### Test Accounts
Create test users with different balance scenarios:
- Balanced (25/25/25/25)
- Builder-heavy (60/15/15/10)
- Missing perspectives (0% in one area)

---

## ğŸ› Troubleshooting

### Common Issues

**Firebase "Permission Denied"**
- Check Firestore rules are deployed
- Verify user is authenticated
- Ensure userId matches document path

**AI Chat Not Working**
- Verify ANTHROPIC_API_KEY in `.env.local`
- Check browser console for errors
- Ensure portfolio context is loading (check console logs)

**Offline Sync Issues**
- Clear browser cache and reload
- Check Firestore offline persistence is enabled
- Verify internet connection for initial sync

**Build Errors**
- Run `npm install` to ensure dependencies
- Check Node.js version (18+)
- Clear `.next` folder and rebuild

---

## ğŸš€ Deployment

### Deploy to Vercel

1. **Push to GitHub**
   ```bash
   git push origin main
   ```

2. **Connect to Vercel**
   - Import repository in Vercel dashboard
   - Configure environment variables
   - Deploy

3. **Configure Environment**
   - Add all Firebase config variables
   - Add ANTHROPIC_API_KEY
   - Enable for Production, Preview, Development

4. **Custom Domain** (optional)
   - Add custom domain in Vercel settings
   - Update Firebase authorized domains

See [DEPLOYMENT.md](./docs/DEPLOYMENT.md) for detailed instructions.

---

## ğŸ¤ Contributing

Contributions are welcome! Please read [CONTRIBUTING.md](./docs/CONTRIBUTING.md) for:
- Code style guidelines
- Development workflow
- Pull request process
- Testing requirements

---

## ğŸ“ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## ğŸ‘¥ Authors

- **Your Name** - *Initial work* - [GitHub](https://github.com/yourusername)

---

## ğŸ™ Acknowledgments

- **Anthropic Claude** - AI capabilities
- **Firebase** - Backend infrastructure
- **Vercel** - Hosting and deployment
- **Next.js Team** - Framework and tools
- **Community** - Inspiration and feedback

---

## ğŸ“ Support

- **Documentation**: [/docs](./docs)
- **Issues**: [GitHub Issues](https://github.com/yourusername/retirewise/issues)
- **Discussions**: [GitHub Discussions](https://github.com/yourusername/retirewise/discussions)

---

## ğŸ—ºï¸ Roadmap

### Completed âœ…
- Phase 1: Foundation (Next.js, Firebase, Authentication)
- Phase 2: Core Features (Projects, Time Logging, Analytics)
- Phase 3: Portfolio Management (Balance Tracking, Insights)
- Phase 4: AI Enhancement (Portfolio-Aware AI, Agentic Tools)

### Planned ğŸš§
- Phase 5: Goal Setting UI (Visual target configuration)
- Phase 6: Enhanced Dashboard (Advanced visualizations)
- Phase 7: Historical Analytics (Trends over time)
- Phase 8: Notifications (Email digests, milestone alerts)
- Phase 9: Social Features (Community, sharing)
- Phase 10: Mobile App (Native iOS/Android)

---

**Built with â¤ï¸ for meaningful retirement living**
</file>

<file path="vercel.json">
{
  "buildCommand": "pnpm build",
  "outputDirectory": ".next",
  "devCommand": "pnpm start",
  "installCommand": "pnpm install --frozen-lockfile --ignore-scripts=false"
}
</file>

<file path="src/app/chat/page.js">
'use client';

import AppLayout from '@/components/AppLayout';
import AIChat from '@/components/AIChat';

export default function ChatPage() {
  return (
    <AppLayout>
      <div className="h-full -m-4">
        <AIChat />
      </div>
    </AppLayout>
  );
}
</file>

<file path="src/app/insights/page.js">
'use client';

import AppLayout from '@/components/AppLayout';
import InsightsPanel from '@/components/InsightsPanel';

export default function InsightsPage() {
  return (
    <AppLayout>
      <InsightsPanel />
    </AppLayout>
  );
}
</file>

<file path="src/app/journal/page.js">
'use client';

import AppLayout from '@/components/AppLayout';
import JournalList from '@/components/JournalList';

export default function JournalPage() {
  return (
    <AppLayout>
      <JournalList />
    </AppLayout>
  );
}
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@layer utilities {
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
}
</file>

<file path="src/components/Analytics.js">
// src/components/Analytics.js
'use client';

import React, { useState, useEffect } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } from 'recharts';
import * as unifiedDB from '@/db/unifiedDB';

const Analytics = () => {
  const [loading, setLoading] = useState(true);
  const [timeRange, setTimeRange] = useState('all');
  const [stats, setStats] = useState(null);
  const [projects, setProjects] = useState([]);
  const [timeLogs, setTimeLogs] = useState([]);
  const [journalEntries, setJournalEntries] = useState([]);

  useEffect(() => {
    loadAnalytics();
  }, []);

  const loadAnalytics = async () => {
    try {
      const [statsData, projectsData, logsData, journalData] = await Promise.all([
        unifiedDB.getTimeLogStats(),
        unifiedDB.getAllProjects(),
        unifiedDB.getAllTimeLogs(),
        unifiedDB.getAllJournalEntries()
      ]);

      setStats(statsData);
      setProjects(projectsData);
      setTimeLogs(logsData);
      setJournalEntries(journalData);
    } catch (error) {
      console.error('Error loading analytics:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  // Filter data based on time range
  const getFilteredData = () => {
    const now = new Date();
    let startDate = new Date(0);

    if (timeRange === 'week') {
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (timeRange === 'month') {
      startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    }

    const filteredLogs = timeLogs.filter(log => new Date(log.date) >= startDate);
    const filteredJournal = journalEntries.filter(entry => new Date(entry.date) >= startDate);
    
    const totalHours = filteredLogs.reduce((sum, log) => sum + log.duration, 0);
    const sessions = filteredLogs.length;

    return { filteredLogs, totalHours, sessions, filteredJournal };
  };

  const { filteredLogs, totalHours, sessions, filteredJournal } = getFilteredData();

  // Time by project
  const projectHours = {};
  filteredLogs.forEach(log => {
    const project = projects.find(p => p.id === log.projectId);
    const projectName = project?.name || 'Unknown';
    projectHours[projectName] = (projectHours[projectName] || 0) + log.duration;
  });

  const projectData = Object.entries(projectHours)
    .map(([name, hours]) => ({
      name: name.length > 20 ? name.substring(0, 20) + '...' : name,
      value: parseFloat(hours.toFixed(1))
    }))
    .sort((a, b) => b.value - a.value)
    .slice(0, 5);

  const COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

  // Activity types
  const activityHours = {};
  filteredLogs.forEach(log => {
    if (log.activity) {
      activityHours[log.activity] = (activityHours[log.activity] || 0) + log.duration;
    }
  });

  const activityData = Object.entries(activityHours)
    .map(([name, value]) => ({ 
      name: name.length > 15 ? name.substring(0, 15) + '...' : name, 
      value: parseFloat(value.toFixed(1)) 
    }))
    .sort((a, b) => b.value - a.value);

  const CustomTooltip = ({ active, payload }) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white px-3 py-2 rounded-lg shadow-lg border border-gray-200">
          <p className="font-semibold text-gray-800">{payload[0].name}</p>
          <p className="text-sm text-gray-600">{payload[0].value}h</p>
        </div>
      );
    }
    return null;
  };

  return (
    <div className="space-y-6">
      {/* Time Range Selector */}
      <div className="flex gap-2">
        <button
          onClick={() => setTimeRange('week')}
          className={`px-4 py-2 rounded-lg font-medium transition-colors ${
            timeRange === 'week'
              ? 'bg-blue-600 text-white'
              : 'bg-white text-gray-600 border border-gray-200 hover:border-gray-300'
          }`}
        >
          Week
        </button>
        <button
          onClick={() => setTimeRange('month')}
          className={`px-4 py-2 rounded-lg font-medium transition-colors ${
            timeRange === 'month'
              ? 'bg-blue-600 text-white'
              : 'bg-white text-gray-600 border border-gray-200 hover:border-gray-300'
          }`}
        >
          Month
        </button>
        <button
          onClick={() => setTimeRange('all')}
          className={`px-4 py-2 rounded-lg font-medium transition-colors ${
            timeRange === 'all'
              ? 'bg-blue-600 text-white'
              : 'bg-white text-gray-600 border border-gray-200 hover:border-gray-300'
          }`}
        >
          All Time
        </button>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <p className="text-xs text-gray-600 mb-1">Total Hours</p>
          <p className="text-3xl font-bold text-gray-800">{totalHours.toFixed(1)}</p>
        </div>

        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <p className="text-xs text-gray-600 mb-1">Sessions</p>
          <p className="text-3xl font-bold text-gray-800">{sessions}</p>
        </div>

        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <p className="text-xs text-gray-600 mb-1">Projects</p>
          <p className="text-3xl font-bold text-gray-800">{projects.length}</p>
        </div>

        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <p className="text-xs text-gray-600 mb-1">Journal</p>
          <p className="text-3xl font-bold text-gray-800">{filteredJournal.length}</p>
        </div>
      </div>

      {/* Charts - Vertical Stack */}
      <div className="space-y-6">
        {/* Time by Project */}
        <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
          <h3 className="text-lg font-semibold text-gray-800 mb-4">Time by Project</h3>
          {projectData.length > 0 ? (
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={projectData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                <XAxis dataKey="name" angle={-45} textAnchor="end" height={80} />
                <YAxis label={{ value: 'Hours', angle: -90, position: 'insideLeft' }} />
                <Tooltip content={<CustomTooltip />} />
                <Bar dataKey="value" radius={[8, 8, 0, 0]}>
                  {projectData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex items-center justify-center h-64 text-gray-400">
              No project data yet
            </div>
          )}
        </div>

        {/* Time by Activity */}
        <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
          <h3 className="text-lg font-semibold text-gray-800 mb-4">Time by Activity</h3>
          {activityData.length > 0 ? (
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={activityData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                <XAxis dataKey="name" angle={-45} textAnchor="end" height={80} />
                <YAxis label={{ value: 'Hours', angle: -90, position: 'insideLeft' }} />
                <Tooltip content={<CustomTooltip />} />
                <Bar dataKey="value" fill="#10B981" radius={[8, 8, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex items-center justify-center h-64 text-gray-400">
              No activity types logged
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default Analytics;
</file>

<file path="src/components/AppSettings.js">
'use client';

import React, { useState, useEffect } from 'react';
import { Key, Download, Upload, Trash2, AlertTriangle, Check, Eye, EyeOff, Info } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';

import { getUserProfile, updateUserProfile } from '@/db/unifiedDB';

const Settings = () => {
  const [settings, setSettings] = useState(null);
  const [apiKey, setApiKey] = useState('');
  const [showApiKey, setShowApiKey] = useState(false);
  const [saving, setSaving] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);

  const { currentUser } = useAuth();

  // Check if API key is configured via environment variable
  // const isApiKeyConfigured = !!process.env.REACT_APP_ANTHROPIC_API_KEY;
  // const isApiKeyConfigured = !!process.env.NEXT_PUBLIC_CLAUDE_API_KEY;

  const isApiKeyConfigured = !!process.env.ANTHROPIC_API_KEY;
  const isDevelopment = process.env.NODE_ENV === 'development';

  useEffect(() => {
    loadSettings();
  }, []);

  const loadSettings = async () => {
    try {

      // const userSettings = await db.settings.get('user_settings');
      const userSettings = await getUserProfile('user_settings').settings
      if (userSettings) {
        setSettings(userSettings);
        // Don't load the actual API key for security
        setApiKey(userSettings.ai?.apiKey ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '');
      } else {
        // No settings found, create default settings
        const defaultSettings = {
          id: 'user_settings',
          notifications: {
            dailyCheckIn: true,
            weeklyReview: true,
            insightAlerts: true
          },
          ui: {
            theme: 'auto',
            showPerspectiveScores: true
          },
          ai: {
            apiKey: null
          },
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        // await db.settings.add(defaultSettings);
        await updateUserProfile({settings: defaultSettings});
        setSettings(defaultSettings);
      }
    } catch (error) {
      console.error('Error loading settings:', error);
      // Set default settings even on error
      setSettings({
        notifications: { dailyCheckIn: true, weeklyReview: true, insightAlerts: true },
        ui: { theme: 'auto', showPerspectiveScores: true },
        ai: { apiKey: null }
      });
    }
  };

  const handleSaveApiKey = async () => {
    if (!apiKey || apiKey === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') return;
    
    setSaving(true);
    try {
      await db.settings.update('user_settings', {
        ai: {
          ...settings.ai,
          apiKey: apiKey
        },
        updatedAt: new Date().toISOString()
      });
      
      setSaveSuccess(true);
      setTimeout(() => setSaveSuccess(false), 3000);
      
      // Reload settings
      await loadSettings();
      setShowApiKey(false);
      
      console.log('âœ… API key saved');
    } catch (error) {
      console.error('Error saving API key:', error);
      alert('Failed to save API key');
    } finally {
      setSaving(false);
    }
  };

  const handleUpdatePreference = async (category, key, value) => {
    try {
      const updates = {
        [category]: {
          ...settings[category],
          [key]: value
        },
        updatedAt: new Date().toISOString()
      };
      
      await db.settings.update('user_settings', updates);
      await loadSettings();
      
      console.log(`âœ… Updated ${category}.${key}`);
    } catch (error) {
      console.error('Error updating preference:', error);
    }
  };

  const handleExportData = async () => {
    try {
      const allData = {
        projects: await db.projects.toArray(),
        timeLogs: await db.timeLogs.toArray(),
        journalEntries: await db.journalEntries.toArray(),
        conversations: await db.conversations.toArray(),
        settings: await db.settings.toArray(),
        exportDate: new Date().toISOString(),
        version: '1.0'
      };
      
      const dataStr = JSON.stringify(allData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `retirewise-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      
      alert('âœ… Data exported successfully!');
    } catch (error) {
      console.error('Error exporting data:', error);
      alert('Failed to export data');
    }
  };

  const handleImportData = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      if (!data.projects || !data.exportDate) {
        throw new Error('Invalid backup file format');
      }
      
      const confirmed = window.confirm(
        'This will replace all current data. Are you sure you want to import?'
      );
      
      if (!confirmed) return;
      
      // Clear existing data
      await db.projects.clear();
      await db.timeLogs.clear();
      await db.journalEntries.clear();
      await db.conversations.clear();
      
      // Import new data
      await db.projects.bulkAdd(data.projects);
      await db.timeLogs.bulkAdd(data.timeLogs);
      await db.journalEntries.bulkAdd(data.journalEntries);
      if (data.conversations) {
        await db.conversations.bulkAdd(data.conversations);
      }
      
      alert('âœ… Data imported successfully! Refreshing...');
      window.location.reload();
    } catch (error) {
      console.error('Error importing data:', error);
      alert('Failed to import data: ' + error.message);
    }
  };

  const handleClearAllData = async () => {
    const confirmed = window.confirm(
      'âš ï¸ WARNING: This will permanently delete ALL your data including projects, time logs, journal entries, and conversations. This cannot be undone.\n\nAre you absolutely sure?'
    );
    
    if (!confirmed) return;
    
    const doubleConfirm = window.confirm(
      'Last chance! Type YES in the next prompt to confirm deletion.'
    );
    
    if (!doubleConfirm) return;
    
    const finalConfirm = prompt('Type YES to confirm deletion:');
    
    if (finalConfirm !== 'YES') {
      alert('Deletion cancelled');
      return;
    }
    
    try {
      await db.projects.clear();
      await db.timeLogs.clear();
      await db.journalEntries.clear();
      await db.conversations.clear();
      await db.insights.clear();
      await db.perspectiveScores.clear();
      await db.embeddingsCache.clear();
      
      alert('âœ… All data cleared. Refreshing...');
      window.location.reload();
    } catch (error) {
      console.error('Error clearing data:', error);
      alert('Failed to clear data');
    }
  };

  if (!settings) {
    return (
      <div className="flex items-center justify-center h-full">
        <p className="text-gray-500">Loading settings...</p>
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-20">
      <h1 className="text-2xl font-bold text-gray-800">Settings</h1>

      {/* API Key Section - Only show in development or if not configured */}
      {(isDevelopment && !isApiKeyConfigured) && (
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <div className="flex items-center gap-2 mb-4">
            <Key className="w-5 h-5 text-blue-600" />
            <h2 className="text-lg font-bold text-gray-800">Claude API Key</h2>
          </div>
          
          <p className="text-sm text-gray-600 mb-4">
            Your API key is stored locally and never leaves your device. Get your key from{' '}
            <a 
              href="https://console.anthropic.com/settings/keys" 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-600 hover:underline"
            >
              console.anthropic.com
            </a>
          </p>

          <div className="space-y-3">
            <div className="flex gap-2">
              <input
                type={showApiKey ? 'text' : 'password'}
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="sk-ant-api03-..."
                className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
              />
              <button
                onClick={() => setShowApiKey(!showApiKey)}
                className="p-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors"
              >
                {showApiKey ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
              </button>
            </div>
            
            <button
              onClick={handleSaveApiKey}
              disabled={saving || !apiKey || apiKey === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}
              className="w-full px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {saving ? 'Saving...' : saveSuccess ? (
                <>
                  <Check className="w-5 h-5" />
                  Saved!
                </>
              ) : 'Save API Key'}
            </button>
          </div>
        </div>
      )}

      {/* API Key Status - Show in production */}
      {isApiKeyConfigured && (
        <div className="bg-green-50 border border-green-200 rounded-xl p-4">
          <div className="flex items-center gap-2 text-green-800">
            <Check className="w-5 h-5" />
            <p className="font-medium">API Key Configured</p>
          </div>
          <p className="text-sm text-green-700 mt-1">
            Your AI features are enabled and ready to use.
          </p>
        </div>
      )}

      {/* Notifications */}
      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h2 className="text-lg font-bold text-gray-800 mb-4">Notifications</h2>
        
        <div className="space-y-3">
          <label className="flex items-center justify-between">
            <span className="text-gray-700">Daily check-in reminder</span>
            <input
              type="checkbox"
              checked={settings.notifications?.dailyCheckIn}
              onChange={(e) => handleUpdatePreference('notifications', 'dailyCheckIn', e.target.checked)}
              className="w-5 h-5 text-blue-600 rounded"
            />
          </label>
          
          <label className="flex items-center justify-between">
            <span className="text-gray-700">Weekly review notification</span>
            <input
              type="checkbox"
              checked={settings.notifications?.weeklyReview}
              onChange={(e) => handleUpdatePreference('notifications', 'weeklyReview', e.target.checked)}
              className="w-5 h-5 text-blue-600 rounded"
            />
          </label>
          
          <label className="flex items-center justify-between">
            <span className="text-gray-700">AI insight alerts</span>
            <input
              type="checkbox"
              checked={settings.notifications?.insightAlerts}
              onChange={(e) => handleUpdatePreference('notifications', 'insightAlerts', e.target.checked)}
              className="w-5 h-5 text-blue-600 rounded"
            />
          </label>
        </div>
      </div>

      {/* UI Preferences */}
      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h2 className="text-lg font-bold text-gray-800 mb-4">Appearance</h2>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Theme
            </label>
            <select
              value={settings.ui?.theme || 'auto'}
              onChange={(e) => handleUpdatePreference('ui', 'theme', e.target.value)}
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="auto">Auto (System)</option>
            </select>
          </div>

          <label className="flex items-center justify-between">
            <span className="text-gray-700">Show perspective scores</span>
            <input
              type="checkbox"
              checked={settings.ui?.showPerspectiveScores}
              onChange={(e) => handleUpdatePreference('ui', 'showPerspectiveScores', e.target.checked)}
              className="w-5 h-5 text-blue-600 rounded"
            />
          </label>
        </div>
      </div>

      {/* Data Management */}
      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h2 className="text-lg font-bold text-gray-800 mb-4">Data Management</h2>
        
        <div className="space-y-3">
          <button
            onClick={handleExportData}
            className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors font-medium"
          >
            <Download className="w-5 h-5" />
            Export All Data
          </button>
          
          <label className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium cursor-pointer">
            <Upload className="w-5 h-5" />
            Import Data
            <input
              type="file"
              accept=".json"
              onChange={handleImportData}
              className="hidden"
            />
          </label>
          
          <div className="pt-4 border-t border-gray-200">
            <button
              onClick={handleClearAllData}
              className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors font-medium"
            >
              <Trash2 className="w-5 h-5" />
              Clear All Local Data
            </button>
            <p className="text-xs text-red-600 text-center mt-2">
              âš ï¸ This only clears local storage, not cloud data
            </p>
          </div>
        </div>
      </div>

      {/* About */}
      <div className="bg-white rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-2 mb-4">
          <Info className="w-5 h-5 text-gray-600" />
          <h2 className="text-lg font-bold text-gray-800">About RetireWise</h2>
        </div>
        
        <div className="space-y-2 text-sm text-gray-600">
          <p><strong>Version:</strong> 1.0.0 MVP</p>
          <p><strong>Built:</strong> December 2024</p>
          <p><strong>Storage:</strong> Firebase Firestore (Cloud)</p>
          <p><strong>AI Model:</strong> Claude Sonnet 4</p>
          <p className="pt-3 border-t border-gray-200">
            Your intelligent retirement portfolio advisor. Data syncs across all your devices via the cloud.
          </p>
        </div>
      </div>

      {/* Storage Info */}
      <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
        <p className="font-medium mb-2">â˜ï¸ Cloud Storage</p>
        <p>
          Your data is securely stored in Firebase Firestore and syncs automatically across all your devices. 
          When you use AI chat features, messages are sent to Claude API via a secure proxy server.
        </p>
      </div>
    </div>
  );
};

export default Settings;
</file>

<file path="src/components/HomeScreen.js">
'use client';

import { Lightbulb, FolderOpen } from 'lucide-react';
import { useRouter } from 'next/navigation';


export default function HomeScreen({ 
  todayHours = 0, 
  topInsights = [], 
  projects = [], 
  handleProjectClick,
  setShowProjectForm 
}) {
  const router = useRouter();
  
  return (
    <div className="space-y-4">
      <div className="bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
        <div className="flex items-start justify-between mb-4">
          <div>
            <p className="text-sm opacity-90">Welcome to</p>
            <h2 className="text-3xl font-bold">RetireWise</h2>
          </div>
          <div className="text-right">
            <p className="text-sm opacity-90">Today</p>
            <div className="flex items-baseline gap-1">
              <p className="text-3xl font-bold">{(todayHours || 0).toFixed(1)}</p>
              <p className="text-sm">hours</p>
            </div>
          </div>
        </div>
        <p className="text-sm opacity-90">Your intelligent retirement portfolio advisor</p>
      </div>

      {/* Top Insights Preview */}
      {topInsights && topInsights.length > 0 && (
        <div className="bg-white rounded-xl p-4 shadow-sm">
          <div className="flex items-center justify-between mb-3">
            <h3 className="font-semibold text-gray-800 flex items-center gap-2">
              <Lightbulb className="w-5 h-5 text-yellow-500" />
              Latest Insights
            </h3>
            <button
              onClick={() => router.push('insights')}
              className="text-blue-600 text-sm font-medium hover:underline"
            >
              View All
            </button>
          </div>
          <div className="space-y-2">
            {topInsights.map(insight => (
              <div key={insight.id} className="p-3 bg-gray-50 rounded-lg">
                <p className="text-sm font-medium text-gray-800">{insight.title}</p>
                <p className="text-xs text-gray-600 mt-1 line-clamp-2">{insight.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      <div className="bg-white rounded-xl p-4 shadow-sm">
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-semibold text-gray-800">Your Projects</h3>
          <span className="text-sm text-gray-500">{projects.length} active</span>
        </div>
        
        {projects.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <p className="mb-4">No projects yet. Create your first one to get started!</p>
            <button 
              onClick={() => setShowProjectForm(true)}
              className="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium"
            >
              Create Your First Project
            </button>
          </div>
        ) : (
          <div className="space-y-3">
            {projects.map((project) => (
              <button
                key={project.id}
                onClick={() => handleProjectClick(project)}
                className="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <div 
                  className="w-12 h-12 rounded-lg flex items-center justify-center text-white font-semibold text-lg flex-shrink-0"
                  style={{ backgroundColor: project.color }}
                >
                  {project.icon || project.name[0]}
                </div>
                <div className="flex-1 min-w-0 text-left">
                  <p className="font-medium text-gray-800 truncate">{project.name}</p>
                  <p className="text-xs text-gray-500">
                    {project.totalHoursLogged}h logged
                    {project.lastWorkedAt && ` â€¢ Last: ${new Date(project.lastWorkedAt).toLocaleDateString()}`}
                  </p>
                </div>
                <div className={`px-2 py-1 rounded-full text-xs flex-shrink-0 ${
                  project.status === 'active' ? 'bg-green-100 text-green-700' :
                  project.status === 'planning' ? 'bg-purple-100 text-purple-700' :
                  project.status === 'paused' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-gray-100 text-gray-600'
                }`}>
                  {project.status}
                </div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/JournalList.js">
// src/components/JournalList.js
'use client';

import React, { useState, useEffect } from 'react';
import { Plus, Search, Star, Calendar, Tag, Trash2, Edit2, Eye } from 'lucide-react';
import * as unifiedDB from '../db/unifiedDB';
import { getJournalStats } from '@/db/unifiedDB';
import { getAllProjects } from '@/db/unifiedDB';
import { format } from 'date-fns';
import JournalEntryForm from '@/components/JournalEntryForm';

const JournalList = () => {
  const [entries, setEntries] = useState([]);
  const [filteredEntries, setFilteredEntries] = useState([]);
  const [projects, setProjects] = useState([]);
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterType, setFilterType] = useState('all');
  const [filterProject, setFilterProject] = useState('all');
  
  // Modals
  const [showForm, setShowForm] = useState(false);
  const [editingEntry, setEditingEntry] = useState(null);
  const [selectedEntry, setSelectedEntry] = useState(null);

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    applyFilters();
  }, [entries, searchQuery, filterType, filterProject]);

  const loadData = async () => {
    try {
      const [allEntries, allProjects, journalStats] = await Promise.all([
        unifiedDB.getAllJournalEntries(),
        unifiedDB.getAllProjects(),
        getJournalStats()
      ]);
      
      setEntries(allEntries);
      setProjects(allProjects);
      setStats(journalStats);
      setLoading(false);
    } catch (error) {
      console.error('Error loading journal data:', error);
      setLoading(false);
    }
  };

  const applyFilters = () => {
    let filtered = [...entries];

    // Search filter
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(entry =>
        entry.content?.toLowerCase().includes(query) ||
        entry.title?.toLowerCase().includes(query) ||
        entry.tags?.some(tag => tag.toLowerCase().includes(query))
      );
    }

    // Type filter
    if (filterType !== 'all') {
      if (filterType === 'favorites') {
        filtered = filtered.filter(entry => entry.favorite);
      } else {
        filtered = filtered.filter(entry => entry.entryType === filterType);
      }
    }

    // Project filter
    if (filterProject !== 'all') {
      filtered = filtered.filter(entry => entry.projectId === filterProject);
    }

    setFilteredEntries(filtered);
  };

  const handleDelete = async (entryId) => {
    if (!window.confirm('Delete this journal entry? This cannot be undone.')) return;
    
    try {
      await unifiedDB.deleteJournalEntry(entryId);
      await loadData();
    } catch (error) {
      console.error('Error deleting entry:', error);
      alert('Failed to delete entry');
    }
  };

  const handleEdit = (entry) => {
    setEditingEntry(entry);
    setShowForm(true);
  };

  const handleCloseForm = () => {
    setShowForm(false);
    setEditingEntry(null);
  };

  const handleEntrySaved = () => {
    loadData();
  };

  const getEntryTypeEmoji = (type) => {
    const emojis = {
      reflection: 'ğŸ’­',
      learning: 'ğŸ“š',
      decision: 'ğŸ¯',
      milestone: 'ğŸ†',
      struggle: 'ğŸ’ª',
      idea: 'ğŸ’¡',
      general: 'ğŸ“'
    };
    return emojis[type] || 'ğŸ“';
  };

  const getSentimentColor = (sentiment) => {
    const colors = {
      positive: 'text-green-600',
      neutral: 'text-gray-600',
      negative: 'text-red-600'
    };
    return colors[sentiment] || 'text-gray-600';
  };

  const getProjectName = (projectId) => {
    if (!projectId) return null;
    const project = projects.find(p => p.id === projectId);
    return project ? `${project.icon || 'ğŸ“'} ${project.name}` : null;
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-full">
        <p className="text-gray-500">Loading journal...</p>
      </div>
    );
  }

  return (
    <div className="space-y-4 pb-20">
      {/* Stats Cards */}
      {stats && (
        <div className="grid grid-cols-3 gap-3">
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <p className="text-xs text-gray-500 mb-1">Total Entries</p>
            <p className="text-2xl font-bold text-gray-800">{stats.total}</p>
          </div>
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <p className="text-xs text-gray-500 mb-1">This Week</p>
            <p className="text-2xl font-bold text-blue-600">{stats.thisWeek}</p>
          </div>
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <p className="text-xs text-gray-500 mb-1">Favorites</p>
            <p className="text-2xl font-bold text-yellow-600">{stats.favorites}</p>
          </div>
        </div>
      )}

      {/* Search & Filters */}
      <div className="bg-white rounded-xl p-4 shadow-sm space-y-3">
        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search entries..."
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        {/* Type Filter */}
        <div className="flex gap-2 overflow-x-auto pb-1">
          <button
            onClick={() => setFilterType('all')}
            className={`px-3 py-1 rounded-full text-xs whitespace-nowrap transition-colors ${
              filterType === 'all'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            All
          </button>
          <button
            onClick={() => setFilterType('favorites')}
            className={`px-3 py-1 rounded-full text-xs whitespace-nowrap transition-colors ${
              filterType === 'favorites'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            â­ Favorites
          </button>
          {['reflection', 'learning', 'milestone', 'decision'].map(type => (
            <button
              key={type}
              onClick={() => setFilterType(type)}
              className={`px-3 py-1 rounded-full text-xs whitespace-nowrap transition-colors ${
                filterType === type
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {getEntryTypeEmoji(type)} {type.charAt(0).toUpperCase() + type.slice(1)}
            </button>
          ))}
        </div>

        {/* Project Filter */}
        {projects.length > 0 && (
          <select
            value={filterProject}
            onChange={(e) => setFilterProject(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="all">All Projects</option>
            {projects.map(project => (
              <option key={project.id} value={project.id}>
                {project.icon || 'ğŸ“'} {project.name}
              </option>
            ))}
          </select>
        )}
      </div>

      {/* Entries List */}
      {filteredEntries.length === 0 ? (
        <div className="bg-white rounded-xl p-8 shadow-sm text-center">
          <p className="text-gray-500 mb-4">
            {entries.length === 0 
              ? 'No journal entries yet. Start writing!' 
              : 'No entries match your filters.'
            }
          </p>
          {entries.length === 0 && (
            <button
              onClick={() => setShowForm(true)}
              className="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium"
            >
              Create First Entry
            </button>
          )}
        </div>
      ) : (
        <div className="space-y-3">
          {filteredEntries.map(entry => (
            <div key={entry.id} className="bg-white rounded-xl p-4 shadow-sm">
              {/* Header */}
              <div className="flex items-start justify-between mb-2">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xl">{getEntryTypeEmoji(entry.entryType)}</span>
                    {entry.title && (
                      <h3 className="font-semibold text-gray-800">{entry.title}</h3>
                    )}
                    {entry.favorite && <Star className="w-4 h-4 text-yellow-500 fill-current" />}
                  </div>
                  <div className="flex items-center gap-2 text-xs text-gray-500">
                    <Calendar className="w-3 h-3" />
                    <span>{format(new Date(entry.date), 'MMM d, yyyy â€¢ h:mm a')}</span>
                    {entry.sentiment && (
                      <span className={`${getSentimentColor(entry.sentiment)} font-medium`}>
                        â€¢ {entry.sentiment}
                      </span>
                    )}
                  </div>
                </div>
                <div className="flex gap-1">
                  <button
                    onClick={() => handleEdit(entry)}
                    className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                  >
                    <Edit2 className="w-4 h-4" />
                  </button>
                  <button
                    onClick={() => handleDelete(entry.id)}
                    className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>

              {/* Content Preview */}
              <p className="text-gray-700 text-sm mb-3 line-clamp-3">
                {entry.content}
              </p>

              {/* Footer */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 flex-wrap">
                  {entry.projectId && (
                    <span className="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full">
                      {getProjectName(entry.projectId)}
                    </span>
                  )}
                  {entry.tags?.slice(0, 3).map((tag, idx) => (
                    <span key={idx} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full flex items-center gap-1">
                      <Tag className="w-3 h-3" />
                      {tag}
                    </span>
                  ))}
                  {entry.tags?.length > 3 && (
                    <span className="text-xs text-gray-500">
                      +{entry.tags.length - 3} more
                    </span>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Floating Action Button */}
      <button
        onClick={() => setShowForm(true)}
        className="fixed bottom-20 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all hover:scale-110 flex items-center justify-center z-40"
      >
        <Plus className="w-6 h-6" />
      </button>

      {/* Entry Form Modal */}
      {showForm && (
        <JournalEntryForm
          entry={editingEntry}
          onClose={handleCloseForm}
          onSaved={handleEntrySaved}
        />
      )}
    </div>
  );
};

export default JournalList;
</file>

<file path="src/components/ProjectDetails.js">
// src/components/ProjectDetails.js
'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { ArrowLeft, Edit2, Trash2, Clock, Target, Calendar, TrendingUp } from 'lucide-react';
import { useRouter } from 'next/navigation';
import * as unifiedDB from '@/db/unifiedDB';
import { getPerspective, getPerspectiveColor, getPerspectiveIcon } from '@/utils/perspectiveHelpers';
import ProjectForm from './ProjectForm';
import TimeLogForm from './TimeLogForm';

const ProjectDetails = ({ projectId }) => {
  const router = useRouter();
  const [project, setProject] = useState(null);
  const [stats, setStats] = useState(null);
  const [timeLogs, setTimeLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showTimeLog, setShowTimeLog] = useState(false);
  const [editingTimeLog, setEditingTimeLog] = useState(null);
  const [showForm, setShowForm] = useState(false);
  

const loadProject = useCallback(async () => {
  try {
    const data = await unifiedDB.getProjectWithStats(projectId);
    if (data) {
      setProject(data.project);
      setStats(data.stats);
      
      // Load time logs
      const logs = await unifiedDB.getAllTimeLogs();
      const projectLogs = logs.filter(log => log.projectId === projectId);
      setTimeLogs(projectLogs);
    } else {
      console.error('Project not found:', projectId);
    }
  } catch (error) {
    console.error('Error loading project:', error);
  } finally {
    setLoading(false);
  }
}, [projectId]); // âœ… Dependencies: only projectId

useEffect(() => {
  if (projectId && projectId !== 'new') {
    loadProject();
  }
}, [projectId, loadProject]); // âœ… Now include loadProject


  const handleDelete = async () => {
    if (window.confirm('Are you sure you want to delete this project?')) {
      try {
        await unifiedDB.deleteProject(projectId);
        window.dispatchEvent(new Event('projectUpdated'));
        router.push('/projects');
      } catch (error) {
        console.error('Error deleting project:', error);
        alert('Failed to delete project');
      }
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (!project) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <p className="text-gray-600 mb-4">Project not found</p>
          <button
            onClick={() => router.push('/projects')}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Back to Projects
          </button>
        </div>
      </div>
    );
  }

  const perspective = getPerspective(project.perspective);
  const perspectiveColor = getPerspectiveColor(project.perspective);

  return (
    <div className="max-w-4xl mx-auto px-4 py-6 pb-24">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <button
          onClick={() => router.back()}
          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
        >
          <ArrowLeft className="w-6 h-6 text-gray-600" />
        </button>
        <h1 className="text-2xl font-bold text-gray-800 flex-1">Project Details</h1>
        <button
          onClick={() => setShowForm(true)}
          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
        >
          <Edit2 className="w-5 h-5 text-gray-600" />
        </button>
        <button
          onClick={handleDelete}
          className="p-2 hover:bg-red-50 rounded-lg transition-colors"
        >
          <Trash2 className="w-5 h-5 text-red-600" />
        </button>
      </div>

{/* Project Header Card */}
<div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
  {/* Line 1: Icon + Name */}
  <div className="flex items-center gap-3 mb-3">
    {project.icon && (
      <span className="text-3xl flex-shrink-0">{project.icon}</span>
    )}
    <h2 className="text-2xl font-bold text-gray-800">{project.name}</h2>
  </div>

  {/* Content Container - Always Left Aligned (no conditional margin) */}
  <div>
    {/* Perspective Badge */}
    {perspective && (
      <div className="flex flex-wrap items-center gap-2 mb-3">
        <div 
          className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold"
          style={{ 
            backgroundColor: `${perspectiveColor}20`,
            color: perspectiveColor,
            border: `2px solid ${perspectiveColor}`
          }}
        >
          <span className="text-lg">{perspective.icon}</span>
          <span>{perspective.label}</span>
          <span className="opacity-75">â€¢</span>
          <span>{project.perspectiveAlignment}% aligned</span>
        </div>
        
        <div className={`px-3 py-1 rounded-full text-xs font-medium ${
          project.status === 'active' ? 'bg-green-100 text-green-700' :
          project.status === 'planning' ? 'bg-blue-100 text-blue-700' :
          project.status === 'paused' ? 'bg-yellow-100 text-yellow-700' :
          project.status === 'complete' ? 'bg-purple-100 text-purple-700' :
          'bg-gray-100 text-gray-700'
        }`}>
          {project.status}
        </div>
      </div>
    )}

    {/* Perspective Description */}
    {perspective && (
      <div className="bg-gray-50 rounded-lg p-3 mb-3">
        <p className="text-sm text-gray-700">
          <span className="font-semibold">{perspective.label}:</span> {perspective.description}
        </p>
        <p className="text-xs text-gray-500 mt-1">
          Examples: {perspective.examples}
        </p>
      </div>
    )}

    {/* Description */}
    {project.description && (
      <p className="text-gray-600 mb-3">{project.description}</p>
    )}
    
    {/* Motivation */}
    {project.motivation && (
      <div className="bg-blue-50 rounded-lg p-3 mb-3">
        <p className="text-sm text-blue-900">
          <span className="font-semibold">Why:</span> {project.motivation}
        </p>
      </div>
    )}

    {/* Tags */}
    {project.tags && project.tags.length > 0 && (
      <div className="flex flex-wrap gap-2">
        {project.tags.map((tag, idx) => (
          <span
            key={idx}
            className="px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded-full"
          >
            {tag}
          </span>
        ))}
      </div>
    )}
  </div>

  {/* Goals - Full Width */}
  {project.goals && project.goals.length > 0 && (
    <div className="mt-4 pt-4 border-t border-gray-200">
      <h3 className="text-sm font-semibold text-gray-700 mb-2">Goals</h3>
      <ul className="space-y-2">
        {project.goals.map((goal, idx) => (
          <li key={idx} className="flex items-start gap-2 text-sm text-gray-600">
            <Target className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
            <span>{goal}</span>
          </li>
        ))}
      </ul>
    </div>
  )}
</div>

      {/* Stats Cards - BETTER RESPONSIVE FIX */}
      <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
        {/* Total Hours */}
        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <div className="text-center">
            <div className="inline-flex items-center justify-center bg-blue-100 rounded-lg p-2 mb-2">
              <Clock className="w-5 h-5 text-blue-600" />
            </div>
            <p className="text-xs text-gray-600 mb-1">Total Hours</p>
            <p className="text-2xl font-bold text-gray-800">
              {stats?.totalHours?.toFixed(1) || '0.0'}
            </p>
          </div>
        </div>

        {/* This Week */}
        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
          <div className="text-center">
            <div className="inline-flex items-center justify-center bg-green-100 rounded-lg p-2 mb-2">
              <TrendingUp className="w-5 h-5 text-green-600" />
            </div>
            <p className="text-xs text-gray-600 mb-1">This Week</p>
            <p className="text-2xl font-bold text-gray-800">
              {stats?.lastWeekHours?.toFixed(1) || '0.0'}
              <span className="text-base">h</span>
            </p>
            {stats?.weeklyChange !== 0 && (
            <p className={`text-xs mt-1 ${stats?.weeklyChange > 0 ? 'text-green-600' : 'text-red-600'}`}>
              {stats?.weeklyChange > 0 ? '+' : ''}{stats?.weeklyChange.toFixed(0)}%
            </p>
            )}
          </div>
        </div>

        {/* Progress */}
        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200 col-span-2 sm:col-span-1">
          <div className="text-center">
          <div className="inline-flex items-center justify-center bg-purple-100 rounded-lg p-2 mb-2">
            <Target className="w-5 h-5 text-purple-600" />
          </div>
          <p className="text-xs text-gray-600 mb-1">Progress</p>
          {project.targetHours ? (
            <>
            <p className="text-2xl font-bold text-gray-800">
              {stats?.completionRate?.toFixed(0) || 0}%
            </p>
            <p className="text-xs text-gray-500 mt-1">
              {stats?.totalHours?.toFixed(0) || 0} / {project.targetHours}h
            </p>
            </>
          ) : (
          <p className="text-sm text-gray-500">No target</p>
          )}
          </div>
        </div>
      </div>

      {/* Time Logs Section */}
      <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-800">Time Logs</h3>
          <button
            onClick={() => setShowTimeLog(true)}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
          >
            Log Time
          </button>
        </div>

        {timeLogs.length === 0 ? (
          <p className="text-gray-500 text-center py-8">No time logs yet</p>
        ) : (
          <div className="space-y-3">
            {timeLogs.slice(0, 5).map((log) => (
              <div
                key={log.id}
                className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <Calendar className="w-4 h-4 text-gray-400" />
                    <span className="text-sm font-medium text-gray-700">
                      {new Date(log.date).toLocaleDateString()}
                    </span>
                  </div>
                  {log.notes && (
                    <p className="text-sm text-gray-600 mt-1">{log.notes}</p>
                  )}
                </div>
                <div className="text-right">
                  <p className="text-lg font-bold text-gray-800">{log.duration}h</p>
                  {log.activity && (
                    <p className="text-xs text-gray-500">{log.activity}</p>
                  )}
                </div>
              </div>
            ))}
            {timeLogs.length > 5 && (
              <p className="text-sm text-gray-500 text-center pt-2">
                +{timeLogs.length - 5} more logs
              </p>
            )}
          </div>
        )}
      </div>

      {/* Forms */}
      {showForm && (
        <ProjectForm
          project={project}
          onClose={ () => setShowForm(false)}
          onSaved={() => {
            setShowForm(false);
            loadProject();
          }}
        />
      )}

      {showTimeLog && (
        <TimeLogForm
          projectId={projectId}
          projectName={project.name}
          timeLog={editingTimeLog}
          onClose={() => {
            setShowTimeLog(false);
            setEditingTimeLog(null);
          }}
          onSaved={() => {
            setShowTimeLog(false);
            setEditingTimeLog(null);
            loadProject();
          }}
        />
      )}
    </div>
  );
};

export default ProjectDetails;
</file>

<file path="src/components/ProjectsListView.js">
// src/components/ProjectsListView.js
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { Clock, Target, ChevronRight } from 'lucide-react';
import { getPerspective } from '@/utils/perspectiveHelpers';

const ProjectsListView = ({ projects }) => {
  const router = useRouter();

  if (projects.length === 0) {
    return (
      <div className="text-center py-20">
        <p className="text-gray-500 mb-4">No projects found</p>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {projects.map((project) => {
        const perspective = getPerspective(project.perspective);
        
        return (
          <div
            key={project.id}
            onClick={() => router.push(`/projects/${project.id}`)}
            className="bg-white rounded-xl p-4 shadow-sm border-2 border-gray-100 hover:border-gray-300 hover:shadow-md transition-all cursor-pointer"
            style={{ 
              borderLeftColor: perspective?.color,
              borderLeftWidth: '4px'
            }}
          >
            <div className="flex items-start gap-4">
              {/* Main Content */}
              <div className="flex-1 min-w-0">
                {/* Line 1: Icon + Title (left aligned) */}
                <div className="flex items-center gap-2 mb-2">
                  {project.icon && (
                    <span className="text-xl flex-shrink-0">{project.icon}</span>
                  )}
                  <h3 className="font-bold text-gray-800 text-lg">
                    {project.name}
                  </h3>
                </div>

                {/* Line 2: Perspective + Status (right aligned) */}
                <div className="flex items-center justify-end gap-2 mb-2">
                  {perspective && (
                    <div 
                      className="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium"
                      style={{ 
                        backgroundColor: `${perspective.color}20`,
                        color: perspective.color
                      }}
                    >
                      <span>{perspective.icon}</span>
                      <span>{perspective.label}</span>
                    </div>
                  )}
                  
                  <div className={`px-3 py-1 rounded-full text-xs font-medium ${
                    project.status === 'active' ? 'bg-green-100 text-green-700' :
                    project.status === 'planning' ? 'bg-blue-100 text-blue-700' :
                    project.status === 'paused' ? 'bg-yellow-100 text-yellow-700' :
                    project.status === 'complete' ? 'bg-purple-100 text-purple-700' :
                    'bg-gray-100 text-gray-700'
                  }`}>
                    {project.status}
                  </div>
                </div>

                {/* Line 3: Description */}
                {project.description && (
                  <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                    {project.description}
                  </p>
                )}

                {/* Line 4: Stats and Tags */}
                <div className="flex items-center justify-between gap-4 flex-wrap">
                  {/* Stats */}
                  <div className="flex items-center gap-4 text-sm">
                    <div className="flex items-center gap-1 text-gray-600">
                      <Clock className="w-4 h-4" />
                      <span className="font-medium">{project.totalHoursLogged?.toFixed(1) || '0'} hrs</span>
                    </div>
                    
                    {project.targetHours && (
                      <div className="flex items-center gap-1 text-gray-600">
                        <Target className="w-4 h-4" />
                        <span className="font-medium">
                          {((project.totalHoursLogged / project.targetHours) * 100).toFixed(0)}% of {project.targetHours}h
                        </span>
                      </div>
                    )}
                  </div>

                  {/* Tags */}
                  {project.tags && project.tags.length > 0 && (
                    <div className="flex items-center gap-1 flex-wrap">
                      {project.tags.slice(0, 3).map((tag, idx) => (
                        <span
                          key={idx}
                          className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full"
                        >
                          {tag}
                        </span>
                      ))}
                      {project.tags.length > 3 && (
                        <span className="text-xs text-gray-400">
                          +{project.tags.length - 3}
                        </span>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Arrow */}
              <ChevronRight className="w-5 h-5 text-gray-400 flex-shrink-0 mt-1" />
            </div>
          </div>
        );
      })}
    </div>
  );
};

export default ProjectsListView;
</file>

<file path="src/components/TimeLogsView.js">
'use client';

import React, { useState, useEffect } from 'react';
import { Clock, Edit2, Trash2, Calendar, Filter, X, Search } from 'lucide-react';

import * as unifiedDB from '@/db/unifiedDB';

const TimeLogsView = () => {
  const [timeLogs, setTimeLogs] = useState([]);
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [editingLog, setEditingLog] = useState(null);
  const [showEditModal, setShowEditModal] = useState(false);
  
  // Filters
  const [selectedProject, setSelectedProject] = useState('all');
  const [dateFilter, setDateFilter] = useState('all'); // all, today, week, month, custom
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [searchTerm, setSearchTerm] = useState('');


  const loadData = async () => {
    try {
      const [logs, projs] = await Promise.all([
        unifiedDB.getAllTimeLogs(),
        unifiedDB.getAllProjects()
      ]);
      setTimeLogs(logs);
      setProjects(projs);
      setLoading(false);
    } catch (error) {
      console.error('Error loading data:', error);
      setLoading(false);
    }
  };
  
  useEffect(() => {
    loadData();
  }, []);

  const handleEdit = (log) => {
    setEditingLog({ ...log });
    setShowEditModal(true);
  };

  const handleSaveEdit = async () => {
    if (!editingLog) return;
    
    try {
      await unifiedDB.updateTimeLog(editingLog.id, {
        projectId: editingLog.projectId,
        duration: parseFloat(editingLog.duration),
        date: editingLog.date,
        notes: editingLog.notes
      });
      
      await loadData();
      setShowEditModal(false);
      setEditingLog(null);
    } catch (error) {
      console.error('Error updating time log:', error);
      alert('Failed to update time log');
    }
  };

  const handleDelete = async (logId) => {
    if (!window.confirm('Are you sure you want to delete this time log?')) {
      return;
    }
    
    try {
      await unifiedDB.deleteTimeLog(logId);
      await loadData();
    } catch (error) {
      console.error('Error deleting time log:', error);
      alert('Failed to delete time log');
    }
  };

  // Filter logic
  const getFilteredLogs = () => {
    let filtered = [...timeLogs];

    // Project filter
    if (selectedProject !== 'all') {
      filtered = filtered.filter(log => log.projectId === selectedProject);
    }

    // Date filter
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    if (dateFilter === 'today') {
      filtered = filtered.filter(log => {
        const logDate = new Date(log.date);
        return logDate >= today;
      });
    } else if (dateFilter === 'week') {
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      filtered = filtered.filter(log => {
        const logDate = new Date(log.date);
        return logDate >= weekAgo;
      });
    } else if (dateFilter === 'month') {
      const monthAgo = new Date(today);
      monthAgo.setMonth(monthAgo.getMonth() - 1);
      filtered = filtered.filter(log => {
        const logDate = new Date(log.date);
        return logDate >= monthAgo;
      });
    } else if (dateFilter === 'custom' && customStartDate && customEndDate) {
      const start = new Date(customStartDate);
      const end = new Date(customEndDate);
      end.setHours(23, 59, 59, 999);
      filtered = filtered.filter(log => {
        const logDate = new Date(log.date);
        return logDate >= start && logDate <= end;
      });
    }

    // Search filter
    if (searchTerm) {
      filtered = filtered.filter(log => 
        log.notes?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        log.projectName?.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
  };

  const filteredLogs = getFilteredLogs();
  const totalHours = filteredLogs.reduce((sum, log) => sum + log.duration, 0);

  // Group logs by date
  const groupedLogs = filteredLogs.reduce((groups, log) => {
    const date = new Date(log.date).toLocaleDateString();
    if (!groups[date]) {
      groups[date] = [];
    }
    groups[date].push(log);
    return groups;
  }, {});

  if (loading) {
    return (
      <div className="flex items-center justify-center h-full">
        <p className="text-gray-500">Loading time logs...</p>
      </div>
    );
  }

  return (
    <div className="space-y-4 pb-20">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <Clock className="w-7 h-7 text-blue-600" />
            Time Logs
          </h1>
          <p className="text-sm text-gray-600 mt-1">
            {filteredLogs.length} logs â€¢ {totalHours.toFixed(1)} hours total
          </p>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white rounded-xl p-4 shadow-sm space-y-3">
        <div className="flex items-center gap-2 text-gray-700 font-medium">
          <Filter className="w-4 h-4" />
          Filters
        </div>

        {/* Search */}
        <div className="relative">
          <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
          <input
            type="text"
            placeholder="Search notes or project..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm"
          />
        </div>

        {/* Project Filter */}
        <div>
          <label className="text-xs text-gray-600 mb-1 block">Project</label>
          <select
            value={selectedProject}
            onChange={(e) => setSelectedProject(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
          >
            <option value="all">All Projects</option>
            {projects.map(project => (
              <option key={project.id} value={project.id}>
                {project.name}
              </option>
            ))}
          </select>
        </div>

        {/* Date Filter */}
        <div>
          <label className="text-xs text-gray-600 mb-1 block">Date Range</label>
          <select
            value={dateFilter}
            onChange={(e) => setDateFilter(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
          >
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">Last 7 Days</option>
            <option value="month">Last 30 Days</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        {/* Custom Date Range */}
        {dateFilter === 'custom' && (
          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="text-xs text-gray-600 mb-1 block">From</label>
              <input
                type="date"
                value={customStartDate}
                onChange={(e) => setCustomStartDate(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
              />
            </div>
            <div>
              <label className="text-xs text-gray-600 mb-1 block">To</label>
              <input
                type="date"
                value={customEndDate}
                onChange={(e) => setCustomEndDate(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
              />
            </div>
          </div>
        )}

        {/* Clear Filters */}
        {(selectedProject !== 'all' || dateFilter !== 'all' || searchTerm) && (
          <button
            onClick={() => {
              setSelectedProject('all');
              setDateFilter('all');
              setSearchTerm('');
              setCustomStartDate('');
              setCustomEndDate('');
            }}
            className="text-sm text-blue-600 hover:underline"
          >
            Clear all filters
          </button>
        )}
      </div>

      {/* Time Logs List */}
      {filteredLogs.length === 0 ? (
        <div className="bg-white rounded-xl p-8 shadow-sm text-center">
          <Clock className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500">
            {timeLogs.length === 0 
              ? "No time logs yet. Start tracking your time!"
              : "No logs match your filters."
            }
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {Object.entries(groupedLogs).map(([date, logs]) => (
            <div key={date} className="bg-white rounded-xl p-4 shadow-sm">
              <div className="flex items-center gap-2 mb-3">
                <Calendar className="w-4 h-4 text-gray-500" />
                <h3 className="font-semibold text-gray-800">{date}</h3>
                <span className="text-sm text-gray-500 ml-auto">
                  {logs.reduce((sum, log) => sum + log.duration, 0).toFixed(1)}h
                </span>
              </div>

              <div className="space-y-2">
                {logs.map(log => (
                  <div
                    key={log.id}
                    className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                  >
                    <div
                      className="w-10 h-10 rounded-lg flex items-center justify-center text-white font-semibold text-sm flex-shrink-0"
                      style={{ backgroundColor: log.projectColor || '#6B7280' }}
                    >
                      {log.projectIcon || log.projectName?.[0] || '?'}
                    </div>
                    
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex-1 min-w-0">
                          <p className="font-medium text-gray-900 truncate">
                            {log.projectName || 'Unknown Project'}
                          </p>
                          {log.notes && (
                            <p className="text-sm text-gray-600 mt-0.5 line-clamp-2">
                              {log.notes}
                            </p>
                          )}
                        </div>
                        <div className="flex items-center gap-2 flex-shrink-0">
                          <span className="text-sm font-semibold text-gray-900">
                            {log.duration}h
                          </span>
                          <button
                            onClick={() => handleEdit(log)}
                            className="p-1.5 hover:bg-gray-200 rounded transition-colors"
                          >
                            <Edit2 className="w-4 h-4 text-gray-600" />
                          </button>
                          <button
                            onClick={() => handleDelete(log.id)}
                            className="p-1.5 hover:bg-red-100 rounded transition-colors"
                          >
                            <Trash2 className="w-4 h-4 text-red-600" />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Edit Modal */}
      {showEditModal && editingLog && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-md shadow-xl">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-900">Edit Time Log</h2>
                <button
                  onClick={() => {
                    setShowEditModal(false);
                    setEditingLog(null);
                  }}
                  className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="space-y-4">
                {/* Project */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Project
                  </label>
                  <select
                    value={editingLog.projectId}
                    onChange={(e) => setEditingLog({ ...editingLog, projectId: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    {projects.map(project => (
                      <option key={project.id} value={project.id}>
                        {project.name}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Duration */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Duration (hours)
                  </label>
                  <input
                    type="number"
                    step="0.25"
                    min="0.25"
                    value={editingLog.duration}
                    onChange={(e) => setEditingLog({ ...editingLog, duration: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  />
                </div>

                {/* Date */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Date
                  </label>
                  <input
                    type="date"
                    value={new Date(editingLog.date).toISOString().split('T')[0]}
                    onChange={(e) => setEditingLog({ ...editingLog, date: new Date(e.target.value).getTime() })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  />
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Notes
                  </label>
                  <textarea
                    value={editingLog.notes || ''}
                    onChange={(e) => setEditingLog({ ...editingLog, notes: e.target.value })}
                    rows={3}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none"
                    placeholder="Optional notes..."
                  />
                </div>
              </div>

              <div className="flex gap-2 mt-6">
                <button
                  onClick={() => {
                    setShowEditModal(false);
                    setEditingLog(null);
                  }}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSaveEdit}
                  className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TimeLogsView;
</file>

<file path="src/components/UserInitializer.js">
'use client';

import { useEffect, useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import * as unifiedDB from '@/db/unifiedDB';

export default function UserInitializer({ children }) {
  const { currentUser } = useAuth();
  const [dbInitialized, setDbInitialized] = useState(false);

  useEffect(() => {
    console.log('ğŸ” Initializing user:', currentUser?.uid);
    if (currentUser?.uid) {
      console.log('ğŸ” User SET:', currentUser.uid);
      unifiedDB.setCurrentUser(currentUser.uid);
      setDbInitialized(true);
    } else {
      console.log('âš ï¸ No user - auth required');
      unifiedDB.setCurrentUser(null);
      setDbInitialized(true);
    }
  }, [currentUser]);

  // Don't render children until DB is initialized
  if (!dbInitialized) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="text-center">
          <div className="w-16 h-16 rounded-2xl mx-auto mb-4 overflow-hidden animate-pulse">
            <img src="/icons/icon-192x192.png" alt="RetireWise" className="w-full h-full" />
          </div>
          <p className="text-gray-600">Initializing...</p>
        </div>
      </div>
    );
  }

  return <>{children}</>;
}
</file>

<file path="src/services/aiService.js">
// src/services/aiService.js

import { getAllProjects, getAllTimeLogs, getAllJournalEntries } from '@/db/unifiedDB';
import { subDays, format } from 'date-fns';

// Get API key from environment variable (production) or settings (development)
const getApiKey = async () => {
  // In production (Vercel), use environment variable
  // - - - REACT_APP_ANTHROPIC_API_KEY
  if (process.env.NEXT_PUBLIC_ANTHROPIC_API_KEY) {
    return process.env.NEXT_PUBLIC_ANTHROPIC_API_KEY;
  }

    return process.env.NEXT_PUBLIC_ANTHROPIC_API_KEY;  
  // In development, fall back to settings
//  const settings = await db.settings.get('user_settings');
//  return settings?.ai?.apiKey || null;
};

// Agentic tools that Claude can use
const AGENTIC_TOOLS = [
  {
    name: 'get_recent_activity',
    description: 'Get user activity and time logs from the past N days',
    input_schema: {
      type: 'object',
      properties: {
        days: {
          type: 'number',
          description: 'Number of days to look back (default: 7)'
        }
      }
    }
  },
  {
    name: 'search_journal',
    description: 'Search through journal entries for topics, keywords, themes, or get recent entries. Can search by content, titles, tags, or entry types. If user asks what they\'ve been reflecting on, thinking about, or writing about, use this tool.',
    input_schema: {
      type: 'object',
      properties: {
        query: {
          type: 'string',
          description: 'Search query, keywords, or topic. Can be broad (e.g., "reflecting") or specific (e.g., "RetireWise milestone"). Leave empty to get most recent entries.'
        },
        limit: {
          type: 'number',
          description: 'Maximum number of results to return (default: 5)'
        }
      }
    }
  },
  {
    name: 'analyze_patterns',
    description: 'Analyze patterns in time allocation, energy levels, and project engagement',
    input_schema: {
      type: 'object',
      properties: {}
    }
  },
  {
    name: 'get_project_details',
    description: 'Get detailed information about a specific project',
    input_schema: {
      type: 'object',
      properties: {
        projectName: {
          type: 'string',
          description: 'Name of the project to get details for'
        }
      },
      required: ['projectName']
    }
  }
];

// Execute agentic tool functions
const executeToolFunction = async (toolName, toolInput) => {
  console.log(`ğŸ”§ Executing tool: ${toolName}`, toolInput);

  switch (toolName) {
    case 'get_recent_activity':
      return await getRecentActivity(toolInput.days || 7);
    
    case 'search_journal':
      return await searchJournal(toolInput.query, toolInput.limit || 5);
    
    case 'analyze_patterns':
      return await analyzePatterns();
    
    case 'get_project_details':
      return await getProjectDetails(toolInput.projectName);
    
    default:
      return { error: 'Unknown tool' };
  }
};

// Tool implementations

const getRecentActivity = async (days) => {
  const sinceDate = subDays(new Date(), days);
  
  // Use unifiedDB instead of Dexie
  const allTimeLogs = await getAllTimeLogs();
  const timeLogs = allTimeLogs.filter(log => 
    new Date(log.date) > sinceDate
  );
  
  const projects = await getAllProjects();
  
  // Aggregate by project
  const activityByProject = {};
  timeLogs.forEach(log => {
    if (!activityByProject[log.projectId]) {
      const project = projects.find(p => p.id === log.projectId);
      activityByProject[log.projectId] = {
        projectName: project?.name || 'Unknown',
        totalHours: 0,
        sessions: 0,
        activities: []
      };
    }
    activityByProject[log.projectId].totalHours += log.duration;
    activityByProject[log.projectId].sessions += 1;
    activityByProject[log.projectId].activities.push({
      date: format(new Date(log.date), 'MMM d'),
      hours: log.duration,
      activity: log.activityType,
      description: log.description
    });
  });
  
  return {
    period: `Last ${days} days`,
    totalHours: timeLogs.reduce((sum, log) => sum + log.duration, 0),
    projectBreakdown: Object.values(activityByProject),
    daysActive: new Set(timeLogs.map(l => format(new Date(l.date), 'yyyy-MM-dd'))).size
  };
};

const searchJournal = async (query, limit) => {
  // Use unifiedDB instead of Dexie
  const allEntries = await getAllJournalEntries();
  
  // If no specific query, return most recent entries
  if (!query || query.trim() === '') {
    const recent = allEntries
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .slice(0, limit);
    
    return {
      query: 'recent entries',
      resultsFound: recent.length,
      entries: recent.map(entry => ({
        date: format(new Date(entry.date), 'MMM d, yyyy'),
        title: entry.title || 'Untitled',
        entryType: entry.entryType,
        excerpt: entry.content.substring(0, 300),
        sentiment: entry.sentiment,
        projectId: entry.projectId,
        tags: entry.tags
      }))
    };
  }
  
  // Smart search: break query into keywords and search flexibly
  const queryLower = query.toLowerCase();
  const keywords = queryLower.split(/\s+/).filter(k => k.length > 2);
  
  const scoredEntries = allEntries.map(entry => {
    let score = 0;
    const contentLower = entry.content.toLowerCase();
    const titleLower = (entry.title || '').toLowerCase();
    
    // Exact phrase match (highest priority)
    if (contentLower.includes(queryLower) || titleLower.includes(queryLower)) {
      score += 10;
    }
    
    // Individual keyword matches
    keywords.forEach(keyword => {
      if (contentLower.includes(keyword)) score += 3;
      if (titleLower.includes(keyword)) score += 5;
      if (entry.tags?.some(tag => tag.toLowerCase().includes(keyword))) score += 4;
      if (entry.entryType.toLowerCase().includes(keyword)) score += 2;
    });
    
    // Recent entries get slight boost
    const daysOld = Math.floor((new Date() - new Date(entry.date)) / (1000 * 60 * 60 * 24));
    if (daysOld < 7) score += 1;
    
    return { ...entry, score };
  });
  
  const matches = scoredEntries
    .filter(entry => entry.score > 0)
    .sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return new Date(b.date) - new Date(a.date);
    })
    .slice(0, limit);
  
  // If no matches found, return most recent entries as fallback
  if (matches.length === 0) {
    const recent = allEntries
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .slice(0, Math.min(3, limit));
    
    return {
      query,
      resultsFound: 0,
      fallbackResults: recent.length,
      entries: recent.map(entry => ({
        date: format(new Date(entry.date), 'MMM d, yyyy'),
        title: entry.title || 'Untitled',
        entryType: entry.entryType,
        excerpt: entry.content.substring(0, 300),
        sentiment: entry.sentiment,
        projectId: entry.projectId,
        tags: entry.tags
      }))
    };
  }
  
  return {
    query,
    resultsFound: matches.length,
    entries: matches.map(entry => ({
      date: format(new Date(entry.date), 'MMM d, yyyy'),
      title: entry.title || 'Untitled',
      entryType: entry.entryType,
      excerpt: entry.content.substring(0, 300),
      sentiment: entry.sentiment,
      projectId: entry.projectId,
      tags: entry.tags,
      relevanceScore: entry.score
    }))
  };
};

const analyzePatterns = async () => {
  // Use unifiedDB instead of Dexie
  const projects = await getAllProjects();
  const allTimeLogs = await getAllTimeLogs();
  
  // Calculate time distribution by perspective (not type)
  const perspectiveDistribution = {};
  projects.forEach(project => {
    const perspective = project.perspective || 'unknown';
    if (!perspectiveDistribution[perspective]) {
      perspectiveDistribution[perspective] = 0;
    }
    perspectiveDistribution[perspective] += project.totalHoursLogged || 0;
  });
  
  const totalHours = Object.values(perspectiveDistribution).reduce((sum, h) => sum + h, 0);
  
  // Find most engaged project (by hours and recency)
  const activeProjects = projects
    .filter(p => (p.totalHoursLogged || 0) > 0)
    .sort((a, b) => {
      const aRecent = a.lastWorkedAt ? new Date(a.lastWorkedAt).getTime() : 0;
      const bRecent = b.lastWorkedAt ? new Date(b.lastWorkedAt).getTime() : 0;
      return bRecent - aRecent;
    });
  
  // Identify dormant projects
  const dormantProjects = projects.filter(p => {
    if (!p.lastWorkedAt) return true;
    const daysSinceWork = Math.floor(
      (new Date() - new Date(p.lastWorkedAt)) / (1000 * 60 * 60 * 24)
    );
    return daysSinceWork > 14 && p.status === 'active';
  });
  
  return {
    totalProjects: projects.length,
    totalHoursLogged: totalHours,
    perspectiveDistribution: Object.entries(perspectiveDistribution).map(([perspective, hours]) => ({
      perspective,
      hours,
      percentage: totalHours > 0 ? ((hours / totalHours) * 100).toFixed(1) : '0.0'
    })),
    mostEngagedProject: activeProjects[0]?.name || 'None',
    dormantProjects: dormantProjects.map(p => ({
      name: p.name,
      daysSinceWork: p.lastWorkedAt 
        ? Math.floor((new Date() - new Date(p.lastWorkedAt)) / (1000 * 60 * 60 * 24))
        : null
    })),
    overallMomentum: activeProjects.length > 0 ? 'Active' : 'Low'
  };
};

const getProjectDetails = async (projectName) => {
  // Use unifiedDB instead of Dexie
  const projects = await getAllProjects();
  const project = projects.find(p => 
    p.name.toLowerCase() === projectName.toLowerCase()
  );
  
  if (!project) {
    return { error: `Project "${projectName}" not found` };
  }
  
  const allTimeLogs = await getAllTimeLogs();
  const timeLogs = allTimeLogs.filter(log => log.projectId === project.id);
  
  const allJournalEntries = await getAllJournalEntries();
  const journalEntries = allJournalEntries.filter(entry => entry.projectId === project.id);
  
  return {
    name: project.name,
    perspective: project.perspective,
    status: project.status,
    description: project.description,
    motivation: project.motivation,
    goals: project.goals,
    totalHours: project.totalHoursLogged || 0,
    targetHours: project.targetHours || 0,
    timeLogCount: timeLogs.length,
    journalEntryCount: journalEntries.length,
    lastWorked: project.lastWorkedAt 
      ? format(new Date(project.lastWorkedAt), 'MMM d, yyyy')
      : 'Never',
    recentActivity: timeLogs
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .slice(0, 3)
      .map(log => ({
        date: format(new Date(log.date), 'MMM d'),
        hours: log.duration,
        activity: log.activityType
      }))
  };
};



// Main chat function
export const sendMessage = async (userMessage, conversationHistory = [], customSystemPrompt = null) => {
  try {
    // Get API key from settings
  //  const apiKey = await getApiKey();
  //  
  //  if (!apiKey) {
  //    throw new Error('No API key configured. Please add your Claude API key in Settings.');
  //  }
    
    // Build messages array for Claude
    const messages = [
      ...conversationHistory,
      {
        role: 'user',
        content: userMessage
      }
    ];
    
    // System prompt that defines the AI's role
    const systemPrompt = customSystemPrompt || `You are RetireWise AI, an intelligent advisor helping a retired person manage their portfolio of projects and activities.

The user retired 2 years ago and is experimenting with different activities including building projects, learning new skills, considering consulting, and exploring wildcards. They track their time, journal entries, and progress across multiple projects.

Your role is to:
- Help them think through decisions about where to focus
- Identify patterns in their activity and engagement
- Provide encouragement and constructive insights
- Ask thoughtful questions to help clarify their thinking
- Be friendly, supportive, and practical

You have access to tools that let you retrieve their actual data. Use these tools proactively when relevant to provide data-driven insights.

Keep responses conversational and concise (2-3 paragraphs max unless asked for more detail).`;

    // First API call - may result in tool use
    console.log('ğŸ¤– Calling Claude API...');

    // ADD THIS:
    if (customSystemPrompt) {
      console.log('ğŸ“Š Using portfolio-aware system prompt');
    }

// Determine API endpoint
// replaced - - const API_ENDPOINT = process.env.NODE_ENV === 'development'
// const API_ENDPOINT = process.env.NODE_ENV === 'development'
//  ? 'http://localhost:3001/api/chat'  // Your local proxy
//  : '/api/chat';  // Vercel serverless function

const API_ENDPOINT = '/api/chat';
  
// First API call
const response = await fetch(API_ENDPOINT, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    messages: messages,
    tools: AGENTIC_TOOLS,
    system: systemPrompt
  })
});

// ADD THESE LOGS:
console.log('ğŸ“¥ Response status:', response.status);
// const data = await response.json();
// console.log('ğŸ“¥ Response data:', data);


    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`Claude API error: ${errorData.error?.message || response.statusText}`);
    }

    const data = await response.json();
    console.log('ğŸ“¥ Claude response:', data);

    // Check if Claude wants to use tools
    if (data.stop_reason === 'tool_use') {
      
      const toolUses = data.content.filter(block => block.type === 'tool_use');
      console.log('ğŸ”§ Claude wants to use tools:', toolUses.length);
      
      // Execute all tool calls
      const toolResults = await Promise.all(
        toolUses.map(async (toolUse) => {
          const result = await executeToolFunction(toolUse.name, toolUse.input);
          return {
            type: 'tool_result',
            tool_use_id: toolUse.id,
            content: JSON.stringify(result)
          };
        })
      );
      
      // Build the assistant message with tool uses
      const assistantMessage = {
        role: 'assistant',
        content: data.content
      };
      
      // Build the user message with tool results
      const userMessage = {
        role: 'user',
        content: toolResults
      };
      
      // Second API call with tool results
      console.log('ğŸ¤– Calling Claude API with tool results...');

// Second API call (similar change)
const finalResponse = await fetch(API_ENDPOINT, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    messages: [
      ...messages,
      assistantMessage,
      userMessage
    ],
    system: systemPrompt
  })
});


      if (!finalResponse.ok) {
        const errorData = await finalResponse.json();
        console.error('âŒ Claude API error on tool result:', errorData);
        throw new Error('Claude API error on second call');
      }

      const finalData = await finalResponse.json();
      console.log('ğŸ“¥ Final Claude response:', finalData);
      console.log('ğŸ“ Final response content:', finalData.content);
      
      // Extract text response - handle both single text and multiple content blocks
      const textContent = finalData.content
        .filter(block => block.type === 'text')
        .map(block => block.text)
        .join('\n');
      
      console.log('âœ… Extracted text:', textContent);
      
      if (!textContent || textContent.trim() === '') {
        console.error('âš ï¸ No text content in response!');
        return {
          response: 'I analyzed the data but had trouble formatting the response. Let me try again - what would you like to know about your patterns?',
          toolsUsed: toolUses.map(t => t.name),
          contextUsed: toolResults.map(r => JSON.parse(r.content))
        };
      }
      
      return {
        response: textContent,
        toolsUsed: toolUses.map(t => t.name),
        contextUsed: toolResults.map(r => JSON.parse(r.content))
      };
    }
    
    // No tool use - direct response
    const textContent = data.content
      .filter(block => block.type === 'text')
      .map(block => block.text)
      .join('\n');
    
    return {
      response: textContent,
      toolsUsed: [],
      contextUsed: null
    };
    
  } catch (error) {
    console.error('âŒ AI Service Error:', error);
    throw error;
  }
};

export default { sendMessage };
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development'
});

const nextConfig = {
  reactStrictMode: true,
  distDir: '.next',
  output: 'standalone',
  turbopack: {}, // Add this to silence the warning
};

module.exports = withPWA(nextConfig);
</file>

<file path="public/manifest.json">
{
  "name": "RetireWise - Portfolio Hub",
  "short_name": "RetireWise",
  "description": "Your personal operating system for retirement",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#1a202c",
  "theme_color": "#3b82f6",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-256x256.png",
      "sizes": "256x256",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "screenshots": [
    {
      "src": "/screenshot-mobile.png",
      "sizes": "390x844",
      "type": "image/png",
      "form_factor": "narrow"
    }
  ],
  "categories": ["productivity", "lifestyle"],
  "shortcuts": [
    {
      "name": "Quick Log",
      "short_name": "Log",
      "description": "Log time quickly",
      "url": "/quick-log",
      "icons": [{"src": "/icon-log.png", "sizes": "96x96"}]
    },
    {
      "name": "Journal",
      "short_name": "Journal",
      "description": "Write a journal entry",
      "url": "/journal/new",
      "icons": [{"src": "/icon-journal.png", "sizes": "96x96"}]
    }
  ]  
}
</file>

<file path="src/app/analytics/page.js">
// src/app/analytics/page.js
'use client';

import React, { useState, useEffect } from 'react';
import AppLayout from '@/components/AppLayout';
import Analytics from '@/components/Analytics';
import PerspectiveAnalytics from '@/components/PerspectiveAnalytics';

export default function AnalyticsPage() {
  const [activeTab, setActiveTab] = useState('overview'); // 'overview' or 'perspectives'

  return (
    <AppLayout>
      <div className="max-w-7xl mx-auto px-4 py-6 pb-24">
        <h1 className="text-3xl font-bold text-gray-800 mb-6">Analytics</h1>

        {/* Tab Navigation */}
        <div className="flex gap-2 mb-6 border-b border-gray-200">
          <button
            onClick={() => setActiveTab('overview')}
            className={`px-4 py-2 font-medium transition-colors border-b-2 ${
              activeTab === 'overview'
                ? 'border-blue-600 text-blue-600'
                : 'border-transparent text-gray-600 hover:text-gray-800'
            }`}
          >
            Overview
          </button>
          <button
            onClick={() => setActiveTab('perspectives')}
            className={`px-4 py-2 font-medium transition-colors border-b-2 ${
              activeTab === 'perspectives'
                ? 'border-blue-600 text-blue-600'
                : 'border-transparent text-gray-600 hover:text-gray-800'
            }`}
          >
            By Perspective
          </button>
        </div>

        {/* Content */}
        {activeTab === 'overview' ? (
          <Analytics />
        ) : (
          <PerspectiveAnalytics />
        )}
      </div>
    </AppLayout>
  );
}
</file>

<file path="src/components/AIChat.js">
// src/components/AIChat.js
// COMPLETE VERSION: Firestore-only + Portfolio Context
'use client';

import React, { useState, useEffect, useRef } from 'react';
import { Send, Brain, Loader } from 'lucide-react';
import { sendMessage } from '@/services/aiService';
import { createConversation, getConversations, updateConversation } from '@/db/unifiedDB';
import { usePortfolioContext } from '@/hooks/usePortfolioContext';
import { generatePortfolioAwarePrompt } from '@/lib/ai-prompt-generator';

const AIChat = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [currentConversationId, setCurrentConversationId] = useState(null);
  const messagesEndRef = useRef(null);
  
  // Portfolio context for AI
  const { portfolioContext, loading: contextLoading } = usePortfolioContext();

  useEffect(() => {
    loadOrCreateConversation();
  }, []);

useEffect(() => {
  const timer = setTimeout(() => {
    scrollToBottom();
  }, 100);
  return () => clearTimeout(timer);
}, [messages]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const loadOrCreateConversation = async () => {
    try {
      // Get most recent conversation from Firestore
      const conversations = await getConversations();

      if (conversations.length > 0) {
        const conv = conversations[0];
        setCurrentConversationId(conv.id);
        setMessages(conv.messages || []);

        // Force scroll to bottom after loading conversation
        setTimeout(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, 150);

      } else {
        // Create initial conversation with welcome message
        const welcomeMessage = {
          role: 'assistant',
          content: "Hello! I'm your RetireWise AI advisor. I can help you think through your retirement activities, analyze patterns in your projects, and provide insights based on your portfolio data.\n\nTry asking me things like:\nâ€¢ How balanced is my portfolio right now?\nâ€¢ What should I focus on today?\nâ€¢ Analyze my recent activity patterns\nâ€¢ Which projects need attention?",
          timestamp: new Date().toISOString(),
          contextUsed: null
        };

        const conversationData = {
          title: 'New Conversation',
          messages: [welcomeMessage],
          conversationType: 'general'
        };

        const conversationId = await createConversation(conversationData);
        setCurrentConversationId(conversationId);
        setMessages([welcomeMessage]);
        
        setTimeout(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, 150);

      }
    } catch (error) {
      console.error('Error loading conversation:', error);
    }
  };

  const saveConversation = async (updatedMessages) => {
    if (!currentConversationId) return;

    try {
      await updateConversation(currentConversationId, {
        messages: updatedMessages,
        messageCount: updatedMessages.length
      });
    } catch (error) {
      console.error('Error saving conversation:', error);
    }
  };

  const handleSend = async () => {
    if (!input.trim() || isLoading) return;

    const userMessage = {
      role: 'user',
      content: input.trim(),
      timestamp: new Date().toISOString(),
      contextUsed: null
    };

    const updatedMessages = [...messages, userMessage];
    setMessages(updatedMessages);
    setInput('');
    setIsLoading(true);

    try {
      // Build conversation history for Claude (only role and content)
      const conversationHistory = messages.map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      // Generate portfolio-aware system prompt if context is available
      let systemPrompt = null;
      if (portfolioContext) {
        systemPrompt = generatePortfolioAwarePrompt(portfolioContext);
        console.log('ğŸ“Š Using portfolio-aware system prompt');
      }

      // Call AI service with portfolio context
      const result = await sendMessage(
        input.trim(), 
        conversationHistory,
        systemPrompt // Custom system prompt with portfolio data
      );

      const assistantMessage = {
        role: 'assistant',
        content: result.response,
        timestamp: new Date().toISOString(),
        contextUsed: {
          toolsUsed: result.toolsUsed || [],
          data: result.contextUsed,
          portfolioContext: portfolioContext ? {
            balanceScore: portfolioContext.balanceScore.score,
            grade: portfolioContext.balanceScore.grade
          } : null
        }
      };

      const finalMessages = [...updatedMessages, assistantMessage];
      setMessages(finalMessages);
      await saveConversation(finalMessages);

    } catch (error) {
      console.error('Error sending message:', error);
      
      const errorMessage = {
        role: 'assistant',
        content: `Sorry, I encountered an error: ${error.message}`,
        timestamp: new Date().toISOString(),
        contextUsed: null,
        isError: true
      };

      const finalMessages = [...updatedMessages, errorMessage];
      setMessages(finalMessages);
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const quickPrompts = [
    'How balanced is my portfolio?',
    'What should I focus on today?',
    'Analyze my recent patterns',
    'Which projects need attention?'
  ];

  // Show loading state while fetching portfolio context
  if (contextLoading) {
    return (
      <div className="flex items-center justify-center h-full">
        <div className="text-center">
          <Loader className="w-8 h-8 animate-spin text-blue-600 mx-auto mb-2" />
          <p className="text-gray-600">Loading your portfolio context...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full">
      {/* Portfolio Context Header */}
      {portfolioContext && (
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200 p-3">
          <div className="flex items-center justify-between text-sm">
            <div className="flex items-center gap-2">
              <Brain className="w-4 h-4 text-blue-600" />
              <span className="text-gray-700">
                Portfolio Balance: <strong className="text-blue-600">
                  {portfolioContext.balanceScore.score}/100
                </strong> (Grade: {portfolioContext.balanceScore.grade})
              </span>
            </div>
            <span className="text-gray-500 text-xs">
              {portfolioContext.totalHours}h tracked â€¢ {portfolioContext.activeProjects} active projects
            </span>
          </div>
        </div>
      )}

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] rounded-2xl p-4 ${
              msg.role === 'user'
                ? 'bg-blue-600 text-white'
                : msg.isError
                ? 'bg-red-50 border border-red-200 text-red-800'
                : 'bg-white border border-gray-200 shadow-sm'
            }`}>
              <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
              
              {/* Show tools used */}
              {msg.contextUsed && msg.contextUsed.toolsUsed && msg.contextUsed.toolsUsed.length > 0 && (
                <div className="mt-3 pt-3 border-t border-gray-100">
                  <div className="flex items-center gap-1 text-xs text-gray-500 mb-1">
                    <Brain className="w-3 h-3" />
                    <span className="font-medium">Tools used:</span>
                  </div>
                  <div className="flex flex-wrap gap-1">
                    {msg.contextUsed.toolsUsed.map((tool, i) => (
                      <span key={i} className="px-2 py-0.5 bg-blue-50 text-blue-700 text-xs rounded-full">
                        {tool}
                      </span>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Show portfolio context badge */}
              {msg.contextUsed?.portfolioContext && (
                <div className="mt-2 pt-2 border-t border-gray-100">
                  <div className="flex items-center gap-1 text-xs text-gray-500">
                    <span>ğŸ“Š Portfolio-aware response</span>
                  </div>
                </div>
              )}
              
              <p className="text-xs opacity-70 mt-2">
                {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
              </p>
            </div>
          </div>
        ))}
        
        {isLoading && (
          <div className="flex justify-start">
            <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
              <div className="flex items-center gap-2 text-gray-500">
                <Loader className="w-4 h-4 animate-spin" />
                <span className="text-sm">Thinking...</span>
              </div>
            </div>
          </div>
        )}
        
        <div ref={messagesEndRef} />
      </div>

      {/* Quick Prompts */}
      {messages.length <= 2 && (
        <div className="px-4 pb-3">
          <div className="flex gap-2 overflow-x-auto pb-2">
            {quickPrompts.map((prompt, idx) => (
              <button
                key={idx}
                onClick={() => setInput(prompt)}
                className="px-3 py-2 bg-gray-100 text-gray-700 text-xs rounded-full whitespace-nowrap hover:bg-gray-200 transition-colors flex-shrink-0"
              >
                {prompt}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Input */}
      <div className="bg-white border-t border-gray-200 p-4">
        <div className="flex gap-2">
          <textarea
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="Ask me anything about your portfolio..."
            disabled={isLoading}
            rows="1"
            className="flex-1 px-4 py-3 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none disabled:bg-gray-50 disabled:text-gray-500"
            style={{ minHeight: '48px', maxHeight: '120px' }}
          />
          <button
            onClick={handleSend}
            disabled={!input.trim() || isLoading}
            className="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex-shrink-0"
          >
            <Send className="w-5 h-5" />
          </button>
        </div>
      </div>
    </div>
  );
};

export default AIChat;
</file>

<file path="src/db/firestore/firestoreDB.js">
// src/db/firestore/firestoreDB.js
import { 
  collection, 
  doc, 
  addDoc, 
  getDoc, 
  getDocs, 
  setDoc,
  updateDoc, 
  deleteDoc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
  Timestamp
} from 'firebase/firestore';
import { db } from '@/config/firebase';

// ==================== HELPER FUNCTIONS ====================

// Get user's collection reference
const getUserCollection = (userId, collectionName) => {
  return collection(db, `users/${userId}/${collectionName}`);
};

// Convert Firestore timestamp to ISO string
const timestampToISO = (timestamp) => {
  if (!timestamp) return null;
  if (timestamp instanceof Timestamp) {
    return timestamp.toDate().toISOString();
  }
  return timestamp;
};

// ==================== PROJECTS ====================

export const createProject = async (userId, projectData) => {
  const ref = getUserCollection(userId, 'projects');
  const docRef = await addDoc(ref, {
    ...projectData,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Project created in Firestore:', docRef.id);
  return docRef.id;
};

export const getProjects = async (userId) => {
  const ref = getUserCollection(userId, 'projects');
  const snapshot = await getDocs(ref);
  
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: timestampToISO(doc.data().createdAt),
    updatedAt: timestampToISO(doc.data().updatedAt),
    lastWorkedAt: timestampToISO(doc.data().lastWorkedAt)
  }));
};

export const getProject = async (userId, projectId) => {
  const ref = doc(db, `users/${userId}/projects/${projectId}`);
  const snapshot = await getDoc(ref);
  
  if (!snapshot.exists()) return null;
  
  return {
    id: snapshot.id,
    ...snapshot.data(),
    createdAt: timestampToISO(snapshot.data().createdAt),
    updatedAt: timestampToISO(snapshot.data().updatedAt),
    lastWorkedAt: timestampToISO(snapshot.data().lastWorkedAt)
  };
};

export const updateProject = async (userId, projectId, updates) => {
  const ref = doc(db, `users/${userId}/projects/${projectId}`);
  await updateDoc(ref, {
    ...updates,
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Project updated in Firestore:', projectId);
};

export const deleteProject = async (userId, projectId) => {
  const ref = doc(db, `users/${userId}/projects/${projectId}`);
  await deleteDoc(ref);
  
  console.log('âœ… Project deleted from Firestore:', projectId);
};

// Real-time listener for projects
export const subscribeToProjects = (userId, callback) => {
  const ref = getUserCollection(userId, 'projects');
  
  return onSnapshot(ref, (snapshot) => {
    const projects = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      createdAt: timestampToISO(doc.data().createdAt),
      updatedAt: timestampToISO(doc.data().updatedAt),
      lastWorkedAt: timestampToISO(doc.data().lastWorkedAt)
    }));
    
    callback(projects);
  });
};

// ==================== TIME LOGS ====================

export const createTimeLog = async (userId, logData) => {
  const ref = getUserCollection(userId, 'timeLogs');
  const docRef = await addDoc(ref, {
    ...logData,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Time log created in Firestore:', docRef.id);
  return docRef.id;
};

export const getTimeLogs = async (userId, projectId = null) => {
  const ref = getUserCollection(userId, 'timeLogs');
  
  let q;
  if (projectId) {
    q = query(ref, where('projectId', '==', projectId), orderBy('date', 'desc'));
  } else {
    q = query(ref, orderBy('date', 'desc'));
  }
  
  const snapshot = await getDocs(q);
  
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: timestampToISO(doc.data().createdAt),
    updatedAt: timestampToISO(doc.data().updatedAt)
  }));
};

export const updateTimeLog = async (userId, logId, updates) => {
  const ref = doc(db, `users/${userId}/timeLogs/${logId}`);
  await updateDoc(ref, {
    ...updates,
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Time log updated in Firestore:', logId);
};

export const deleteTimeLog = async (userId, logId) => {
  const ref = doc(db, `users/${userId}/timeLogs/${logId}`);
  await deleteDoc(ref);
  
  console.log('âœ… Time log deleted from Firestore:', logId);
};

// ==================== JOURNAL ENTRIES ====================

export const createJournalEntry = async (userId, entryData) => {
  const ref = getUserCollection(userId, 'journalEntries');
  const docRef = await addDoc(ref, {
    ...entryData,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Journal entry created in Firestore:', docRef.id);
  return docRef.id;
};

export const getJournalEntries = async (userId) => {
  const ref = getUserCollection(userId, 'journalEntries');
  const q = query(ref, orderBy('date', 'desc'));
  const snapshot = await getDocs(q);
  
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: timestampToISO(doc.data().createdAt),
    updatedAt: timestampToISO(doc.data().updatedAt)
  }));
};

export const updateJournalEntry = async (userId, entryId, updates) => {
  const ref = doc(db, `users/${userId}/journalEntries/${entryId}`);
  await updateDoc(ref, {
    ...updates,
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Journal entry updated in Firestore:', entryId);
};

export const deleteJournalEntry = async (userId, entryId) => {
  const ref = doc(db, `users/${userId}/journalEntries/${entryId}`);
  await deleteDoc(ref);
  
  console.log('âœ… Journal entry deleted from Firestore:', entryId);
};

// ==================== INSIGHTS ====================


export const createInsight = async (userId, insightData) => {
  const ref = getUserCollection(userId, 'insights');
  const docRef = await addDoc(ref, {
    ...insightData,
    dismissed: false,
    dismissedAt: null,
    dismissReason: null,
    actedOn: false,
    actedOnAt: null,
    userFeedback: null,
    createdAt: serverTimestamp(),
    lastShownAt: serverTimestamp()
  });
  
  console.log('âœ… Insight created in Firestore:', docRef.id);
  return docRef.id;
};


export const getInsights = async (userId) => {
  const ref = getUserCollection(userId, 'insights');
  //   const q = query(ref, orderBy('generatedAt', 'desc'));
  const q = query(ref, orderBy('createdAt', 'desc'));
  const snapshot = await getDocs(q);
  
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: timestampToISO(doc.data().createdAt)
  }));
};

export const updateInsight = async (userId, insightId, updates) => {
  const ref = doc(db, `users/${userId}/insights/${insightId}`);
  await updateDoc(ref, updates);
  
  console.log('âœ… Insight updated in Firestore:', insightId);
};

export const deleteInsight = async (userId, insightId) => {
  const ref = doc(db, `users/${userId}/insights/${insightId}`);
  await deleteDoc(ref);
  
  console.log('âœ… Insight deleted from Firestore:', insightId);
};

// ==================== CONVERSATIONS (AI Chat) ====================

export const createConversation = async (userId, conversationData) => {
  const ref = getUserCollection(userId, 'conversations');
  const docRef = await addDoc(ref, {
    ...conversationData,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Conversation created in Firestore:', docRef.id);
  return docRef.id;
};

export const getConversations = async (userId) => {
  const ref = getUserCollection(userId, 'conversations');
  const q = query(ref, orderBy('updatedAt', 'desc'));
  const snapshot = await getDocs(q);
  
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: timestampToISO(doc.data().createdAt),
    updatedAt: timestampToISO(doc.data().updatedAt)
  }));
};

export const updateConversation = async (userId, conversationId, updates) => {
  const ref = doc(db, `users/${userId}/conversations/${conversationId}`);
  await updateDoc(ref, {
    ...updates,
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… Conversation updated in Firestore:', conversationId);
};

// Add after updateConversation in firestoreDB.js (around line 250)
export const deleteConversation = async (userId, conversationId) => {
  const ref = doc(db, `users/${userId}/conversations/${conversationId}`);
  await deleteDoc(ref);
  
  console.log('âœ… Conversation deleted from Firestore:', conversationId);
};

// ==================== USER PROFILE ====================

export const createUserProfile = async (userId, profileData) => {
  const ref = doc(db, `users/${userId}`);
  await setDoc(ref, {
    ...profileData,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… User profile created in Firestore');
};

export const getUserProfile = async (userId) => {
  const ref = doc(db, `users/${userId}`);
  const snapshot = await getDoc(ref);
  
  if (!snapshot.exists()) return null;
  
  return {
    ...snapshot.data(),
    createdAt: timestampToISO(snapshot.data().createdAt),
    updatedAt: timestampToISO(snapshot.data().updatedAt)
  };
};

export const updateUserProfile = async (userId, updates) => {
  const ref = doc(db, `users/${userId}`);
  await updateDoc(ref, {
    ...updates,
    updatedAt: serverTimestamp()
  });
  
  console.log('âœ… User profile updated in Firestore');
};

// ==================== PORTFOLIO ====================

export const getPortfolio = async (userId) => {
  const ref = doc(db, `users/${userId}`);
  const snapshot = await getDoc(ref);
  
  if (!snapshot.exists()) return null;
  
  const data = snapshot.data();
  return data.portfolio || null;
};

export const updatePortfolio = async (userId, portfolioData) => {
  const ref = doc(db, `users/${userId}`);
  await setDoc(ref, {
    portfolio: portfolioData,
    updatedAt: serverTimestamp()
  }, { merge: true }); // â† This is the fix
  
  console.log('âœ… Portfolio updated in Firestore');
};

export const calculatePortfolioBalance = async (userId) => {
  // Get all projects and time logs
  const projects = await getProjects(userId);
  const timeLogs = await getTimeLogs(userId);
  
  // Calculate time per perspective
  const perspectiveHours = {
    builder: 0,
    contributor: 0,
    integrator: 0,
    experimenter: 0
  };
  
  // Map project IDs to perspectives
  const projectPerspectives = {};
  projects.forEach(p => {
    if (p.perspective) {
      projectPerspectives[p.id] = p.perspective;
    }
  });
  
  // Sum hours by perspective
  timeLogs.forEach(log => {
    const perspective = projectPerspectives[log.projectId];
    if (perspective && perspectiveHours[perspective] !== undefined) {
      perspectiveHours[perspective] += log.duration;
    }
  });
  
  // Calculate percentages
  const totalHours = Object.values(perspectiveHours).reduce((sum, h) => sum + h, 0);
  
  const actualBalance = {
    builder: totalHours > 0 ? (perspectiveHours.builder / totalHours) * 100 : 0,
    contributor: totalHours > 0 ? (perspectiveHours.contributor / totalHours) * 100 : 0,
    integrator: totalHours > 0 ? (perspectiveHours.integrator / totalHours) * 100 : 0,
    experimenter: totalHours > 0 ? (perspectiveHours.experimenter / totalHours) * 100 : 0
  };
  
  return {
    actualBalance,
    totalHours,
    perspectiveHours,
    lastCalculated: new Date().toISOString()
  };
};

export default {
  // Projects
  createProject,
  getProjects,
  getProject,
  updateProject,
  deleteProject,
  subscribeToProjects,
  
  // Time Logs
  createTimeLog,
  getTimeLogs,
  updateTimeLog,
  deleteTimeLog,
  
  // Journal
  createJournalEntry,
  getJournalEntries,
  updateJournalEntry,
  deleteJournalEntry,
  
  // Insights
  createInsight,
  getInsights,
  updateInsight,
  deleteInsight,
  
  // Conversations
  createConversation,
  getConversations,
  updateConversation,
  deleteConversation,
  
  // User Profile
  createUserProfile,
  getUserProfile,
  updateUserProfile,

  // Portfolio
  getPortfolio,
  updatePortfolio,
  calculatePortfolioBalance  
};
</file>

<file path="src/db/unifiedDB.js">
// src/db/unifiedDB.js
// Simplified - Firestore only (no Dexie)
import * as firestoreDB from '@/db/firestore/firestoreDB';

let currentUserId = null;

// Set the current user ID (call this when user logs in)
export const setCurrentUser = (userId) => {
  currentUserId = userId;
  console.log('ğŸ“Š Database user set:', userId || 'Not logged in');
};

// Helper to ensure user is authenticated
const requireAuth = () => {
  if (!currentUserId) {
    throw new Error('User must be authenticated. Please log in.');
  }
  return currentUserId;
};

// ==================== PROJECTS ====================

export const getAllProjects = async () => {
  const userId = requireAuth();
  return await firestoreDB.getProjects(userId);
};

export const getActiveProjects = async () => {
  const projects = await getAllProjects();
  return projects.filter(p => p.status === 'active');
};

export const getProject = async (projectId) => {
  const userId = requireAuth();
  return await firestoreDB.getProject(userId, projectId);
};

export const getProjectWithStats = async (projectId) => {
  const userId = requireAuth();
  const project = await firestoreDB.getProject(userId, projectId);
  if (!project) return null;
  
  const allLogs = await firestoreDB.getTimeLogs(userId);
  const projectLogs = allLogs.filter(log => log.projectId === projectId);
  
  // Calculate stats
  const now = new Date();
  const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
  
  const lastWeekLogs = projectLogs.filter(log => new Date(log.date) >= oneWeekAgo);
  const previousWeekLogs = projectLogs.filter(log => {
    const logDate = new Date(log.date);
    return logDate >= twoWeeksAgo && logDate < oneWeekAgo;
  });
  
  const lastWeekHours = lastWeekLogs.reduce((sum, log) => sum + log.duration, 0);
  const previousWeekHours = previousWeekLogs.reduce((sum, log) => sum + log.duration, 0);
  const weeklyChange = previousWeekHours > 0 
    ? ((lastWeekHours - previousWeekHours) / previousWeekHours) * 100 
    : 0;
  
  const stats = {
    lastWeekHours,
    previousWeekHours,
    weeklyChange,
    totalHours: project.totalHoursLogged || 0,
    targetHours: project.targetHours || 0,
    completionRate: project.targetHours > 0 
      ? ((project.totalHoursLogged || 0) / project.targetHours) * 100 
      : 0
  };
  
  return { project, stats };
};

export const createProject = async (projectData) => {
  const userId = requireAuth();
  const id = await firestoreDB.createProject(userId, projectData);
  return { id, ...projectData };
};

export const updateProject = async (projectId, updates) => {
  const userId = requireAuth();
  await firestoreDB.updateProject(userId, projectId, updates);
};

export const deleteProject = async (projectId) => {
  const userId = requireAuth();
  await firestoreDB.deleteProject(userId, projectId);
};

// Real-time subscription
export const subscribeToProjects = (callback) => {
  const userId = requireAuth();
  return firestoreDB.subscribeToProjects(userId, callback);
};

// ==================== TIME LOGS ====================

export const getAllTimeLogs = async () => {
  const userId = requireAuth();
  const logs = await firestoreDB.getTimeLogs(userId);
  
  // Enrich with project data
  const projects = await getAllProjects();
  const projectMap = projects.reduce((map, p) => {
    map[p.id] = p;
    return map;
  }, {});
  
  return logs.map(log => ({
    ...log,
    projectName: projectMap[log.projectId]?.name || 'Unknown',
    projectColor: projectMap[log.projectId]?.color,
    projectIcon: projectMap[log.projectId]?.icon
  }));
};

export const getTodayTimeLogs = async () => {
  const userId = requireAuth();
  const allLogs = await firestoreDB.getTimeLogs(userId);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  
  return allLogs.filter(log => {
    const logDate = new Date(log.date);
    return logDate >= today && logDate < tomorrow;
  });
};

export const createTimeLog = async (logData) => {
  const userId = requireAuth();
  const id = await firestoreDB.createTimeLog(userId, logData);
  
  // Update project hours
  const project = await getProject(logData.projectId);
  if (project) {
    await updateProject(logData.projectId, {
      totalHoursLogged: (project.totalHoursLogged || 0) + logData.duration,
      lastWorkedAt: logData.date
    });
  }
  
  return { id, ...logData };
};

export const updateTimeLog = async (logId, updates) => {
  const userId = requireAuth();
  
  // Get old log to calculate hour difference
  const allLogs = await firestoreDB.getTimeLogs(userId);
  const oldLog = allLogs.find(l => l.id === logId);
  
  await firestoreDB.updateTimeLog(userId, logId, updates);
  
  // Update project hours if duration or project changed
  if (oldLog && (updates.duration !== undefined || updates.projectId !== undefined)) {
    const oldProject = await getProject(oldLog.projectId);
    const newProjectId = updates.projectId || oldLog.projectId;
    const newDuration = updates.duration !== undefined ? updates.duration : oldLog.duration;
    
    // Remove hours from old project
    if (oldProject) {
      await updateProject(oldLog.projectId, {
        totalHoursLogged: Math.max(0, oldProject.totalHoursLogged - oldLog.duration)
      });
    }
    
    // Add hours to new project
    const newProject = await getProject(newProjectId);
    if (newProject) {
      await updateProject(newProjectId, {
        totalHoursLogged: (newProject.totalHoursLogged || 0) + newDuration,
        lastWorkedAt: updates.date || oldLog.date
      });
    }
  }
};

export const deleteTimeLog = async (logId) => {
  const userId = requireAuth();
  
  // Get log to update project hours
  const allLogs = await firestoreDB.getTimeLogs(userId);
  const log = allLogs.find(l => l.id === logId);
  
  await firestoreDB.deleteTimeLog(userId, logId);
  
  // Update project hours
  if (log) {
    const project = await getProject(log.projectId);
    if (project) {
      await updateProject(log.projectId, {
        totalHoursLogged: Math.max(0, project.totalHoursLogged - log.duration)
      });
    }
  }
};

// ==================== JOURNAL ====================

export const getAllJournalEntries = async () => {
  const userId = requireAuth();
  return await firestoreDB.getJournalEntries(userId);
};

export const createJournalEntry = async (entryData) => {
  const userId = requireAuth();
  const id = await firestoreDB.createJournalEntry(userId, entryData);
  return { id, ...entryData };
};

export const updateJournalEntry = async (entryId, updates) => {
  const userId = requireAuth();
  await firestoreDB.updateJournalEntry(userId, entryId, updates);
};

export const deleteJournalEntry = async (entryId) => {
  const userId = requireAuth();
  await firestoreDB.deleteJournalEntry(userId, entryId);
};

// ==================== ANALYTICS & STATS ====================

export const getTimeLogStats = async () => {
  const userId = requireAuth();
  const logs = await firestoreDB.getTimeLogs(userId);
  
  const now = new Date();
  const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  const thisWeekLogs = logs.filter(log => new Date(log.date) >= oneWeekAgo);
  
  // Calculate by day
  const byDay = { Sun: 0, Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0 };
  logs.forEach(log => {
    const day = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][new Date(log.date).getDay()];
    byDay[day] += log.duration;
  });
  
  // Calculate by activity
  const byActivity = {};
  logs.forEach(log => {
    if (log.activity) {
      byActivity[log.activity] = (byActivity[log.activity] || 0) + log.duration;
    }
  });
  
  return {
    totalHours: logs.reduce((sum, log) => sum + log.duration, 0),
    thisWeek: thisWeekLogs.reduce((sum, log) => sum + log.duration, 0),
    totalLogs: logs.length,
    averageSessionLength: logs.length > 0 ? logs.reduce((sum, log) => sum + log.duration, 0) / logs.length : 0,
    averageEnergy: logs.filter(l => l.energy).length > 0 
      ? logs.filter(l => l.energy).reduce((sum, l) => sum + l.energy, 0) / logs.filter(l => l.energy).length 
      : 0,
    averageProductivity: logs.filter(l => l.productivity).length > 0
      ? logs.filter(l => l.productivity).reduce((sum, l) => sum + l.productivity, 0) / logs.filter(l => l.productivity).length
      : 0,
    averageEnjoyment: logs.filter(l => l.enjoyment).length > 0
      ? logs.filter(l => l.enjoyment).reduce((sum, l) => sum + l.enjoyment, 0) / logs.filter(l => l.enjoyment).length
      : 0,
    byDay,
    byActivity
  };
};

export const getJournalStats = async () => {
  const userId = requireAuth();
  const entries = await firestoreDB.getJournalEntries(userId);
  
  const now = new Date();
  const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const thisWeekEntries = entries.filter(e => new Date(e.createdAt) >= oneWeekAgo);
  
  return {
    total: entries.length,
    thisWeek: thisWeekEntries.length
  };
};

// ==================== INSIGHTS ====================

export const getActiveInsights = async () => {
  const userId = requireAuth();
  const insights = await firestoreDB.getInsights(userId);
  
  // Filter out dismissed insights
  return insights.filter(i => i.dismissed !== true);
};

export const dismissInsight = async (insightId, reason = null) => {
  const userId = requireAuth();
  await firestoreDB.updateInsight(userId, insightId, {
    dismissed: true,
    dismissedAt: new Date().toISOString(),
    dismissReason: reason
  });
};

export const markInsightActedOn = async (insightId) => {
  const userId = requireAuth();
  await firestoreDB.updateInsight(userId, insightId, {
    actedOn: true,
    actedOnAt: new Date().toISOString()
  });
};

export const provideFeedback = async (insightId, feedback) => {
  const userId = requireAuth();
  await firestoreDB.updateInsight(userId, insightId, {
    userFeedback: feedback,
    feedbackAt: new Date().toISOString()
  });
};

export const generateInsights = async () => {
  const userId = requireAuth();
  
  console.log('ğŸ” generateInsights() CALLED');
  
  const insights = [];
  
  // Get data for analysis
  console.log('ğŸ“Š Fetching data...');
  const projects = await getAllProjects();
  const timeLogs = await getAllTimeLogs();
  const journalEntries = await getAllJournalEntries();
  
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
  const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
  
  console.log(`ğŸ“Š Data: ${projects.length} projects, ${timeLogs.length} logs, ${journalEntries.length} journals`);
  
  // ==================== PERSPECTIVE INSIGHTS ====================
  
  // Calculate perspective distribution
  const perspectiveHours = {
    builder: 0,
    contributor: 0,
    integrator: 0,
    experimenter: 0
  };
  
  const projectPerspectives = {};
  projects.forEach(p => {
    if (p.perspective) {
      projectPerspectives[p.id] = p.perspective;
    }
  });
  
  timeLogs.forEach(log => {
    const perspective = projectPerspectives[log.projectId];
    if (perspective && perspectiveHours[perspective] !== undefined) {
      perspectiveHours[perspective] += log.duration;
    }
  });
  
  const totalHours = Object.values(perspectiveHours).reduce((sum, h) => sum + h, 0);
  
  console.log('âš–ï¸ Perspective Hours:', perspectiveHours);
  console.log('âš–ï¸ Total Hours:', totalHours);

  const perspectiveBalance = {
    builder: totalHours > 0 ? (perspectiveHours.builder / totalHours) * 100 : 0,
    contributor: totalHours > 0 ? (perspectiveHours.contributor / totalHours) * 100 : 0,
    integrator: totalHours > 0 ? (perspectiveHours.integrator / totalHours) * 100 : 0,
    experimenter: totalHours > 0 ? (perspectiveHours.experimenter / totalHours) * 100 : 0
  };
  
  console.log('âš–ï¸ Balance:', perspectiveBalance);

  // Check for overconcentration in one perspective
  console.log('ğŸ” Checking overconcentration...');

  Object.entries(perspectiveBalance).forEach(([perspective, percentage]) => {
    if (percentage > 70 && totalHours > 10) {
      const perspectiveNames = {
        builder: 'Builder',
        contributor: 'Contributor',
        integrator: 'Integrator',
        experimenter: 'Experimenter'
      };
      
      const perspectiveIcons = {
        builder: 'ğŸ”¨',
        contributor: 'ğŸ¤',
        integrator: 'ğŸ”„',
        experimenter: 'ğŸ§ª'
      };
      
      const suggestions = {
        builder: 'Consider adding Experimenter activities to explore new interests, or Contributor projects to give back.',
        contributor: 'Balance with Builder projects to create tangible outputs, or Experimenter activities to learn new skills.',
        integrator: 'Add Builder projects for concrete outcomes, or Experimenter activities for fresh perspectives.',
        experimenter: 'Consider Builder projects to apply your learnings, or Contributor work to share your knowledge.'
      };
      
      insights.push({
        type: 'balance',
        title: `${perspectiveIcons[perspective]} Portfolio Heavily Weighted Toward ${perspectiveNames[perspective]}`,
        description: `You're spending ${percentage.toFixed(0)}% of your time on ${perspectiveNames[perspective]} projects. ${suggestions[perspective]}`,
        confidence: 0.85,
        actionable: true,
        suggestedActions: [
          'Review your portfolio balance on the Portfolio page',
          'Start a project in an underrepresented perspective',
          'Set target percentages for each perspective'
        ],
        priority: 'medium',
        basedOn: {
          perspective,
          percentage: percentage.toFixed(1),
          totalHours
        }
      });
    }
  });
  
  // Check for missing perspectives
  const missingPerspectives = Object.entries(perspectiveBalance)
    .filter(([_, percentage]) => percentage === 0 && totalHours > 5)
    .map(([perspective, _]) => perspective);
  
  if (missingPerspectives.length > 0) {
    const perspectiveNames = {
      builder: 'Builder',
      contributor: 'Contributor', 
      integrator: 'Integrator',
      experimenter: 'Experimenter'
    };
    
    const perspectiveDescriptions = {
      builder: 'create something tangible like a product, book, or business',
      contributor: 'give back through teaching, mentoring, or volunteering',
      integrator: 'connect different interests and explore interdisciplinary ideas',
      experimenter: 'learn new skills and try new things without pressure to complete'
    };
    
    const names = missingPerspectives.map(p => perspectiveNames[p]).join(' and ');
    const descriptions = missingPerspectives.map(p => perspectiveDescriptions[p]).join(', or ');
    
    insights.push({
      type: 'suggestion',
      title: `Missing Perspective${missingPerspectives.length > 1 ? 's' : ''}: ${names}`,
      description: `You haven't logged any ${names} activities yet. Consider starting a project to ${descriptions}.`,
      confidence: 0.7,
      actionable: true,
      suggestedActions: [
        `Create a ${perspectiveNames[missingPerspectives[0]]} project`,
        'Explore the Portfolio page for ideas',
        'Review the perspective descriptions for inspiration'
      ],
      priority: 'low',
      basedOn: {
        missingPerspectives,
        totalHours
      }
    });
  }
  
  // Additional insights logic continues...
  // (I'll include more in the final version, but keeping this shorter for readability)
  
  // Save all generated insights to Firestore
  const savedInsights = [];
  for (const insightData of insights) {
    try {
      const id = await firestoreDB.createInsight(userId, insightData);
      savedInsights.push({ id, ...insightData });
    } catch (error) {
      console.error('Error saving insight:', error);
    }
  }
  
  console.log(`âœ… Generated ${savedInsights.length} insights`);
  
  return savedInsights;
};

// ==================== CONVERSATIONS (AI Chat) ====================

export const createConversation = async (conversationData) => {
  const userId = requireAuth();
  const id = await firestoreDB.createConversation(userId, conversationData);
  return id;
};

export const getConversations = async () => {
  const userId = requireAuth();
  return await firestoreDB.getConversations(userId);
};

export const getConversation = async (conversationId) => {
  const userId = requireAuth();
  const conversations = await firestoreDB.getConversations(userId);
  return conversations.find(c => c.id === conversationId) || null;
};

export const updateConversation = async (conversationId, updates) => {
  const userId = requireAuth();
  await firestoreDB.updateConversation(userId, conversationId, updates);
};

export const deleteConversation = async (conversationId) => {
  const userId = requireAuth();
  // Note: firestoreDB might not have deleteConversation, 
  // so we'll need to add that too
  await firestoreDB.deleteConversation(userId, conversationId);
};

// ==================== PORTFOLIO ====================

export const getPortfolio = async () => {
  const userId = requireAuth();
  return await firestoreDB.getPortfolio(userId);
};

export const updatePortfolio = async (portfolioData) => {
  const userId = requireAuth();
  await firestoreDB.updatePortfolio(userId, portfolioData);
};

export const calculatePortfolioBalance = async () => {
  const userId = requireAuth();
  return await firestoreDB.calculatePortfolioBalance(userId);
};

export const getProjectsByPerspective = async (perspective) => {
  const projects = await getAllProjects();
  return projects.filter(p => p.perspective === perspective);
};

export const getPerspectiveStats = async () => {
  const projects = await getAllProjects();
  const balance = await calculatePortfolioBalance();
  
  const stats = {
    builder: { count: 0, hours: balance.perspectiveHours.builder },
    contributor: { count: 0, hours: balance.perspectiveHours.contributor },
    integrator: { count: 0, hours: balance.perspectiveHours.integrator },
    experimenter: { count: 0, hours: balance.perspectiveHours.experimenter }
  };
  
  projects.forEach(p => {
    if (p.perspective && stats[p.perspective]) {
      stats[p.perspective].count++;
    }
  });
  
  return stats;
};

// ==================== USER PROFILE ====================
// Add this section AFTER Portfolio functions and BEFORE the default export

export const getUserProfile = async () => {
  const userId = requireAuth();
  return await firestoreDB.getUserProfile(userId);
};

export const updateUserProfile = async (updates) => {
  const userId = requireAuth();
  await firestoreDB.updateUserProfile(userId, updates);
};

export const createUserProfile = async (profileData) => {
  const userId = requireAuth();
  await firestoreDB.createUserProfile(userId, profileData);
};


export default {
  setCurrentUser,
  
  // Projects
  getAllProjects,
  getActiveProjects,
  getProject,
  getProjectWithStats,
  createProject,
  updateProject,
  deleteProject,
  subscribeToProjects,
  
  // Time Logs
  getAllTimeLogs,
  getTodayTimeLogs,
  createTimeLog,
  updateTimeLog,
  deleteTimeLog,
  
  // Journal
  getAllJournalEntries,
  createJournalEntry,
  updateJournalEntry,
  deleteJournalEntry,
  
  // Analytics & Stats
  getTimeLogStats,
  getJournalStats,
  
  // Insights
  getActiveInsights,
  dismissInsight,
  markInsightActedOn,
  provideFeedback,
  generateInsights,

    // Conversations (ADD THESE LINES) â† NEW
  createConversation,
  getConversations,
  getConversation,
  updateConversation,
  deleteConversation,

  // Portfolio
  getPortfolio,
  updatePortfolio,
  calculatePortfolioBalance,
  getProjectsByPerspective,
  getPerspectiveStats,
  
    // User Profile
  getUserProfile,
  updateUserProfile,
  createUserProfile
};
</file>

<file path="package.json">
{
  "name": "retirewise-nextjs",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "NEXT_PRIVATE_TURBOPACK=0 next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "date-fns": "^4.1.0",
    "dotenv": "^17.2.3",
    "firebase": "^12.6.0",
    "lucide-react": "^0.561.0",
    "next": "16.0.10",
    "next-pwa": "^5.6.0",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "recharts": "^3.5.1"
  },
  "devDependencies": {
    "@types/node": "^25.0.3",
    "@types/react": "^19.2.7",
    "@types/react-dom": "^19.2.3",
    "autoprefixer": "^10.4.23",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "postcss": "^8.5.6",
    "tailwindcss": "3.4.17",
    "typescript": "^5.9.3",
    "webpack": "^5.103.0"
  }
}
</file>

<file path="src/app/projects/[id]/page.js">
'use client';

import { useRouter, useParams } from 'next/navigation';
import AppLayout from '@/components/AppLayout';
import ProjectDetails from '@/components/ProjectDetails';
import ProjectForm from '@/components/ProjectForm';

export default function ProjectDetailPage() {
  const router = useRouter();
  const params = useParams();

  // Handle "new" project route
  if (params.id === 'new') {
    return (
      <AppLayout>
        <ProjectForm
          onClose={() => router.push('/projects')}
          onSaved={() => router.push('/projects')}
        />
      </AppLayout>
    );
  }

  // Regular project detail
  return (
    <AppLayout>
      <ProjectDetails projectId={params.id} />
    </AppLayout>
  );
}
</file>

<file path="src/app/layout.js">
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/contexts/AuthContext';
import UserInitializer from '@/components/UserInitializer';
import { MobileNav } from '@/components/MobileNav';

const inter = Inter({ subsets: ['latin'] });

export const metadata = {
  title: 'RetireWise',
  description: 'Your intelligent retirement portfolio advisor',
  manifest: '/manifest.json',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: 'RetireWise',
  },
};

export const viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  themeColor: '#3B82F6',
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <head>
        <link rel="icon" href="/favicon.ico" />
        <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
      </head>
      <body className={inter.className}>
        <AuthProvider>
          <UserInitializer>
            {children}

          </UserInitializer>
        </AuthProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/app/projects/page.js">
// src/app/projects/page.js
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { ArrowLeft } from 'lucide-react';
import AppLayout from '@/components/AppLayout.js';
import ProjectsListView from '@/components/ProjectsListView';
import * as unifiedDB from '@/db/unifiedDB';
import { getAllPerspectives, getPerspective } from '@/utils/perspectiveHelpers';

export default function ProjectsPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedPerspective, setSelectedPerspective] = useState(searchParams.get('perspective') || 'all');

  useEffect(() => {
    const unsubscribe = unifiedDB.subscribeToProjects((updatedProjects) => {
      setProjects(updatedProjects);
      setLoading(false);
    });

    return () => {
      if (unsubscribe) unsubscribe();
    };
  }, []);

  // Filter projects by perspective
  const filteredProjects = selectedPerspective === 'all' 
    ? projects 
    : projects.filter(p => p.perspective === selectedPerspective);

  const perspectives = getAllPerspectives();
  const currentPerspective = selectedPerspective !== 'all' ? getPerspective(selectedPerspective) : null;

  return (
    <AppLayout>
      <div className="max-w-7xl mx-auto px-4 py-6 pb-24">
        {/* Header with Back Button */}
        <div className="flex items-center gap-4 mb-6">
          {selectedPerspective !== 'all' && (
            <button
              onClick={() => setSelectedPerspective('all')}
              className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <ArrowLeft className="w-6 h-6 text-gray-600" />
            </button>
          )}
          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-800">
              {currentPerspective ? (
                <span className="flex items-center gap-2">
                  <span>{currentPerspective.icon}</span>
                  <span>{currentPerspective.label} Projects</span>
                </span>
              ) : (
                'Projects'
              )}
            </h1>
          </div>
        </div>

        {/* Perspective Filter Tabs */}
        <div className="mb-6">
          <h2 className="text-lg font-semibold text-gray-700 mb-3">Filter by Perspective</h2>
          
          <div className="overflow-x-auto">
            <div className="flex gap-2 min-w-max pb-2">
              <button
                onClick={() => setSelectedPerspective('all')}
                className={`px-4 py-2 rounded-lg font-medium transition-all ${
                  selectedPerspective === 'all'
                    ? 'bg-gray-800 text-white shadow-md'
                    : 'bg-white text-gray-600 border border-gray-200 hover:border-gray-300'
                }`}
              >
                All Projects ({projects.length})
              </button>

              {perspectives.map((perspective) => {
                const count = projects.filter(p => p.perspective === perspective.id).length;
                return (
                  <button
                    key={perspective.id}
                    onClick={() => setSelectedPerspective(perspective.id)}
                    className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2 ${
                      selectedPerspective === perspective.id
                        ? 'text-white shadow-md'
                        : 'bg-white text-gray-600 border border-gray-200 hover:border-gray-300'
                    }`}
                    style={
                      selectedPerspective === perspective.id
                        ? { backgroundColor: perspective.color }
                        : {}
                    }
                  >
                    <span>{perspective.icon}</span>
                    <span>{perspective.label}</span>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                      selectedPerspective === perspective.id
                        ? 'bg-white bg-opacity-30'
                        : 'bg-gray-100'
                    }`}>
                      {count}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>
        </div>

        {/* Projects List */}
        {loading ? (
          <div className="flex items-center justify-center py-20">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          </div>
        ) : (
          <ProjectsListView projects={filteredProjects} />
        )}
      </div>
    </AppLayout>
  );
}
</file>

<file path="src/app/page.js">
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import AuthScreen from '@/components/Auth/AuthScreen';
import AppLayout from '@/components/AppLayout.js';
import HomeScreen from '@/components/HomeScreen';
import ProjectForm from '@/components/ProjectForm';
import * as unifiedDB from '@/db/unifiedDB';
import { getActiveInsights } from '@/db/unifiedDB';

export default function HomePage() {
  const { currentUser } = useAuth();
  const router = useRouter();
  
  const [projects, setProjects] = useState([]);
  const [todayHours, setTodayHours] = useState(0);
  const [topInsights, setTopInsights] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showProjectForm, setShowProjectForm] = useState(false);
  const [editingProject, setEditingProject] = useState(null);

  useEffect(() => {
  // Subscribe to real-time project updates
  const unsubscribe = unifiedDB.subscribeToProjects((updatedProjects) => {
    console.log('Projects updated in real-time:', updatedProjects.length);
    setProjects(updatedProjects);
    setLoading(false);
  });

  // Cleanup subscription on unmount
  return () => {
    if (unsubscribe) unsubscribe();
  };
  }, []);


  const loadData = async () => {
    // Add check to ensure user is initialized
    if (!currentUser) {
      console.log('âš ï¸ Skipping data load - no user yet');
      return;
    }
  
    console.log('ğŸ“¦ Loading home data for user:', currentUser.uid);
    
    try {
      const allProjects = await unifiedDB.getAllProjects();
      console.log('ğŸ“¦ Projects loaded:', allProjects.length);
      
      const visibleProjects = allProjects.filter(p => 
        p.status === 'active' || p.status === 'planning'
      );
      setProjects(visibleProjects);
      
      const todayLogs = await unifiedDB.getTodayTimeLogs();
      const totalToday = todayLogs.reduce((sum, log) => sum + log.duration, 0);
      setTodayHours(totalToday);
    
      try {
        const insights = await getActiveInsights();
        setTopInsights(insights.slice(0, 2));
      } catch (insightError) {
        console.error('Error loading insights:', insightError);
        setTopInsights([]);
      }
    
      setLoading(false);
    } catch (error) {
      console.error('Error loading data:', error);
      setLoading(false);
    }
  };

  // Wait for currentUser to be set before loading data
  useEffect(() => {
    if (currentUser) {
      console.log('âœ… User available, loading data');
      loadData();
    } else {
      console.log('â³ Waiting for user...');
      setLoading(true);
    }

    const handleTimeLogAdded = () => loadData();
    window.addEventListener('timeLogAdded', handleTimeLogAdded);
  
    return () => {
      window.removeEventListener('timeLogAdded', handleTimeLogAdded);
    };
  }, [currentUser]); // Add currentUser as dependency

  const handleProjectClick = (project) => {
    router.push(`/projects/${project.id}`);
  };

  const handleCloseForm = () => {
    setShowProjectForm(false);
    setEditingProject(null);
  };

  const handleProjectSaved = () => {
    loadData();
    handleCloseForm();
  };

  if (!currentUser) {
    return <AuthScreen />;
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="text-center">
          <div className="w-16 h-16 rounded-2xl mx-auto mb-4 overflow-hidden animate-pulse">
            <img src="/icons/icon-192x192.png" alt="RetireWise" className="w-full h-full" />
          </div>
          <p className="text-gray-600">Loading RetireWise...</p>
        </div>
      </div>
    );
  }

  return (
    <AppLayout showFAB={true}>
      <HomeScreen
        todayHours={todayHours}
        topInsights={topInsights}
        projects={projects}
        handleProjectClick={handleProjectClick}
        setShowProjectForm={setShowProjectForm}
      />

      {showProjectForm && (
        <ProjectForm
          project={editingProject}
          onClose={handleCloseForm}
          onSaved={handleProjectSaved}
        />
      )}
    </AppLayout>
  );
}
</file>

</files>
